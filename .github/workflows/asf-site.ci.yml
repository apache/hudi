name: asf-site CI

on:
  push:
    branches: [ asf-site ]
  pull_request:
    branches: [ asf-site ]

# Cancel in-progress runs when a new push is made to the same PR or branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  hudi-asf-site-ci:
    name: "Apache Hudi asf-site CI"
    runs-on: ubuntu-latest
    env:
      DOCS_ROOT: "./website"
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # For PR: need enough commits for diff (100 should cover most PRs)
          # For push: only need latest commit
          fetch-depth: ${{ github.event_name == 'pull_request' && 100 || 1 }}
          # Skip tags - this saves significant time
          fetch-tags: false
      - name: Check for files in content/
        if: github.event_name == 'pull_request'
        run: |
          echo "Changed files:"
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD)

          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q '^content/'; then
            echo "‚ùå PR should not change files under content/; change the files under website/ instead."
            exit 1
          else
            echo "‚úÖ No files under content/ directory."
          fi
      - name: Check docs markdown link format
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Checking docs markdown link format..."

          # Get the base branch
          git fetch origin ${{ github.base_ref }}

          # Get list of changed files in the PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD)

          # Filter for .md and .mdx files in website/docs/ and website/versioned_docs/
          DOCS_FILES=$(echo "$CHANGED_FILES" | grep -E '^website/(docs|versioned_docs)/.*\.(md|mdx)$' || true)

          if [ -z "$DOCS_FILES" ]; then
            echo "‚úÖ No markdown files changed in docs directories"
            exit 0
          fi

          echo "üìù Checking the following files:"
          echo "$DOCS_FILES"
          echo ""

          # Variables to track issues
          FOUND_ABSOLUTE_PATH_ISSUES=false
          FOUND_INVALID_RELATIVE_LINK_ISSUES=false
          ABSOLUTE_PATH_FILES=""
          INVALID_RELATIVE_LINK_FILES=""

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Check 1: Look for absolute /docs/ paths
              # Pattern: [text](/docs/...)
              if grep -Hn '\[.*\](\s*/docs/[^)]*)' "$file" > /dev/null 2>&1; then
                FOUND_ABSOLUTE_PATH_ISSUES=true
                ABSOLUTE_PATH_FILES="${ABSOLUTE_PATH_FILES}${file}\n"
                echo "‚ùå Found absolute /docs/ paths in: $file"
                echo "   Lines with issues:"
                grep -Hn '\[.*\](\s*/docs/[^)]*)' "$file" | while IFS= read -r line; do
                  echo "     $line"
                done
                echo ""
              fi

              # Check 2: Look for invalid relative doc links
              # - Missing .md extension: ](word#anchor) or ](word) where word starts with lowercase letter
              # - Using ../ or ./ prefixes: ](../ or ](./
              MISSING_MD=$(grep -En '\]\([a-z][a-z0-9_-]*(#|\))' "$file" 2>/dev/null | grep -v '\.md[#)]' || true)
              RELATIVE_PREFIX=$(grep -En '\]\(\.\.?/' "$file" 2>/dev/null || true)
              if [ -n "$MISSING_MD" ] || [ -n "$RELATIVE_PREFIX" ]; then
                FOUND_INVALID_RELATIVE_LINK_ISSUES=true
                INVALID_RELATIVE_LINK_FILES="${INVALID_RELATIVE_LINK_FILES}${file}\n"
                echo "‚ùå Found invalid relative doc links in: $file"
                echo "   Lines with issues:"
                { echo "$MISSING_MD"; echo "$RELATIVE_PREFIX"; } | grep -v '^$' | sort -t: -k1,1n -u | while IFS= read -r line; do
                  echo "     $line"
                done
                echo ""
              fi
            fi
          done <<< "$DOCS_FILES"

          # Report results
          HAS_ERRORS=false

          if [ "$FOUND_ABSOLUTE_PATH_ISSUES" = true ]; then
            HAS_ERRORS=true
            echo ""
            echo "========================================="
            echo "‚ùå ERROR: Found absolute /docs/ paths in markdown links!"
            echo "========================================="
            echo ""
            echo "üìã Files with absolute path issues:"
            echo -e "$ABSOLUTE_PATH_FILES"
            echo "üí° Use relative paths with .md extension instead."
            echo "   ‚ùå Bad:  [link text](/docs/guide/overview)"
            echo "   ‚úÖ Good: [link text](overview.md)"
            echo ""
          fi

          if [ "$FOUND_INVALID_RELATIVE_LINK_ISSUES" = true ]; then
            HAS_ERRORS=true
            echo ""
            echo "========================================="
            echo "‚ùå ERROR: Found invalid relative doc links!"
            echo "========================================="
            echo ""
            echo "üìã Files with invalid relative links:"
            echo -e "$INVALID_RELATIVE_LINK_FILES"
            echo "üí° Use just the filename with .md extension."
            echo "   ‚ùå Bad:  [link text](configurations#anchor)  (missing .md)"
            echo "   ‚ùå Bad:  [link text](../configurations.md)   (using ../)"
            echo "   ‚ùå Bad:  [link text](./configurations.md)    (using ./)"
            echo "   ‚úÖ Good: [link text](configurations.md#anchor)"
            echo ""
          fi

          if [ "$HAS_ERRORS" = true ]; then
            echo ""
            echo "The .md extension ensures Docusaurus resolves links at build time,"
            echo "making them work correctly with trailing slashes and versioned docs."
            echo "See README.md 'Linking docs' section for more details."
            exit 1
          else
            echo ""
            echo "‚úÖ All docs markdown links are properly formatted"
          fi
      - name: Prepare branch
        run: |
          git config --global user.name "CI BOT"
          git config --global user.email "cibot@hudi.apache.org"
          git checkout -b ci-build
          git remote add hudi https://${{ secrets.GITHUB_TOKEN }}@github.com/apache/hudi.git
          git pull --rebase hudi asf-site
      - uses: actions/setup-node@v6
        with:
          node-version: "22"
      - name: Build website
        run: |
          pushd ${{ env.DOCS_ROOT }}
          npm install
          npm run build
          popd
      - name: Publish website
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          echo "pushing build result ..."
          rm -rf content
          cp -R ${{ env.DOCS_ROOT }}/build content
          git add -A
          git commit -am "GitHub Actions build asf-site"
          git push hudi ci-build:asf-site
