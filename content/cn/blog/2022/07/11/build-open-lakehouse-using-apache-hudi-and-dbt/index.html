<!doctype html>
<html lang="cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/cn/blog/rss.xml" title="Apache Hudi: User-Facing Analytics RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cn/blog/atom.xml" title="Apache Hudi: User-Facing Analytics Atom Feed">
<link rel="alternate" type="application/json" href="/cn/blog/feed.json" title="Apache Hudi: User-Facing Analytics JSON Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Hudi" href="/cn/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa|Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css"><title data-react-helmet="true">Build Open Lakehouse using Apache Hudi &amp; dbt | Apache Hudi</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://hudi.apache.org/cn/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt"><meta data-react-helmet="true" name="docsearch:language" content="cn"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Build Open Lakehouse using Apache Hudi &amp; dbt | Apache Hudi"><meta data-react-helmet="true" name="description" content="The focus of this blog is to show you how to build an open lakehouse leveraging incremental data processing and performing field-level updates. We are excited to announce that you can now use Apache Hudi + dbt for building open data lakehouses."><meta data-react-helmet="true" property="og:description" content="The focus of this blog is to show you how to build an open lakehouse leveraging incremental data processing and performing field-level updates. We are excited to announce that you can now use Apache Hudi + dbt for building open data lakehouses."><meta data-react-helmet="true" property="og:image" content="https://hudi.apache.org/cn/assets/images/blog/hudi_dbt_lakehouse.png"><meta data-react-helmet="true" name="twitter:image" content="https://hudi.apache.org/cn/assets/images/blog/hudi_dbt_lakehouse.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-07-11T00:00:00.000Z"><link data-react-helmet="true" rel="icon" href="/cn/assets/images/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hudi.apache.org/cn/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/cn/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt" hreflang="cn"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/cn/assets/css/styles.975cb223.css">
<link rel="preload" href="/cn/assets/js/runtime~main.afe5902f.js" as="script">
<link rel="preload" href="/cn/assets/js/main.8c938f91.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">⭐️ If you like Apache Hudi, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/apache/hudi">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cn/"><div class="navbar__logo"><img src="/cn/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/cn/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/cn/docs/overview">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/talks">Talks</a></li><li><a class="dropdown__link" href="/cn/docs/faq">FAQ</a></li><li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Technical Wiki<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Contribute</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/contribute/how-to-contribute">How to Contribute</a></li><li><a class="dropdown__link" href="/cn/contribute/developer-setup">Developer Setup</a></li><li><a class="dropdown__link" href="/cn/contribute/rfc-process">RFC Process</a></li><li><a class="dropdown__link" href="/cn/contribute/report-security-issues">Report Security Issues</a></li><li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Report Issues<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/community/get-involved">Get Involved</a></li><li><a class="dropdown__link" href="/cn/community/syncs">Community Syncs</a></li><li><a class="dropdown__link" href="/cn/community/team">Team</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cn/blog">Blog</a><a class="navbar__item navbar__link" href="/cn/powered-by">Who&#x27;s Using</a><a class="navbar__item navbar__link" href="/cn/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/cn/releases/download">Download</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/cn/docs/overview">0.11.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/next/overview">Next</a></li><li><a class="dropdown__link" href="/cn/docs/overview">0.11.1</a></li><li><a class="dropdown__link" href="/cn/docs/0.11.0/overview">0.11.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.10.1/overview">0.10.1</a></li><li><a class="dropdown__link" href="/cn/docs/0.10.0/overview">0.10.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.9.0/overview">0.9.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.8.0/overview">0.8.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.7.0/overview">0.7.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.6.0/quick-start-guide">0.6.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.3/quick-start-guide">0.5.3</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.2/quick-start-guide">0.5.2</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.1/quick-start-guide">0.5.1</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.0/quick-start-guide">0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Chinese</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/cn/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">Chinese</a></li></ul></div><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link" aria-label="Hudi Twitter Handle"></a><a href="https://join.slack.com/t/apache-hudi/shared_invite/zt-1e94d3xro-JvlNO1kSeIHJBTVfLPlI5w" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link" aria-label="Hudi Slack Channel"></a><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-2" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_RC3s" itemprop="headline"><h1 itemprop="headline">Build Open Lakehouse using Apache Hudi &amp; dbt</h1></h1><div class="blogPostText_jBA8 row margin-top--sm margin-bottom--sm &#x27;margin-vert--md&#x27;"><time datetime="2022-07-11T00:00:00.000Z" itemprop="datePublished">July 11, 2022</time><div><div class="avatar margin-bottom--sm"><div><a itemprop="url"><span class="blogPostAuthorsList_dlEG" itemprop="name">Vinoth Govindarajan</span></a></div></div></div></div><div class="blogPostData_A2Le margin-vert--md">7 min read</div></header><div class="markdown" itemprop="articleBody"><p>The focus of this blog is to show you how to build an open lakehouse leveraging incremental data processing and performing field-level updates. We are excited to announce that you can now use Apache Hudi + dbt for building open data lakehouses.</p><p><img alt="/assets/images/blog/hudi_dbt_lakehouse.png" src="/cn/assets/images/hudi_dbt_lakehouse-1faadd1dd1a7e90797f2aab86bf0ae8b.png"></p><p>Let&#x27;s first clarify a few terminologies used in this blog before we dive into the details.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-apache-hudi">What is Apache Hudi?<a class="hash-link" href="#what-is-apache-hudi" title="Direct link to heading">​</a></h2><p>Apache Hudi brings ACID transactions, record-level updates/deletes, and change streams to data lakehouses.</p><p>Apache Hudi is an open-source data management framework used to simplify incremental data processing and data pipeline development. This framework more efficiently manages business requirements like data lifecycle and improves data quality.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-dbt">What is dbt?<a class="hash-link" href="#what-is-dbt" title="Direct link to heading">​</a></h2><p>dbt (data build tool) is a data transformation tool that enables data analysts and engineers to transform, test, and document data in the cloud data warehouses.</p><p>dbt enables analytics engineers to transform data in their warehouses by simply writing select statements. dbt handles turning these select statements into tables and views.</p><p>dbt does the T in ELT (Extract, Load, Transform) processes – it doesn’t extract or load data, but it’s extremely good at transforming data that’s already loaded into your warehouse.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-a-lakehouse">What is a Lakehouse?<a class="hash-link" href="#what-is-a-lakehouse" title="Direct link to heading">​</a></h2><p>A lakehouse is a new, open architecture that combines the best elements of data lakes and data warehouses. Lakehouses are enabled by a new system design: implementing transaction management and data management features similar to those in a data warehouse directly on top of low-cost cloud storage in open formats. They are what you would get if you had to redesign data warehouses in the modern world, now that cheap and highly reliable storage (in the form of object stores) are available.</p><p>In other words, while data lakes historically have been viewed as a bunch of files added to cloud storage folders, lakehouse tables support transactions, updates, deletes, and in the case of Apache Hudi, even database-like functionality like indexing or change capture.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-build-an-open-lakehouse">How to build an open lakehouse?<a class="hash-link" href="#how-to-build-an-open-lakehouse" title="Direct link to heading">​</a></h2><p>Now, we know what is a lakehouse, so let&#x27;s build one, In order to build an open lakehouse, you need a few components:</p><ul><li>Open table format which supports ACID transactions<ul><li>Apache Hudi (integrated with dbt)</li><li>Delta Lake (proprietary features locked to Databricks runtime)</li><li>Apache Iceberg (currently not integrated with dbt)</li></ul></li><li>Data transformation tool<ul><li>Open source dbt is the de-facto popular choice for transformation layer</li></ul></li><li>Distributed data processing engine<ul><li>Apache Spark is the de-facto popular choice for compute engine</li></ul></li><li>Cloud Storage<ul><li>You can choose any of the cost-effective cloud stores or HDFS</li></ul></li><li>Bring your favorite query engine</li></ul><p>To build the lakehouse you need a way to extract and load the data into Hudi table format and then transform in-place using dbt.</p><p>DBT supports Hudi out of the box with the <a href="https://github.com/dbt-labs/dbt-spark" target="_blank" rel="noopener noreferrer">dbt-spark</a> adapter package. When creating modeled datasets using dbt you can choose Hudi as the format for your tables.</p><p>You can follow the instructions on this <a href="https://github.com/apache/hudi/blob/master/hudi-examples/hudi-examples-dbt/README.md" target="_blank" rel="noopener noreferrer">page</a> to learn how to install and configure dbt+hudi.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="step-1-how-to-extract--load-the-raw-data-datasets">Step 1: How to extract &amp; load the raw data datasets?<a class="hash-link" href="#step-1-how-to-extract--load-the-raw-data-datasets" title="Direct link to heading">​</a></h2><p>This is the first step in building your data lake and there are many choices here to load the data into our open lakehouse. I’m going to go with one of the Hudi’s native tools called Delta Streamer since all the ingestion features are pre-built and battle-tested in production at scale.</p><p>Hudi’s <a href="https://hudi.apache.org/docs/hoodie_deltastreamer" target="_blank" rel="noopener noreferrer">DeltaStreamer</a> does the EL in ELT (Extract, Load, Transform) processes – it’s extremely good at extracting, loading, and optionally <a href="https://hudi.apache.org/docs/transforms" target="_blank" rel="noopener noreferrer">transforming data</a> that’s already loaded into your lakehouse.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="step-2-how-to-configure-hudi-with-the-dbt-project">Step 2: How to configure hudi with the dbt project?<a class="hash-link" href="#step-2-how-to-configure-hudi-with-the-dbt-project" title="Direct link to heading">​</a></h2><p>To use the Hudi with your dbt project,  all you need to do is choose the file format as Hudi. The file format config can either be specified in specific models, or for all the models in your dbt_project.yml file:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_oQzk">dbt_project.yml</div><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">models</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token key atrule">+file_format</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hudi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>or:</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_oQzk">model/my_model.sql</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{{ config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   materialized </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;incremental&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   incremental_strategy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;merge&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   file_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hudi&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   unique_key </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   …</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> }}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After choosing hudi as the file_format you can create materialized datasets using dbt, which offers additional benefits that are unique to the Hudi table format such as field-level upserts/deletes.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="step-3-how-to-read-the-raw-data-incrementally">Step 3: How to read the raw data incrementally?<a class="hash-link" href="#step-3-how-to-read-the-raw-data-incrementally" title="Direct link to heading">​</a></h2><p>Before we learn how to build incremental materialization, let’s quickly learn, What are materializations in dbt? Materializations are strategies for persisting dbt models in a lakehouse. There are four types of materializations built into dbt. They are:</p><ul><li>table</li><li>view</li><li>incremental</li><li>ephemeral</li></ul><p>Among all the materialization types, only incremental models allow dbt to insert or update records into a table since the last time that dbt was run, which unlocks the powers of Hudi, we will dive into the details.</p><p>To use incremental models, you need to perform these two activities:</p><ol><li>Tell dbt how to filter the rows on the incremental executions</li><li>Define the uniqueness constraint of the model (required when using &gt;= Hudi 0.10.1 version)</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-apply-filters-on-an-incremental-run">How to apply filters on an incremental run?<a class="hash-link" href="#how-to-apply-filters-on-an-incremental-run" title="Direct link to heading">​</a></h3><p>dbt provides you a macro <code>is_incremental()</code> which is very useful to define the filters exclusively for incremental materializations.</p><p>Often, you&#x27;ll want to filter for &quot;new&quot; rows, as in, rows that have been created since the last time dbt ran this model. The best way to find the timestamp of the most recent run of this model is by checking the most recent timestamp in your target table. dbt makes it easy to query your target table by using the &quot;<a href="https://docs.getdbt.com/reference/dbt-jinja-functions/this" target="_blank" rel="noopener noreferrer">{{ this }}</a>&quot; variable.</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_oQzk">models/my_model.sql</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       materialized</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;incremental&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       file_format</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hudi&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> raw_app_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><span class="token operator">%</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> is_incremental</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">-- this filter will only be applied on an incremental run</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">where</span><span class="token plain"> event_time </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">event_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> {{ this }}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><span class="token operator">%</span><span class="token plain"> endif </span><span class="token operator">%</span><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-define-the-uniqueness-constraint">How to define the uniqueness constraint?<a class="hash-link" href="#how-to-define-the-uniqueness-constraint" title="Direct link to heading">​</a></h3><p>A unique_key is the primary key of the dataset, which determines whether a record has new values and should be updated/deleted, or inserted.</p><p>You can define the unique_key in the configuration block at the top of your model. This unique_key will act as the primaryKey (hoodie.datasource.write.recordkey.field) on the hudi table.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="step-4-how-to-use-the-upsert-feature-while-writing-datasets">Step 4: How to use the upsert feature while writing datasets?<a class="hash-link" href="#step-4-how-to-use-the-upsert-feature-while-writing-datasets" title="Direct link to heading">​</a></h2><p>dbt offers multiple load strategies when loading the transformed datasets, such as:</p><ul><li>append (default)</li><li>insert_overwrite (optional)</li><li>merge (optional, Only available for Hudi and Delta formats)</li></ul><p>By default dbt uses the append strategy, which may cause duplicate rows when you execute dbt run command multiple times on the same payload.</p><p>When you choose the insert_overwrite strategy, dbt will overwrite the entire partition or full table load for every dbt run, which causes unnecessary overheads and is very expensive.</p><p>In addition to all the existing strategies to load the data, with hudi you can use the exclusive merge strategy when using incremental materialization. Using the merge strategy you can perform field-level updates/deletes on your data lakehouse which is performant and cost-efficient. As a result, you will get access to fresher data and accelerated insights.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-perform-field-level-updates">How to perform field-level updates?<a class="hash-link" href="#how-to-perform-field-level-updates" title="Direct link to heading">​</a></h3><p>If you are using the merge strategy and have specified a unique_key, by default, dbt will entirely overwrite matched rows with new values.</p><p>Since Apache Spark adapter supports the merge strategy, you may optionally pass a list of column names to a <code>merge_update_columns</code> config. In that case, dbt will update only the columns specified by the config, and keep the previous values of other columns.</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_oQzk">models/my_model.sql</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{{ config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   materialized </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;incremental&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   incremental_strategy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;merge&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   file_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hudi&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   unique_key </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   merge_update_columns </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;msg&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;updated_ts&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> }}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="how-to-configure-additional-hoodie-custom-configs">How to configure additional hoodie custom configs?<a class="hash-link" href="#how-to-configure-additional-hoodie-custom-configs" title="Direct link to heading">​</a></h3><p>When you want to specify additional hudi configs, you can do that with the options config:</p><div class="codeBlockContainer_J+bg language-sql theme-code-block"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_oQzk">models/my_model.sql</div><div class="codeBlockContent_csEI sql"><pre tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{{ config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   materialized</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;incremental&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   file_format</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;hudi&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   incremental_strategy</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;merge&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   options</span><span class="token operator">=</span><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;type&#x27;</span><span class="token plain">: </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mor&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;primaryKey&#x27;</span><span class="token plain">: </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;precombineKey&#x27;</span><span class="token plain">: </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;ts&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   }</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   unique_key</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;id&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   partition_by</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;datestr&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   pre_hook</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;set spark.sql.datetime.java8API.enabled=false;&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Hope you understood the benefits of using Apache Hudi with dbt to build your next open lakehouse, good luck!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cn/blog/2022/06/29/Apache-Hudi-vs-Delta-Lake-transparent-tpc-ds-lakehouse-performance-benchmarks"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Apache Hudi vs Delta Lake - Transparent TPC-DS Lakehouse Performance Benchmarks<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-apache-hudi" class="table-of-contents__link toc-highlight">What is Apache Hudi?</a></li><li><a href="#what-is-dbt" class="table-of-contents__link toc-highlight">What is dbt?</a></li><li><a href="#what-is-a-lakehouse" class="table-of-contents__link toc-highlight">What is a Lakehouse?</a></li><li><a href="#how-to-build-an-open-lakehouse" class="table-of-contents__link toc-highlight">How to build an open lakehouse?</a></li><li><a href="#step-1-how-to-extract--load-the-raw-data-datasets" class="table-of-contents__link toc-highlight">Step 1: How to extract &amp; load the raw data datasets?</a></li><li><a href="#step-2-how-to-configure-hudi-with-the-dbt-project" class="table-of-contents__link toc-highlight">Step 2: How to configure hudi with the dbt project?</a></li><li><a href="#step-3-how-to-read-the-raw-data-incrementally" class="table-of-contents__link toc-highlight">Step 3: How to read the raw data incrementally?</a><ul><li><a href="#how-to-apply-filters-on-an-incremental-run" class="table-of-contents__link toc-highlight">How to apply filters on an incremental run?</a></li><li><a href="#how-to-define-the-uniqueness-constraint" class="table-of-contents__link toc-highlight">How to define the uniqueness constraint?</a></li></ul></li><li><a href="#step-4-how-to-use-the-upsert-feature-while-writing-datasets" class="table-of-contents__link toc-highlight">Step 4: How to use the upsert feature while writing datasets?</a><ul><li><a href="#how-to-perform-field-level-updates" class="table-of-contents__link toc-highlight">How to perform field-level updates?</a></li><li><a href="#how-to-configure-additional-hoodie-custom-configs" class="table-of-contents__link toc-highlight">How to configure additional hoodie custom configs?</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/blog/2021/07/21/streaming-data-lake-platform">Our Vision</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/concepts">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/community/team">Team</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/releases/release-0.11.1">Releases</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/releases/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/powered-by">Who&#x27;s Using</a></li></ul></div><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/docs/quick-start-guide">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/docker_demo">Docker Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/talks">Talks</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/faq">FAQ</a></li><li class="footer__item"><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Technical Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Hudi On Cloud</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/docs/s3_hoodie">AWS</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/gcs_hoodie">Google Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/oss_hoodie">Alibaba Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/azure_hoodie">Microsoft Azure</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/cos_hoodie">Tencent Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/ibm_cos_hoodie">IBM Cloud</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/contribute/get-involved">Get Involved</a></li><li class="footer__item"><a href="https://join.slack.com/t/apache-hudi/shared_invite/zt-1e94d3xro-JvlNO1kSeIHJBTVfLPlI5w" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:dev-subscribe@hudi.apache.org?Subject=SubscribeToHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li></ul></div><div class="col footer__col"><div class="footer__title">Apache</div><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li><li class="footer__item"><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://hudi.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/cn/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/cn/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright © 2021 <a href="https://apache.org">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0"> Apache License, Version 2.0</a>.
      Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation. <a href="/docs/privacy">Privacy Policy</a></div></div></div></footer></div>
<script src="/cn/assets/js/runtime~main.afe5902f.js"></script>
<script src="/cn/assets/js/main.8c938f91.js"></script>
</body>
</html>