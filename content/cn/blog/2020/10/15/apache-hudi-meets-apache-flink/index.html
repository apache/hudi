<!doctype html>
<html lang="cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/cn/blog/rss.xml" title="Apache Hudi: User-Facing Analytics RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cn/blog/atom.xml" title="Apache Hudi: User-Facing Analytics Atom Feed">
<link rel="alternate" type="application/json" href="/cn/blog/feed.json" title="Apache Hudi: User-Facing Analytics JSON Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Hudi" href="/cn/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa|Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css"><title data-react-helmet="true">Apache Hudi meets Apache Flink | Apache Hudi</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://hudi.apache.org/cn/blog/2020/10/15/apache-hudi-meets-apache-flink"><meta data-react-helmet="true" name="docsearch:language" content="cn"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Apache Hudi meets Apache Flink | Apache Hudi"><meta data-react-helmet="true" name="description" content="Apache Hudi (Hudi for short) is a data lake framework created at Uber. Hudi joined the Apache incubator for incubation in January 2019, and was promoted to the top Apache project in May 2020. It is one of the most popular data lake frameworks."><meta data-react-helmet="true" property="og:description" content="Apache Hudi (Hudi for short) is a data lake framework created at Uber. Hudi joined the Apache incubator for incubation in January 2019, and was promoted to the top Apache project in May 2020. It is one of the most popular data lake frameworks."><meta data-react-helmet="true" property="og:image" content="https://hudi.apache.org/cn/assets/images/blog/2020-10-15-apache-hudi-meets-apache-flink.png"><meta data-react-helmet="true" name="twitter:image" content="https://hudi.apache.org/cn/assets/images/blog/2020-10-15-apache-hudi-meets-apache-flink.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-10-15T00:00:00.000Z"><link data-react-helmet="true" rel="icon" href="/cn/assets/images/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hudi.apache.org/cn/blog/2020/10/15/apache-hudi-meets-apache-flink"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2020/10/15/apache-hudi-meets-apache-flink" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/cn/blog/2020/10/15/apache-hudi-meets-apache-flink" hreflang="cn"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2020/10/15/apache-hudi-meets-apache-flink" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/cn/assets/css/styles.1b724f87.css">
<link rel="preload" href="/cn/assets/js/runtime~main.b012fd54.js" as="script">
<link rel="preload" href="/cn/assets/js/main.10d9d53d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">⭐️ If you like Apache Hudi, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/apache/hudi">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cn/"><div class="navbar__logo"><img src="/cn/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/cn/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/cn/docs/overview">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/talks">Talks</a></li><li><a class="dropdown__link" href="/cn/learn/faq">FAQ</a></li><li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Technical Wiki<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Contribute</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/contribute/how-to-contribute">How to Contribute</a></li><li><a class="dropdown__link" href="/cn/contribute/developer-setup">Developer Setup</a></li><li><a class="dropdown__link" href="/cn/contribute/rfc-process">RFC Process</a></li><li><a class="dropdown__link" href="/cn/contribute/report-security-issues">Report Security Issues</a></li><li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Report Issues<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/community/get-involved">Get Involved</a></li><li><a class="dropdown__link" href="/cn/community/syncs">Community Syncs</a></li><li><a class="dropdown__link" href="/cn/community/team">Team</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cn/blog">Blog</a><a class="navbar__item navbar__link" href="/cn/powered-by">Who&#x27;s Using</a><a class="navbar__item navbar__link" href="/cn/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/cn/releases/download">Download</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/cn/docs/overview">0.11.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/next/overview">Next</a></li><li><a class="dropdown__link" href="/cn/docs/overview">0.11.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.10.1/overview">0.10.1</a></li><li><a class="dropdown__link" href="/cn/docs/0.10.0/overview">0.10.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.9.0/overview">0.9.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.8.0/overview">0.8.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.7.0/overview">0.7.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.6.0/quick-start-guide">0.6.0</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.3/quick-start-guide">0.5.3</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.2/quick-start-guide">0.5.2</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.1/quick-start-guide">0.5.1</a></li><li><a class="dropdown__link" href="/cn/docs/0.5.0/quick-start-guide">0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Chinese</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2020/10/15/apache-hudi-meets-apache-flink" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/cn/blog/2020/10/15/apache-hudi-meets-apache-flink" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">Chinese</a></li></ul></div><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link" aria-label="Hudi Twitter Handle"></a><a href="https://join.slack.com/t/apache-hudi/shared_invite/enQtODYyNDAxNzc5MTg2LTE5OTBlYmVhYjM0N2ZhOTJjOWM4YzBmMWU2MjZjMGE4NDc5ZDFiOGQ2N2VkYTVkNzU3ZDQ4OTI1NmFmYWQ0NzE" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link" aria-label="Hudi Slack Channel"></a><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-2" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_RC3s" itemprop="headline"><h1 itemprop="headline">Apache Hudi meets Apache Flink</h1></h1><div class="authorTimeTags_oN88 row margin-top--sm margin-bottom--sm &#x27;margin-vert--md&#x27;"><time datetime="2020-10-15T00:00:00.000Z" itemprop="datePublished">October 15, 2020</time><div><div class="avatar margin-bottom--sm"><div><a itemprop="url"><span class="authorsList_svFt" itemprop="name">wangxianghu</span></a></div></div></div></div><div class="blogPostData_A2Le margin-vert--md">10 min read</div></header><div class="markdown" itemprop="articleBody"><p>Apache Hudi (Hudi for short) is a data lake framework created at Uber. Hudi joined the Apache incubator for incubation in January 2019, and was promoted to the top Apache project in May 2020. It is one of the most popular data lake frameworks.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="1-why-decouple">1. Why decouple<a class="hash-link" href="#1-why-decouple" title="Direct link to heading">​</a></h2><p>Hudi has been using Spark as its data processing engine since its birth. If users want to use Hudi as their data lake framework, they must introduce Spark into their platform technology stack.
A few years ago, using Spark as a big data processing engine can be said to be very common or even natural. Since Spark can either perform batch processing or use micro-batch to simulate streaming, one engine solves both streaming and batch problems.
However, in recent years, with the development of big data technology, Flink, which is also a big data processing engine, has gradually entered people&#x27;s vision and has occupied a certain market in the field of computing engines.
In the big data technology community, forums and other territories, the voice of whether Hudi supports Flink has gradually appeared and has become more frequent. Therefore, it is a valuable thing to make Hudi support the Flink engine, and the first step of integrating the Flink engine is that Hudi and Spark are decoupled.</p><p>In addition, looking at the mature, active, and viable frameworks in the big data, all frameworks are elegant in design and can be integrated with other frameworks and leverage each other&#x27;s expertise.
Therefore, decoupling Hudi from Spark and turning it into an engine-independent data lake framework will undoubtedly create more possibilities for the integration of Hudi and other components, allowing Hudi to better integrate into the big data ecosystem.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="2-challenges">2. Challenges<a class="hash-link" href="#2-challenges" title="Direct link to heading">​</a></h2><p>Hudi&#x27;s internal use of Spark API is as common as our usual development and use of List. Since the data source reads the data, and finally writes the data to the table, Spark RDD is used as the main data structure everywhere, and even ordinary tools are implemented using the Spark API.
It can be said that Hudi is a universal data lake framework implemented by Spark. Hudi also leverages deep Spark functionality like custom partitioning, in-memory caching to implement indexing and file sizing using workload heuristics.
For some of these, Flink offers better out-of-box support (e.g using Flink’s state store for indexing) and can in fact, make Hudi approach real-time latencies more and more. </p><p>In addition, the primary engine integrated after this decoupling is Flink. Flink and Spark differ greatly in core abstraction. Spark believes that data is bounded, and its core abstraction is a limited set of data.
Flink believes that the essence of data is a stream, and its core abstract DataStream contains various operations on data. Hudi has a streaming first design (record level updates, record level streams), that arguably fit the Flink model more naturally.
At the same time, there are multiple RDDs operating at the same time in Hudi, and the processing result of one RDD is combined with another RDD.
This difference in abstraction and the reuse of intermediate results during implementation make it difficult for Hudi to use a unified API to operate both RDD and DataStream in terms of decoupling abstraction.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="3-decoupling-spark">3. Decoupling Spark<a class="hash-link" href="#3-decoupling-spark" title="Direct link to heading">​</a></h2><p>In theory, Hudi uses Spark as its computing engine to use Spark&#x27;s distributed computing power and RDD&#x27;s rich operator capabilities. Apart from distributed computing power, Hudi uses RDD more as a data structure, and RDD is essentially a bounded data set.
Therefore, it is theoretically feasible to replace RDD with List (of course, it may sacrifice performance/scale). In order to ensure the performance and stability of the Hudi Spark version as much as possible. We can keep setting the bounded data set as the basic operation unit.
Hudi&#x27;s main operation API remains unchanged, and RDD is extracted as a generic type. The Spark engine implementation still uses RDD, and other engines use List or other bounded  data set according to the actual situation.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="decoupling-principle">Decoupling principle<a class="hash-link" href="#decoupling-principle" title="Direct link to heading">​</a></h3><p>1) Unified generics. The input records <code>JavaRDD&lt;HoodieRecord&gt;</code>, key of input records <code>JavaRDD&lt;HoodieKey&gt;</code>, and result of write operations <code>JavaRDD&lt;WriteStatus&gt;</code> used by the Spark API use generic <code>I,K,O</code> instead;</p><p>2) De-sparkization. All APIs of the abstraction layer must have nothing to do with Spark. Involving specific operations that are difficult to implement in the abstract layer, rewrite them as abstract methods and introduce Spark subclasses.</p><p>For example: Hudi uses the <code>JavaSparkContext#map()</code> method in many places. To de-spark, you need to hide the <code>JavaSparkContext</code>. For this problem, we introduced the <code>HoodieEngineContext#map()</code> method, which will block the specific implementation details of <code>map</code>, so as to achieve de-sparkization in abstraction.</p><p>3) Minimize changes to the abstraction layer to ensure the original function and performance of Hudi;</p><p>4) Replace the <code>JavaSparkContext</code> with the <code>HoodieEngineContext</code> abstract class to provide the running environment context.</p><p>In addition, some of the core algorithms in Hudi, like <a href="https://github.com/apache/hudi/pull/1756" target="_blank" rel="noopener noreferrer">rollback</a>, has been redone without the need for computing a workload profile ahead of time, which used to rely on Spark caching. </p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="4-flink-integration-design">4. Flink integration design<a class="hash-link" href="#4-flink-integration-design" title="Direct link to heading">​</a></h2><p>Hudi&#x27;s write operation is batch processing in nature, and the continuous mode of <code>DeltaStreamer</code> is realized by looping batch processing. In order to use a unified API, when Hudi integrates Flink, we choose to collect a batch of data before processing, and finally submit it in a unified manner (here we use List to collect data in Flink).
In Hudi terminology, we will stream data for a given commit, but only publish the commits every so often, making it practical to scale storage on cloud storage and also tunable.</p><p>The easiest way to think of batch operation is to use a time window. However, when using a window, when there is no data flowing in a window, there will be no output data, and it is difficult for the Flink sink to judge whether all the data from a given batch has been processed.
Therefore, we use Flink&#x27;s checkpoint mechanism to collect batches. The data between every two barriers is a batch. When there is no data in a subtask, the mock result data is made up.
In this way, on the sink side, when each subtask has result data issued, it can be considered that a batch of data has been processed and the commit can be executed.</p><p>The DAG is as follows:</p><p><img alt="dualism" src="/cn/assets/images/image1-ad0429306e0ebe38c0eacbf4b2aed222.png"></p><ul><li><strong>Source:</strong> receives Kafka data and converts it into <code>List&lt;HoodieRecord&gt;</code>;</li><li><strong>InstantGeneratorOperator:</strong> generates a globally unique instant. When the previous instant is not completed or the current batch has no data, no new instant is created;</li><li><strong>KeyBy partitionPath:</strong> partitions according to <code>partitionPath</code> to avoid multiple subtasks from writing the same partition;</li><li><strong>WriteProcessOperator:</strong> performs a write operation. When there is no data in the current partition, it sends empty result data to the downstream to make up the number;</li><li><strong>CommitSink:</strong> receives the calculation results of the upstream task. When receiving the parallelism results, it is considered that all the upstream subtasks are completed and the commit is executed.</li></ul><p>Note:
<code>InstantGeneratorOperator</code> and <code>WriteProcessOperator</code> are both custom Flink operators. <code>InstantGeneratorOperator</code> will block checking the state of the previous instant to ensure that there is only one instant in the global (or requested) state.
<code>WriteProcessOperator</code> is the actual execution Where a write operation is performed, the write operation is triggered at checkpoint.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="41-index-design-based-on-flink-state">4.1 Index design based on Flink State<a class="hash-link" href="#41-index-design-based-on-flink-state" title="Direct link to heading">​</a></h3><p>Stateful computing is one of the highlights of the Flink engine. Compared with using external storage, using Flink&#x27;s built-in <code>State</code> can significantly improve the performance of Flink applications.
Therefore, it would be a good choice to implement a Hudi index based on Flink&#x27;s State.</p><p>The core of the Hudi index is to maintain the mapping of the Hudi key <code>HoodieKey</code> and the location of the Hudi data <code>HoodieRecordLocation</code>.
Therefore, based on the current design, we can simply maintain a <code>MapState&lt;HoodieKey, HoodieRecordLocation&gt;</code> in Flink UDF to map the <code>HoodieKey</code> and <code>HoodieRecordLocation</code>, and leave the fault tolerance and persistence of State to the Flink framework.</p><p><img alt="dualism" src="/cn/assets/images/image2-73e008bce9561bc07e7586c36a0cb745.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="5-implementation-examples">5. Implementation examples<a class="hash-link" href="#5-implementation-examples" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="1-hoodietable">1) HoodieTable<a class="hash-link" href="#1-hoodietable" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  * Abstract implementation of a HoodieTable.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  *</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  * @param &lt;T&gt; Sub type of HoodieRecordPayload</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  * @param &lt;I&gt; Type of inputs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  * @param &lt;K&gt; Type of keys</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  * @param &lt;O&gt; Type of outputs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public abstract class HoodieTable&lt;T extends HoodieRecordPayload, I, K, O&gt; implements Serializable {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   protected final HoodieWriteConfig config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   protected final HoodieTableMetaClient metaClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   protected final HoodieIndex&lt;T, I, K, O&gt; index;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   public abstract HoodieWriteMetadata&lt;O&gt; upsert(HoodieEngineContext context, String instantTime,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       I records);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   public abstract HoodieWriteMetadata&lt;O&gt; insert(HoodieEngineContext context, String instantTime,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       I records);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   public abstract HoodieWriteMetadata&lt;O&gt; bulkInsert(HoodieEngineContext context, String instantTime,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       I records, Option&lt;BulkInsertPartitioner&lt;I&gt;&gt; bulkInsertPartitioner);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HoodieTable</code> is one of the core abstractions of Hudi, which defines operations such as <code>insert</code>, <code>upsert</code>, and <code>bulkInsert</code> supported by the table.
Take <code>upsert</code> as an example, the input data is changed from the original <code>JavaRDD&lt;HoodieRecord&gt; inputRdds</code> to <code>I records</code>, and the runtime <code>JavaSparkContext jsc</code> is changed to <code>HoodieEngineContext context</code>.</p><p>From the class annotations, we can see that <code>T, I, K, O</code> represents the load data type, input data type, primary key type and output data type of Hudi operation respectively.
These generics will run through the entire abstraction layer.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="2-hoodieenginecontext">2) HoodieEngineContext<a class="hash-link" href="#2-hoodieenginecontext" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * Base class contains the context information needed by the engine at runtime. It will be extended by different</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> * engine implementation if needed.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public abstract class HoodieEngineContext {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public abstract &lt;I, O&gt; List&lt;O&gt; map(List&lt;I&gt; data, SerializableFunction&lt;I, O&gt; func, int parallelism);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public abstract &lt;I, O&gt; List&lt;O&gt; flatMap(List&lt;I&gt; data, SerializableFunction&lt;I, Stream&lt;O&gt;&gt; func, int parallelism);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public abstract &lt;I&gt; void foreach(List&lt;I&gt; data, SerializableConsumer&lt;I&gt; consumer, int parallelism);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ......</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HoodieEngineContext</code> plays the role of <code>JavaSparkContext</code>, it not only provides all the information that <code>JavaSparkContext</code> can provide,
but also encapsulates many methods such as <code>map</code>, <code>flatMap</code>, <code>foreach</code>, and hides The specific implementation of <code>JavaSparkContext#map()</code>,<code>JavaSparkContext#flatMap()</code>, <code>JavaSparkContext#foreach()</code> and other methods.</p><p>Take the <code>map</code> method as an example. In the Spark implementation class <code>HoodieSparkEngineContext</code>, the <code>map</code> method is as follows:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public &lt;I, O&gt; List&lt;O&gt; map(List&lt;I&gt; data, SerializableFunction&lt;I, O&gt; func, int parallelism) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return javaSparkContext.parallelize(data, parallelism).map(func::apply).collect();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the engine that operates List, the implementation can be as follows (different methods need to pay attention to thread-safety issues, use <code>parallel()</code> with caution):</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  public &lt;I, O&gt; List&lt;O&gt; map(List&lt;I&gt; data, SerializableFunction&lt;I, O&gt; func, int parallelism) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return data.stream().parallel().map(func::apply).collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Note:
The exception thrown in the map function can be solved by wrapping <code>SerializableFunction&lt;I, O&gt; func</code>.</p><p>Here is a brief introduction to <code>SerializableFunction</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@FunctionalInterface</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public interface SerializableFunction&lt;I, O&gt; extends Serializable {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  O apply(I v1) throws Exception;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This method is actually a variant of <code>java.util.function.Function</code>. The difference from <code>java.util.function.Function</code> is that <code>SerializableFunction</code> can be serialized and can throw exceptions.
This function is introduced because the input parameters that the <code>JavaSparkContext#map()</code> function can receive must be serializable.
At the same time, there are many exceptions that need to be thrown in the logic of Hudi, and the code for <code>try-catch</code> in the Lambda expression will be omitted It is bloated and not very elegant.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="6-current-progress-and-follow-up-plan">6. Current progress and follow-up plan<a class="hash-link" href="#6-current-progress-and-follow-up-plan" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="61-working-time-axis">6.1 Working time axis<a class="hash-link" href="#61-working-time-axis" title="Direct link to heading">​</a></h3><p><img alt="dualism" src="/cn/assets/images/image3-570b43b2c0cec6865c17b50ddef9a3f4.png"></p><p><a href="https://www.t3go.cn/" target="_blank" rel="noopener noreferrer">T3go</a>
<a href="https://cn.aliyun.com/" target="_blank" rel="noopener noreferrer">Aliyun</a>
<a href="https://www.sf-express.com/cn/sc/" target="_blank" rel="noopener noreferrer">SF-express</a></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="62-follow-up-plan">6.2 Follow-up plan<a class="hash-link" href="#62-follow-up-plan" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="1-promote-the-integration-of-hudi-and-flink">1) Promote the integration of Hudi and Flink<a class="hash-link" href="#1-promote-the-integration-of-hudi-and-flink" title="Direct link to heading">​</a></h4><p>Push the integration of Flink and Hudi to the community as soon as possible. In the initial stage, this feature may only support Kafka data sources.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="2-performance-optimization">2) Performance optimization<a class="hash-link" href="#2-performance-optimization" title="Direct link to heading">​</a></h4><p>In order to ensure the stability and performance of the Hudi-Spark version, the decoupling did not take too much into consideration the possible performance problems of the Flink version.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="3-flink-connector-hudi-like-third-party-package-development">3) flink-connector-hudi like third-party package development<a class="hash-link" href="#3-flink-connector-hudi-like-third-party-package-development" title="Direct link to heading">​</a></h4><p>Make the binding of Hudi-Flink into a third-party package. Users can this third-party package to read/write from/to Hudi with Flink.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cn/blog/2020/10/19/Origins-of-Data-Lake-at-Grofers"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->Origins of Data Lake at Grofers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cn/blog/2020/10/06/cdc-solution-using-hudi-by-nclouds"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How nClouds Helps Accelerate Data Delivery with Apache Hudi on Amazon EMR<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-why-decouple" class="table-of-contents__link toc-highlight">1. Why decouple</a></li><li><a href="#2-challenges" class="table-of-contents__link toc-highlight">2. Challenges</a></li><li><a href="#3-decoupling-spark" class="table-of-contents__link toc-highlight">3. Decoupling Spark</a><ul><li><a href="#decoupling-principle" class="table-of-contents__link toc-highlight">Decoupling principle</a></li></ul></li><li><a href="#4-flink-integration-design" class="table-of-contents__link toc-highlight">4. Flink integration design</a><ul><li><a href="#41-index-design-based-on-flink-state" class="table-of-contents__link toc-highlight">4.1 Index design based on Flink State</a></li></ul></li><li><a href="#5-implementation-examples" class="table-of-contents__link toc-highlight">5. Implementation examples</a><ul><li><a href="#1-hoodietable" class="table-of-contents__link toc-highlight">1) HoodieTable</a></li><li><a href="#2-hoodieenginecontext" class="table-of-contents__link toc-highlight">2) HoodieEngineContext</a></li></ul></li><li><a href="#6-current-progress-and-follow-up-plan" class="table-of-contents__link toc-highlight">6. Current progress and follow-up plan</a><ul><li><a href="#61-working-time-axis" class="table-of-contents__link toc-highlight">6.1 Working time axis</a></li><li><a href="#62-follow-up-plan" class="table-of-contents__link toc-highlight">6.2 Follow-up plan</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/blog/2021/07/21/streaming-data-lake-platform">Our Vision</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/concepts">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/community/team">Team</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/releases/release-0.11.0">Releases</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/releases/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/powered-by">Who&#x27;s Using</a></li></ul></div><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/docs/quick-start-guide">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/docker_demo">Docker Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/talks">Talks</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/learn/faq">FAQ</a></li><li class="footer__item"><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Technical Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Hudi On Cloud</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/docs/s3_hoodie">AWS</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/gcs_hoodie">Google Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/oss_hoodie">Alibaba Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/azure_hoodie">Microsoft Azure</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/cos_hoodie">Tencent Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/cn/docs/ibm_cos_hoodie">IBM Cloud</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cn/contribute/get-involved">Get Involved</a></li><li class="footer__item"><a href="https://join.slack.com/t/apache-hudi/shared_invite/enQtODYyNDAxNzc5MTg2LTE5OTBlYmVhYjM0N2ZhOTJjOWM4YzBmMWU2MjZjMGE4NDc5ZDFiOGQ2N2VkYTVkNzU3ZDQ4OTI1NmFmYWQ0NzE" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:dev-subscribe@hudi.apache.org?Subject=SubscribeToHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li></ul></div><div class="col footer__col"><div class="footer__title">Apache</div><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li><li class="footer__item"><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://hudi.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/cn/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/cn/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright © 2021 <a href="https://apache.org">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0"> Apache License, Version 2.0</a>.
      Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation. <a href="/docs/privacy">Privacy Policy</a></div></div></div></footer></div>
<script src="/cn/assets/js/runtime~main.b012fd54.js"></script>
<script src="/cn/assets/js/main.10d9d53d.js"></script>
</body>
</html>