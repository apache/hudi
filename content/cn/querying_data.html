<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="在这一页里，我们介绍了如何在Hudi构建的表上启用SQL查询。">
<meta name="keywords" content="hudi, hive, spark, sql, presto">
<title>查询 Hudi 数据集 | Hudi</title>
<link rel="stylesheet" href="/css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="/css/modern-business.css">
<link rel="stylesheet" href="/css/lavish-bootstrap.css">
<link rel="stylesheet" href="/css/customstyles.css">
<link rel="stylesheet" href="/css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="/js/toc.js"></script>
<script src="/js/customscripts.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-93561550-1', 'auto');
  ga('send', 'pageview');

</script>

<link rel="shortcut icon" href="/images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://0.0.0.0:4000feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="fa fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle">
              <img src="https://www.apache.org/img/hudi.png" alt="Hudi logo"/>
              <!--Hudi-->
            </span><br/>
            <p class="navbar-incubate">(Incubating)</p></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                

                
                
                
                <li><a href="releases.html">发布</a></li>
                
                
                
                <li><a href="community.html">社区</a></li>
                
                
                
                <li><a href="https://github.com/apache/incubator-hudi" target="_blank">代码</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">开发者<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="contributing.html">贡献</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank">维基/设计</a></li>
                        
                        
                        
                        <li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank">问题</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/pages/viewrecentblogposts.action?key=HUDI" target="_blank">博客</a></li>
                        
                        
                        
                        <li><a href="https://projects.apache.org/project.html?incubator-hudi" target="_blank">团队</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:dev@hudi.apache.org?subject=Hudi Documentation feedback&body=I have some feedback about the 查询 Hudi 数据集 page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

<li>

		
                <li>
                    
                    <a href="/querying_data.html">English</a>
                    
                </li>
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">

                        
                        <input type="text" id="search-input" placeholder="搜索...">
                        

                        <ul id="results-container"></ul>
                    </div>
                    <script src="/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="查询 Hudi 数据集">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        <p class="alert alert-warning"> <b>Hello:</b> Click <a href="/newsite-content"> here</a> to try our new site.</p>

    </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-2">
          








<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Version (0.5.0-incubating)</li>
    
    
    
    <li>
        <a href="#">入门指南</a>
        <ul>
            
            
            
            <li><a href="quickstart.html">快速开始</a></li>
            
            
            
            
            
            
            <li><a href="use_cases.html">使用案例</a></li>
            
            
            
            
            
            
            <li><a href="powered_by.html">演讲 & Hudi 用户</a></li>
            
            
            
            
            
            
            <li><a href="comparison.html">对比</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">文档</a>
        <ul>
            
            
            
            <li><a href="concepts.html">概念</a></li>
            
            
            
            
            
            
            <li><a href="writing_data.html">写入数据</a></li>
            
            
            
            
            
            
            <li><a href="querying_data.html">查询数据</a></li>
            
            
            
            
            
            
            <li><a href="configurations.html">配置</a></li>
            
            
            
            
            
            
            <li><a href="performance.html">性能</a></li>
            
            
            
            
            
            
            <li><a href="admin_guide.html">管理</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

        </div>
        <!-- Content Column -->
        <div class="col-md-8">
            <div class="post-header">
   <h1 class="post-title-main">查询 Hudi 数据集</h1>
</div>



<div class="post-content">

   
    <div class="summary">在这一页里，我们介绍了如何在Hudi构建的表上启用SQL查询。</div>
   

    

  <p>从概念上讲，Hudi物理存储一次数据到DFS上，同时在其上提供三个逻辑视图，如<a href="concepts.html#views">之前</a>所述。
数据集同步到Hive Metastore后，它将提供由Hudi的自定义输入格式支持的Hive外部表。一旦提供了适当的Hudi捆绑包，
就可以通过Hive、Spark和Presto之类的常用查询引擎来查询数据集。</p>

<p>具体来说，在写入过程中传递了两个由<a href="configurations.html#TABLE_NAME_OPT_KEY">table name</a>命名的Hive表。
例如，如果<code class="highlighter-rouge">table name = hudi_tbl</code>，我们得到</p>

<ul>
  <li><code class="highlighter-rouge">hudi_tbl</code> 实现了由 <code class="highlighter-rouge">HoodieParquetInputFormat</code> 支持的数据集的读优化视图，从而提供了纯列式数据。</li>
  <li><code class="highlighter-rouge">hudi_tbl_rt</code> 实现了由 <code class="highlighter-rouge">HoodieParquetRealtimeInputFormat</code> 支持的数据集的实时视图，从而提供了基础数据和日志数据的合并视图。</li>
</ul>

<p>如概念部分所述，<a href="https://www.oreilly.com/ideas/ubers-case-for-incremental-processing-on-hadoop">增量处理</a>所需要的
一个关键原语是<code class="highlighter-rouge">增量拉取</code>（以从数据集中获取更改流/日志）。您可以增量提取Hudi数据集，这意味着自指定的即时时间起，
您可以只获得全部更新和新行。 这与插入更新一起使用，对于构建某些数据管道尤其有用，包括将1个或多个源Hudi表（数据流/事实）以增量方式拉出（流/事实）
并与其他表（数据集/维度）结合以<a href="write_data.html">写出增量</a>到目标Hudi数据集。增量视图是通过查询上表之一实现的，并具有特殊配置，
该特殊配置指示查询计划仅需要从数据集中获取增量数据。</p>

<p>接下来，我们将详细讨论在每个查询引擎上如何访问所有三个视图。</p>

<h2 id="hive">Hive</h2>

<p>为了使Hive能够识别Hudi数据集并正确查询，
HiveServer2需要在其<a href="https://www.cloudera.com/documentation/enterprise/5-6-x/topics/cm_mc_hive_udf.html#concept_nc3_mms_lr">辅助jars路径</a>中提供<code class="highlighter-rouge">hudi-hadoop-mr-bundle-x.y.z-SNAPSHOT.jar</code>。 
这将确保输入格式类及其依赖项可用于查询计划和执行。</p>

<h3 id="hive-ro-view">读优化表</h3>
<p>除了上述设置之外，对于beeline cli访问，还需要将<code class="highlighter-rouge">hive.input.format</code>变量设置为<code class="highlighter-rouge">org.apache.hudi.hadoop.HoodieParquetInputFormat</code>输入格式的完全限定路径名。
对于Tez，还需要将<code class="highlighter-rouge">hive.tez.input.format</code>设置为<code class="highlighter-rouge">org.apache.hadoop.hive.ql.io.HiveInputFormat</code>。</p>

<h3 id="hive-rt-view">实时表</h3>
<p>除了在HiveServer2上安装Hive捆绑jars之外，还需要将其放在整个集群的hadoop/hive安装中，这样查询也可以使用自定义RecordReader。</p>

<h3 id="hive-incr-pull">增量拉取</h3>

<p><code class="highlighter-rouge">HiveIncrementalPuller</code>允许通过HiveQL从大型事实/维表中增量提取更改，
结合了Hive（可靠地处理复杂的SQL查询）和增量原语的好处（通过增量拉取而不是完全扫描来加快查询速度）。
该工具使用Hive JDBC运行hive查询并将其结果保存在临时表中，这个表可以被插入更新。
Upsert实用程序（<code class="highlighter-rouge">HoodieDeltaStreamer</code>）具有目录结构所需的所有状态，以了解目标表上的提交时间应为多少。
例如：<code class="highlighter-rouge">/app/incremental-hql/intermediate/{source_table_name}_temp/{last_commit_included}</code>。
已注册的Delta Hive表的格式为<code class="highlighter-rouge">{tmpdb}.{source_table}_{last_commit_included}</code>。</p>

<p>以下是HiveIncrementalPuller的配置选项</p>

<table>
  <tbody>
    <tr>
      <td><strong>配置</strong></td>
      <td><strong>描述</strong></td>
      <td><strong>默认值</strong></td>
    </tr>
    <tr>
      <td>hiveUrl</td>
      <td>要连接的Hive Server 2的URL</td>
      <td> </td>
    </tr>
    <tr>
      <td>hiveUser</td>
      <td>Hive Server 2 用户名</td>
      <td> </td>
    </tr>
    <tr>
      <td>hivePass</td>
      <td>Hive Server 2 密码</td>
      <td> </td>
    </tr>
    <tr>
      <td>queue</td>
      <td>YARN 队列名称</td>
      <td> </td>
    </tr>
    <tr>
      <td>tmp</td>
      <td>DFS中存储临时增量数据的目录。目录结构将遵循约定。请参阅以下部分。</td>
      <td> </td>
    </tr>
    <tr>
      <td>extractSQLFile</td>
      <td>在源表上要执行的提取数据的SQL。提取的数据将是自特定时间点以来已更改的所有行。</td>
      <td> </td>
    </tr>
    <tr>
      <td>sourceTable</td>
      <td>源表名称。在Hive环境属性中需要设置。</td>
      <td> </td>
    </tr>
    <tr>
      <td>targetTable</td>
      <td>目标表名称。中间存储目录结构需要。</td>
      <td> </td>
    </tr>
    <tr>
      <td>sourceDataPath</td>
      <td>源DFS基本路径。这是读取Hudi元数据的地方。</td>
      <td> </td>
    </tr>
    <tr>
      <td>targetDataPath</td>
      <td>目标DFS基本路径。 这是计算fromCommitTime所必需的。 如果显式指定了fromCommitTime，则不需要设置这个参数。</td>
      <td> </td>
    </tr>
    <tr>
      <td>tmpdb</td>
      <td>用来创建中间临时增量表的数据库</td>
      <td>hoodie_temp</td>
    </tr>
    <tr>
      <td>fromCommitTime</td>
      <td>这是最重要的参数。 这是从中提取更改的记录的时间点。</td>
      <td> </td>
    </tr>
    <tr>
      <td>maxCommits</td>
      <td>要包含在拉取中的提交数。将此设置为-1将包括从fromCommitTime开始的所有提交。将此设置为大于0的值，将包括在fromCommitTime之后仅更改指定提交次数的记录。如果您需要一次赶上两次提交，则可能需要这样做。</td>
      <td>3</td>
    </tr>
    <tr>
      <td>help</td>
      <td>实用程序帮助</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>设置fromCommitTime=0和maxCommits=-1将提取整个源数据集，可用于启动Backfill。
如果目标数据集是Hudi数据集，则该实用程序可以确定目标数据集是否没有提交或延迟超过24小时（这是可配置的），
它将自动使用Backfill配置，因为增量应用最近24小时的更改会比Backfill花费更多的时间。
该工具当前的局限性在于缺乏在混合模式（正常模式和增量模式）下自联接同一表的支持。</p>

<p><strong>关于使用Fetch任务执行的Hive查询的说明：</strong>
由于Fetch任务为每个分区调用InputFormat.listStatus()，每个listStatus()调用都会列出Hoodie元数据。
为了避免这种情况，如下操作可能是有用的，即使用Hive session属性对增量查询禁用Fetch任务：
<code class="highlighter-rouge">set hive.fetch.task.conversion = none;</code>。这将确保Hive查询使用Map Reduce执行，
合并分区（用逗号分隔），并且对所有这些分区仅调用一次InputFormat.listStatus()。</p>

<h2 id="spark">Spark</h2>

<p>Spark可将Hudi jars和捆绑包轻松部署和管理到作业/笔记本中。简而言之，通过Spark有两种方法可以访问Hudi数据集。</p>

<ul>
  <li><strong>Hudi DataSource</strong>：支持读取优化和增量拉取，类似于标准数据源（例如：<code class="highlighter-rouge">spark.read.parquet</code>）的工作方式。</li>
  <li><strong>以Hive表读取</strong>：支持所有三个视图，包括实时视图，依赖于自定义的Hudi输入格式（再次类似Hive）。</li>
</ul>

<p>通常，您的spark作业需要依赖<code class="highlighter-rouge">hudi-spark</code>或<code class="highlighter-rouge">hudi-spark-bundle-x.y.z.jar</code>，
它们必须位于驱动程序和执行程序的类路径上（提示：使用<code class="highlighter-rouge">--jars</code>参数）。</p>

<h3 id="spark-ro-view">读优化表</h3>

<p>要使用SparkSQL将RO表读取为Hive表，只需按如下所示将路径过滤器推入sparkContext。
对于Hudi表，该方法保留了Spark内置的读取Parquet文件的优化功能，例如进行矢量化读取。</p>

<pre><code class="language-Scala">spark.sparkContext.hadoopConfiguration.setClass("mapreduce.input.pathFilter.class", classOf[org.apache.hudi.hadoop.HoodieROTablePathFilter], classOf[org.apache.hadoop.fs.PathFilter]);
</code></pre>

<p>如果您希望通过数据源在DFS上使用全局路径，则只需执行以下类似操作即可得到Spark DataFrame。</p>

<pre><code class="language-Scala">Dataset&lt;Row&gt; hoodieROViewDF = spark.read().format("org.apache.hudi")
// pass any path glob, can include hudi &amp; non-hudi datasets
.load("/glob/path/pattern");
</code></pre>

<h3 id="spark-rt-view">实时表</h3>
<p>当前，实时表只能在Spark中作为Hive表进行查询。为了做到这一点，设置<code class="highlighter-rouge">spark.sql.hive.convertMetastoreParquet = false</code>，
迫使Spark回退到使用Hive Serde读取数据（计划/执行仍然是Spark）。</p>

<pre><code class="language-Scala">$ spark-shell --jars hudi-spark-bundle-x.y.z-SNAPSHOT.jar --driver-class-path /etc/hive/conf  --packages com.databricks:spark-avro_2.11:4.0.0 --conf spark.sql.hive.convertMetastoreParquet=false --num-executors 10 --driver-memory 7g --executor-memory 2g  --master yarn-client

scala&gt; sqlContext.sql("select count(*) from hudi_rt where datestr = '2016-10-02'").show()
</code></pre>

<h3 id="spark-incr-pull">增量拉取</h3>
<p><code class="highlighter-rouge">hudi-spark</code>模块提供了DataSource API，这是一种从Hudi数据集中提取数据并通过Spark处理数据的更优雅的方法。
如下所示是一个示例增量拉取，它将获取自<code class="highlighter-rouge">beginInstantTime</code>以来写入的所有记录。</p>

<pre><code class="language-Java"> Dataset&lt;Row&gt; hoodieIncViewDF = spark.read()
     .format("org.apache.hudi")
     .option(DataSourceReadOptions.VIEW_TYPE_OPT_KEY(),
             DataSourceReadOptions.VIEW_TYPE_INCREMENTAL_OPT_VAL())
     .option(DataSourceReadOptions.BEGIN_INSTANTTIME_OPT_KEY(),
            &lt;beginInstantTime&gt;)
     .load(tablePath); // For incremental view, pass in the root/base path of dataset
</code></pre>

<p>请参阅<a href="configurations.html#spark-datasource">设置</a>部分，以查看所有数据源选项。</p>

<p>另外，<code class="highlighter-rouge">HoodieReadClient</code>通过Hudi的隐式索引提供了以下功能。</p>

<table>
  <tbody>
    <tr>
      <td><strong>API</strong></td>
      <td><strong>描述</strong></td>
    </tr>
    <tr>
      <td>read(keys)</td>
      <td>使用Hudi自己的索通过快速查找将与键对应的数据作为DataFrame读出</td>
    </tr>
    <tr>
      <td>filterExists()</td>
      <td>从提供的RDD[HoodieRecord]中过滤出已经存在的记录。对删除重复数据有用</td>
    </tr>
    <tr>
      <td>checkExists(keys)</td>
      <td>检查提供的键是否存在于Hudi数据集中</td>
    </tr>
  </tbody>
</table>

<h2 id="presto">Presto</h2>

<p>Presto是一种常用的查询引擎，可提供交互式查询性能。 Hudi RO表可以在Presto中无缝查询。
这需要在整个安装过程中将<code class="highlighter-rouge">hudi-presto-bundle</code> jar放入<code class="highlighter-rouge">&lt;presto_install&gt;/plugin/hive-hadoop2/</code>中。</p>


    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                  <p>
                  Copyright &copy; <span id="copyright-year">2019</span> <a href="https://apache.org">The Apache Software Foundation</a>,
                  Licensed under the Apache License, Version 2.0<br>
                  Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation.| <a href="/privacy">Privacy Policy</a><br>
                  <a class="footer-link-img" href="https://apache.org">
                    <img src="/images/asf_logo.svg" alt="The Apache Software Foundation" height="100px" widh="50px"></a>
                  </p>
                  <p>
                  Apache Hudi is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the <a href="http://incubator.apache.org/">Apache Incubator</a>.
                  Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have
                  stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a
                  reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
                  </p>
                </div>
                <div class="col-lg-12 footer">
                  <div class="ui link list">
                    <a class="item" rel="external" href="https://incubator.apache.org/"> Apache Incubator </a>
                    <a class="item" rel="external" href="https://www.apache.org/"> About the ASF </a>
                    <a class="item" rel="external" href="https://www.apache.org/events/current-event"> Events </a>
                    <a class="item" rel="external" href="https://www.apache.org/foundation/thanks.html"> Thanks </a>
                    <a class="item" rel="external" href="https://www.apache.org/foundation/sponsorship.html"> Become a Sponsor </a>
                    <a class="item" rel="external" href="https://www.apache.org/security/"> Security </a>
                    <a class="item" rel="external" href="https://www.apache.org/licenses/"> License </a>
                  </div>
                </div>
            </div>
</footer>


        </div>
        <div class="col-md-2">
            
            
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 130);
  return false
})
  
});
</script>

<div id="toc"></div>

            
        </div>
    <!-- /.row -->
    </div>
<!-- /.container -->
</div>

</body>

</html>