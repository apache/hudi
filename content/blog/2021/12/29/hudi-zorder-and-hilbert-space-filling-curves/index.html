<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Hudi: User-Facing Analytics RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Hudi: User-Facing Analytics Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Apache Hudi: User-Facing Analytics JSON Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Hudi" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa|Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css"><title data-react-helmet="true">Hudi Z-Order and Hilbert Space Filling Curves | Apache Hudi</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://hudi.apache.org/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="keywords" content="apache hudi, data lake, lakehouse, big data, apache spark, apache flink, presto, trino, analytics, data engineering"><meta data-react-helmet="true" property="og:title" content="Hudi Z-Order and Hilbert Space Filling Curves | Apache Hudi"><meta data-react-helmet="true" name="description" content="As of Hudi v0.10.0, we are excited to introduce support for an advanced Data Layout Optimization technique known in the database realm as Z-order and Hilbert space filling curves."><meta data-react-helmet="true" property="og:description" content="As of Hudi v0.10.0, we are excited to introduce support for an advanced Data Layout Optimization technique known in the database realm as Z-order and Hilbert space filling curves."><meta data-react-helmet="true" property="og:image" content="https://hudi.apache.org/assets/images/zordercurve.png"><meta data-react-helmet="true" name="twitter:image" content="https://hudi.apache.org/assets/images/zordercurve.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-12-29T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="design,clustering,data skipping,apache hudi"><link data-react-helmet="true" rel="icon" href="/assets/images/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hudi.apache.org/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/cn/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves" hreflang="cn"><link data-react-helmet="true" rel="alternate" href="https://hudi.apache.org/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.635c4f43.css">
<link rel="preload" href="/assets/js/runtime~main.72bec70c.js" as="script">
<link rel="preload" href="/assets/js/main.21e8aaca.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">⭐️ If you like Apache Hudi, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/apache/hudi">GitHub</a>! ⭐</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/assets/images/hudi.png" alt="Apache Hudi" class="themedImage_TMUO themedImage--dark_uzRr"></div></a><a class="navbar__item navbar__link" href="/docs/overview">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/talks">Talks</a></li><li><a class="dropdown__link" href="/docs/faq">FAQ</a></li><li><a class="dropdown__link" href="/tech-specs">Tech Specs</a></li><li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Technical Wiki<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Contribute</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/contribute/how-to-contribute">How to Contribute</a></li><li><a class="dropdown__link" href="/contribute/developer-setup">Developer Setup</a></li><li><a class="dropdown__link" href="/contribute/rfc-process">RFC Process</a></li><li><a class="dropdown__link" href="/contribute/report-security-issues">Report Security Issues</a></li><li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Report Issues<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/get-involved">Get Involved</a></li><li><a class="dropdown__link" href="/community/syncs">Community Syncs</a></li><li><a class="dropdown__link" href="/community/office_hours">Office Hours</a></li><li><a class="dropdown__link" href="/community/team">Team</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/powered-by">Who&#x27;s Using</a><a class="navbar__item navbar__link" href="/roadmap">Roadmap</a><a class="navbar__item navbar__link" href="/releases/download">Download</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/overview">0.12.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/overview">Current</a></li><li><a class="dropdown__link" href="/docs/overview">0.12.1</a></li><li><a class="dropdown__link" href="/docs/0.12.0/overview">0.12.0</a></li><li><a class="dropdown__link" href="/docs/0.11.1/overview">0.11.1</a></li><li><a class="dropdown__link" href="/docs/0.11.0/overview">0.11.0</a></li><li><a class="dropdown__link" href="/docs/0.10.1/overview">0.10.1</a></li><li><a class="dropdown__link" href="/docs/0.10.0/overview">0.10.0</a></li><li><a class="dropdown__link" href="/docs/0.9.0/overview">0.9.0</a></li><li><a class="dropdown__link" href="/docs/0.8.0/overview">0.8.0</a></li><li><a class="dropdown__link" href="/docs/0.7.0/overview">0.7.0</a></li><li><a class="dropdown__link" href="/docs/0.6.0/quick-start-guide">0.6.0</a></li><li><a class="dropdown__link" href="/docs/0.5.3/quick-start-guide">0.5.3</a></li><li><a class="dropdown__link" href="/docs/0.5.2/quick-start-guide">0.5.2</a></li><li><a class="dropdown__link" href="/docs/0.5.1/quick-start-guide">0.5.1</a></li><li><a class="dropdown__link" href="/docs/0.5.0/quick-start-guide">0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/cn/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves" target="_self" rel="noopener noreferrer" class="dropdown__link">Chinese</a></li></ul></div><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link" aria-label="Hudi Twitter Handle"></a><a href="https://join.slack.com/t/apache-hudi/shared_invite/zt-1e94d3xro-JvlNO1kSeIHJBTVfLPlI5w" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link" aria-label="Hudi Slack Channel"></a><a href="https://www.youtube.com/channel/UCs7AhE0BWaEPZSChrBR-Muw" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-youtube-link" aria-label="Hudi YouTube Channel"></a><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-2" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header class="postHeader_Ipb1"><div><h1 class="blogPostTitle_RC3s" itemprop="headline"><h1 class="blogPostPageTitle_bKZt" itemprop="headline">Hudi Z-Order and Hilbert Space Filling Curves</h1></h1><div class="blogInfo_1FPd margin-top--sm margin-bottom--sm"><div class="blogPostText_jBA8 row"><time datetime="2021-12-29T00:00:00.000Z" itemprop="datePublished">December 29, 2021</time><div><div class="avatar"><div><a itemprop="url"><span class="blogPostAuthorsList_dlEG" itemprop="name">Alexey Kudinkin and Tao Meng</span></a></div></div></div></div><div class="blogPostData_A2Le">9 min read</div></div></div><ul class="authorTimeTags_oN88 padding--none margin-left--sm tagsWrapperPostPage_VdId"><li class="tag_MgfY tagPostPage_gnvv"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/design">design</a></li><li class="tag_MgfY tagPostPage_gnvv"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/clustering">clustering</a></li><li class="tag_MgfY tagPostPage_gnvv"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/data-skipping">data skipping</a></li><li class="tag_MgfY tagPostPage_gnvv"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/apache-hudi">apache hudi</a></li></ul></header><div class="markdown" itemprop="articleBody"><p>As of Hudi v0.10.0, we are excited to introduce support for an advanced Data Layout Optimization technique known in the database realm as <a href="https://en.wikipedia.org/wiki/Z-order_curve" target="_blank" rel="noopener noreferrer">Z-order</a> and <a href="https://en.wikipedia.org/wiki/Hilbert_curve" target="_blank" rel="noopener noreferrer">Hilbert</a> space filling curves.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">​</a></h3><p>Amazon EMR team recently published a <a href="https://aws.amazon.com/blogs/big-data/new-features-from-apache-hudi-0-7-0-and-0-8-0-available-on-amazon-emr/" target="_blank" rel="noopener noreferrer">great article</a> show-casing how <a href="https://hudi.apache.org/docs/clustering" target="_blank" rel="noopener noreferrer">clustering</a> your data can improve your <em>query performance</em>.</p><p>To better understand what&#x27;s going on and how it&#x27;s related to space-filling curves, let&#x27;s zoom in to the setup in that article:</p><p>In the article, 2 <a href="https://hudi.apache.org/docs/overview" target="_blank" rel="noopener noreferrer">Apache Hudi</a> tables are compared (both ingested from the well-known <a href="https://s3.amazonaws.com/amazon-reviews-pds/tsv/index.txt" target="_blank" rel="noopener noreferrer">Amazon Reviews</a> dataset):</p><ul><li><code>amazon_reviews</code> table which is not clustered (ie the data has not been re-ordered by any particular key)</li><li><code>amazon_reviews_clustered</code> table which is clustered. When data is clustered by Apache Hudi the data is <a href="https://en.wikipedia.org/wiki/Lexicographic_order" target="_blank" rel="noopener noreferrer"><strong>lexicographically ordered</strong></a> (hereon we will be referring to this kind of ordering as <strong><em>linear ordering</em></strong>) by 2 columns: <code>star_rating</code>, <code>total_votes</code> (see screenshot below)</li></ul><img src="/assets/images/hudiconfigz.png" alt="drawing" width="800"><p><em>Screenshot of the Hudi configuration (from Amazon EMR team article)</em></p><p>To showcase the improvement in querying performance, the following queries are executed against both of these tables:</p><img src="/assets/images/table1.png" alt="drawing" width="800"><img src="/assets/images/table2.png" alt="drawing" width="800"><p><em>Screenshots of the queries run against the previously setup tables (from Amazon EMR team article)</em></p><p>The important consideration to point out here is that the queries were specifying <strong>both of the columns</strong> latter table is ordered by (both <code>star_rating</code> and <code>total_votes</code>).</p><p>And this is unfortunately a crucial limitation of the linear/lexicographic ordering, the value of the ordering diminishes very quickly as you add more columns. It&#x27;s not hard to see why:</p><img src="/assets/images/lexicographicorder.png" alt="drawing" width="250"><p><em>Courtesy of Wikipedia,</em> <a href="https://en.wikipedia.org/wiki/Lexicographic_order" target="_blank" rel="noopener noreferrer"><em>Lexicographic Order article</em></a></p><p>From this image you can see that with lexicographically ordered 3-tuples of integers, only the first column is able to feature crucial property of <strong>locality</strong> for all of the records having the same value: for ex, all of the records wit values starting with &quot;1&quot;, &quot;2&quot;, &quot;3&quot; (in the first columns) are nicely clumped together. However if you try to find all the values that have &quot;5&quot; as the value in their third column you&#x27;d see that those are now dispersed all over the place, not being localized at all.</p><p>The crucial property that improves query performance is locality: it enables queries to substantially reduce the search space and the number of files that need to be scanned, parsed, etc.</p><p>But... does this mean that our queries are doomed to do a full-scan if we&#x27;re filtering by anything other than the first (or more accurate would be to say prefix) of the list of columns the table is ordered by?</p><p>Not exactly: luckily, locality is also a property that space-filling curves enable while enumerating multi-dimensional spaces (records in our table could be represented as points in N-dimensional space, where N is the number of columns in our table)</p><p>How does it work?</p><p>Let&#x27;s take Z-curve as an example: Z-order curves fitting a 2-dimensional plane would look like the following:</p><img src="/assets/images/zordercurve.png" alt="drawing" width="400"><p><em>Courtesy of Wikipedia,</em> <a href="https://en.wikipedia.org/wiki/Z-order_curve" target="_blank" rel="noopener noreferrer"><em>Z-order curve article</em></a></p><p>As you can see following its path, instead of simply ordering by one coordinate (&quot;x&quot;) first, following with the other, it&#x27;s actually ordering them as if the bits of those coordinates have been <em>interwoven</em> into a single value:</p><table><thead><tr><th>Coordinate</th><th>X (binary)</th><th>Y (binary)</th><th>Z-values (ordered)</th></tr></thead><tbody><tr><td>(0, 0)</td><td>000</td><td>000</td><td>000000</td></tr><tr><td>(1, 0)</td><td>001</td><td>000</td><td>000001</td></tr><tr><td>(0, 1)</td><td>000</td><td>001</td><td>000010</td></tr><tr><td>(1, 1)</td><td>001</td><td>001</td><td>000011</td></tr></tbody></table><p>This allows for that crucial property of locality (even though a slightly &quot;stretched&quot; one) to be carried over to all columns as compared to just the first one in case of linear ordering.</p><p>In a similar fashion, Hilbert curves also allow you to map points in a N-dimensional space (rows in our table) onto 1-dimensional curve, essentially <em>ordering</em> them, while still preserving the crucial property of locality. Read more details about Hilbert Curves <a href="https://drum.lib.umd.edu/handle/1903/804" target="_blank" rel="noopener noreferrer">here</a>. Our personal experiments so far show that ordering data along a Hilbert curve leads to better clustering and performance outcomes.</p><p>Now, let&#x27;s check it out in action!</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="setup">Setup<a class="hash-link" href="#setup" title="Direct link to heading">​</a></h3><p>We will use the <a href="https://s3.amazonaws.com/amazon-reviews-pds/readme.html" target="_blank" rel="noopener noreferrer">Amazon Reviews</a> dataset again, but this time we will use Hudi to Z-Order by <code>product_id</code>, <code>customer_id</code> columns tuple instead of Clustering or <em>linear ordering</em>.</p><p>No special preparations are required for the dataset, you can simply download it from <a href="https://s3.amazonaws.com/amazon-reviews-pds/readme.html" target="_blank" rel="noopener noreferrer">S3</a> in Parquet format and use it directly as an input for Spark ingesting it into Hudi table.</p><p>Launch Spark Shell</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./bin/spark-shell --master &#x27;local[4]&#x27; --driver-memory 8G --executor-memory 8G \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --jars ../../packaging/hudi-spark-bundle/target/hudi-spark3-bundle_2.12-0.10.0.jar \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --packages org.apache.spark:spark-avro_2.12:2.4.4 \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --conf &#x27;spark.serializer=org.apache.spark.serializer.KryoSerializer&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Paste</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hadoop.fs.{FileStatus, Path}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import scala.collection.JavaConversions._</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.spark.sql.SaveMode._</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.{DataSourceReadOptions, DataSourceWriteOptions}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.DataSourceWriteOptions._</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.common.fs.FSUtils</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.common.table.HoodieTableMetaClient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.common.util.ClusteringUtils</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.config.HoodieClusteringConfig</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.hudi.config.HoodieWriteConfig._</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.spark.sql.DataFrame</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import java.util.stream.Collectors</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val layoutOptStrategy = &quot;z-order&quot;; // OR &quot;hilbert&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val inputPath = s&quot;file:///${System.getProperty(&quot;user.home&quot;)}/datasets/amazon_reviews_parquet&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val tableName = s&quot;amazon_reviews_${layoutOptStrategy}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val outputPath = s&quot;file:///tmp/hudi/$tableName&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def safeTableName(s: String) = s.replace(&#x27;-&#x27;, &#x27;_&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val commonOpts =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Map(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;hoodie.compact.inline&quot; -&gt; &quot;false&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;hoodie.bulk_insert.shuffle.parallelism&quot; -&gt; &quot;10&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Writing to Hudi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val df = spark.read.parquet(inputPath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">df.write.format(&quot;hudi&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(DataSourceWriteOptions.TABLE_TYPE.key(), COW_TABLE_TYPE_OPT_VAL)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.table.name&quot;, tableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(PRECOMBINE_FIELD.key(), &quot;review_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(RECORDKEY_FIELD.key(), &quot;review_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(DataSourceWriteOptions.PARTITIONPATH_FIELD.key(), &quot;product_category&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.clustering.inline&quot;, &quot;true&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.clustering.inline.max.commits&quot;, &quot;1&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // NOTE: Small file limit is intentionally kept _ABOVE_ target file-size max threshold for Clustering,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // to force re-clustering</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.clustering.plan.strategy.small.file.limit&quot;, String.valueOf(1024 * 1024 * 1024)) // 1Gb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.clustering.plan.strategy.target.file.max.bytes&quot;, String.valueOf(128 * 1024 * 1024)) // 128Mb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // NOTE: We&#x27;re increasing cap on number of file-groups produced as part of the Clustering run to be able to accommodate for the </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // whole dataset (~33Gb)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(&quot;hoodie.clustering.plan.strategy.max.num.groups&quot;, String.valueOf(4096))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(HoodieClusteringConfig.LAYOUT_OPTIMIZE_ENABLE.key, &quot;true&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(HoodieClusteringConfig.LAYOUT_OPTIMIZE_STRATEGY.key, layoutOptStrategy)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(HoodieClusteringConfig.PLAN_STRATEGY_SORT_COLUMNS.key, &quot;product_id,customer_id&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(DataSourceWriteOptions.OPERATION.key(), DataSourceWriteOptions.BULK_INSERT_OPERATION_OPT_VAL)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .option(BULK_INSERT_SORT_MODE.key(), &quot;NONE&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .options(commonOpts)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .mode(ErrorIfExists)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="testing">Testing<a class="hash-link" href="#testing" title="Direct link to heading">​</a></h3><p>Please keep in mind, that each individual test is run in a separate spark-shell to avoid caching getting in the way of our measurements.</p><div class="codeBlockContainer_J+bg language-scala theme-code-block"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">////////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Reading</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">///////////////////////////////////////////////////////////////</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Temp Table w/ Data Skipping DISABLED</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val readDf: DataFrame =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.read.option(DataSourceReadOptions.ENABLE_DATA_SKIPPING.key(), &quot;false&quot;).format(&quot;hudi&quot;).load(outputPath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val rawSnapshotTableName = safeTableName(s&quot;${tableName}_sql_snapshot&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">readDf.createOrReplaceTempView(rawSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Temp Table w/ Data Skipping ENABLED</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val readDfSkip: DataFrame =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.read.option(DataSourceReadOptions.ENABLE_DATA_SKIPPING.key(), &quot;true&quot;).format(&quot;hudi&quot;).load(outputPath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">val dataSkippingSnapshotTableName = safeTableName(s&quot;${tableName}_sql_snapshot_skipping&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">readDfSkip.createOrReplaceTempView(dataSkippingSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 1: Total votes by product_category, for 6 months</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def runQuery1(tableName: String) = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // Query 1: Total votes by product_category, for 6 months</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql(s&quot;SELECT sum(total_votes), product_category FROM $tableName WHERE review_date &gt; &#x27;2013-12-15&#x27; AND review_date &lt; &#x27;2014-06-01&#x27; GROUP BY product_category&quot;).show()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 2: Average star rating by product_id, for some product</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def runQuery2(tableName: String) = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql(s&quot;SELECT avg(star_rating), product_id FROM $tableName WHERE product_id in (&#x27;B0184XC75U&#x27;) GROUP BY product_id&quot;).show()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 3: Count number of reviews by customer_id for some 5 customers</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">def runQuery3(tableName: String) = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql(s&quot;SELECT count(*) as num_reviews, customer_id FROM $tableName WHERE customer_id in (&#x27;53096570&#x27;,&#x27;10046284&#x27;,&#x27;53096576&#x27;,&#x27;10000196&#x27;,&#x27;21700145&#x27;) GROUP BY customer_id&quot;).show()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 1: Is a &quot;wide&quot; query and hence it&#x27;s expected to touch a lot of files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery1(rawSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|sum(total_votes)|    product_category|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         1050944|                  PC|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          867794|             Kitchen|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         1167489|                Home|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          927531|            Wireless|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|            6861|               Video|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           39602| Digital_Video_Games|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          954924|Digital_Video_Dow...|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           81876|             Luggage|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          320536|         Video_Games|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          817679|              Sports|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           11451|  Mobile_Electronics|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          228739|  Home_Entertainment|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         3769269|Digital_Ebook_Pur...|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          252273|                Baby|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          735042|             Apparel|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           49101|    Major_Appliances|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          484732|             Grocery|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          285682|               Tools|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          459980|         Electronics|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          454258|            Outdoors|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">only showing top 20 rows</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery1(dataSkippingSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|sum(total_votes)|    product_category|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         1050944|                  PC|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          867794|             Kitchen|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         1167489|                Home|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          927531|            Wireless|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|            6861|               Video|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           39602| Digital_Video_Games|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          954924|Digital_Video_Dow...|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           81876|             Luggage|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          320536|         Video_Games|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          817679|              Sports|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           11451|  Mobile_Electronics|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          228739|  Home_Entertainment|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         3769269|Digital_Ebook_Pur...|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          252273|                Baby|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          735042|             Apparel|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|           49101|    Major_Appliances|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          484732|             Grocery|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          285682|               Tools|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          459980|         Electronics|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          454258|            Outdoors|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+--------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">only showing top 20 rows</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 2: Is a &quot;pointwise&quot; query and hence it&#x27;s expected that data-skipping should substantially reduce number </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// of files scanned (as compared to Baseline)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// NOTE: That Linear Ordering (as compared to Space-curve based on) will have similar effect on performance reducing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// total # of Parquet files scanned, since we&#x27;re querying on the prefix of the ordering key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery2(rawSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|avg(star_rating)|product_id|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|             1.0|B0184XC75U|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery2(dataSkippingSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|avg(star_rating)|product_id|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|             1.0|B0184XC75U|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------+----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Query 3: Similar to Q2, is a &quot;pointwise&quot; query, but querying other part of the ordering-key (product_id, customer_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// and hence it&#x27;s expected that data-skipping should substantially reduce number of files scanned (as compared to Baseline, Linear Ordering).</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// NOTE: That Linear Ordering (as compared to Space-curve based on) will _NOT_ have similar effect on performance reducing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// total # of Parquet files scanned, since we&#x27;re NOT querying on the prefix of the ordering key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery3(rawSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|num_reviews|customer_id|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         50|   53096570|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          3|   53096576|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         25|   10046284|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          1|   10000196|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         14|   21700145|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">scala&gt; runQuery3(dataSkippingSnapshotTableName)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|num_reviews|customer_id|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         50|   53096570|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          3|   53096576|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         25|   10046284|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|          1|   10000196|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|         14|   21700145|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------+-----------+</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="results">Results<a class="hash-link" href="#results" title="Direct link to heading">​</a></h3><p>We&#x27;ve summarized the measured performance metrics below:</p><table><thead><tr><th><strong>Query</strong></th><th><strong>Baseline (B)</strong> duration (files scanned / size)</th><th><strong>Linear Sorting (S)</strong></th><th><strong>Z-order (Z)</strong> duration (scanned)</th><th><strong>Hilbert (H)</strong> duration (scanned)</th></tr></thead><tbody><tr><td>Q1</td><td>14s (543 / 31.4Gb)</td><td>15s (533 / 28.8Gb)</td><td>15s (543 / 31.4Gb)</td><td>14s (541 / 31.3Gb)</td></tr><tr><td>Q2</td><td>21s (543 / 31.4Gb)</td><td>10s (533 / 28.8Gb)</td><td><strong>8s</strong> <strong>(243 / 14.4Gb)</strong></td><td><strong>7s</strong> <strong>(237 / 13.9Gb)</strong></td></tr><tr><td>Q3</td><td>17s (543 / 31.4Gb)</td><td>15s (533 / 28.8Gb)</td><td><strong>6s</strong> <strong>(224 / 12.4Gb)</strong></td><td><strong>6s</strong> <strong>(219 / 11.9Gb)</strong></td></tr></tbody></table><p>As you can see multi-column linear ordering is not very effective for the queries that do filtering by columns other than the first one (Q2, Q3).</p><p>Which is a very clear contrast with space-filling curves (both Z-order and Hilbert) that allow to speed up query time by up to <strong>3x!</strong></p><p>It&#x27;s worth noting that the performance gains are heavily dependent on your underlying data and queries. In benchmarks on our internal data we were able to achieve queries performance improvements of more than <strong>11x!</strong></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="epilogue">Epilogue<a class="hash-link" href="#epilogue" title="Direct link to heading">​</a></h3><p>Apache Hudi v0.10 brings new layout optimization capabilities Z-order and Hilbert to open source. Using these industry leading layout optimization techniques can bring substantial performance improvement and cost savings to your queries!</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_2lop"><div class="col margin-top--sm"><a href="https://github.com/apache/hudi/edit/asf-site/website/blog/blog/2021-12-29-hudi-zorder-and-hilbert-space-filling-curves.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/12/31/The-Art-of-Building-Open-Data-Lakes-with-Apache-Hudi-Kafka-Hive-and-Debezium"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->The Art of Building Open Data Lakes with Apache Hudi, Kafka, Hive, and Debezium</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/12/20/New-features-from-Apache-Hudi-0.7.0-and-0.8.0-available-on-Amazon-EMR"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">New features from Apache Hudi 0.7.0 and 0.8.0 available on Amazon EMR<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li><li><a href="#results" class="table-of-contents__link toc-highlight">Results</a></li><li><a href="#epilogue" class="table-of-contents__link toc-highlight">Epilogue</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog/2021/07/21/streaming-data-lake-platform">Our Vision</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/concepts">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/community/team">Team</a></li><li class="footer__item"><a class="footer__link-item" href="/releases/release-0.12.1">Releases</a></li><li class="footer__item"><a class="footer__link-item" href="/releases/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/powered-by">Who&#x27;s Using</a></li></ul></div><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/quick-start-guide">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/docker_demo">Docker Demo</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/talks">Talks</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/faq">FAQ</a></li><li class="footer__item"><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Technical Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Hudi On Cloud</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/s3_hoodie">AWS</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/gcs_hoodie">Google Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/oss_hoodie">Alibaba Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/azure_hoodie">Microsoft Azure</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/cos_hoodie">Tencent Cloud</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/ibm_cos_hoodie">IBM Cloud</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/contribute/get-involved">Get Involved</a></li><li class="footer__item"><a href="https://join.slack.com/t/apache-hudi/shared_invite/zt-1e94d3xro-JvlNO1kSeIHJBTVfLPlI5w" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/hudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCs7AhE0BWaEPZSChrBR-Muw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:dev-subscribe@hudi.apache.org?Subject=SubscribeToHudi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li></ul></div><div class="col footer__col"><div class="footer__title">Apache</div><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li><li class="footer__item"><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://hudi.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/assets/images/logo-big.png" alt="Apache Hudi™" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright © 2021 <a href="https://apache.org">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0"> Apache License, Version 2.0</a>. <br>Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.72bec70c.js"></script>
<script src="/assets/js/main.21e8aaca.js"></script>
</body>
</html>