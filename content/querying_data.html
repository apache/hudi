<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="In this page, we go over how to enable SQL queries on Hudi built tables.">
<meta name="keywords" content="hudi, hive, spark, sql, presto">
<title>Querying Hudi Datasets | Hudi</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-93561550-1', 'auto');
  ga('send', 'pageview');

</script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a class="fa fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle">
              <img src="https://www.apache.org/img/hudi.png" alt="Hudi logo"/>
              <!--Hudi-->
            </span><br/>
            <p class="navbar-incubate">(Incubating)</p></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="news">News</a></li>
                
                
                
                <li><a href="community.html">Community</a></li>
                
                
                
                <li><a href="https://github.com/apache/incubator-hudi" target="_blank">Code</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developers<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="contributing.html">Contributing</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/display/HUDI" target="_blank">Wiki/Designs</a></li>
                        
                        
                        
                        <li><a href="https://issues.apache.org/jira/projects/HUDI/summary" target="_blank">Issues</a></li>
                        
                        
                        
                        <li><a href="https://cwiki.apache.org/confluence/pages/viewrecentblogposts.action?key=HUDI" target="_blank">Blog</a></li>
                        
                        
                        
                        <li><a href="https://projects.apache.org/project.html?incubator-hudi" target="_blank">Team</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:dev@hudi.apache.org?subject=Hudi Documentation feedback&body=I have some feedback about the Querying Hudi Datasets page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

<li>

		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Querying Hudi Datasets">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          








<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Latest Version</li>
    
    
    
    <li>
        <a href="#">Getting Started</a>
        <ul>
            
            
            
            <li><a href="quickstart.html">Quickstart</a></li>
            
            
            
            
            
            
            <li><a href="use_cases.html">Use Cases</a></li>
            
            
            
            
            
            
            <li><a href="powered_by.html">Talks & Powered By</a></li>
            
            
            
            
            
            
            <li><a href="comparison.html">Comparison</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Documentation</a>
        <ul>
            
            
            
            <li><a href="concepts.html">Concepts</a></li>
            
            
            
            
            
            
            <li><a href="writing_data.html">Writing Data</a></li>
            
            
            
            
            
            
            <li class="active"><a href="querying_data.html">Querying Data</a></li>
            
            
            
            
            
            
            <li><a href="configurations.html">Configuration</a></li>
            
            
            
            
            
            
            <li><a href="performance.html">Performance</a></li>
            
            
            
            
            
            
            <li><a href="admin_guide.html">Administering</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Querying Hudi Datasets</h1>
</div>



<div class="post-content">

   
    <div class="summary">In this page, we go over how to enable SQL queries on Hudi built tables.</div>
   

    


    

  <p>Conceptually, Hudi stores data physically once on DFS, while providing 3 logical views on top, as explained <a href="concepts.html#views">before</a>. 
Once the dataset is synced to the Hive metastore, it provides external Hive tables backed by Hudi’s custom inputformats. Once the proper hudi
bundle has been provided, the dataset can be queried by popular query engines like Hive, Spark and Presto.</p>

<p>Specifically, there are two Hive tables named off <a href="configurations.html#TABLE_NAME_OPT_KEY">table name</a> passed during write. 
For e.g, if <code class="highlighter-rouge">table name = hudi_tbl</code>, then we get</p>

<ul>
  <li><code class="highlighter-rouge">hudi_tbl</code> realizes the read optimized view of the dataset backed by <code class="highlighter-rouge">HoodieInputFormat</code>, exposing purely columnar data.</li>
  <li><code class="highlighter-rouge">hudi_tbl_rt</code> realizes the real time view of the dataset  backed by <code class="highlighter-rouge">HoodieRealtimeInputFormat</code>, exposing merged view of base and log data.</li>
</ul>

<p>As discussed in the concepts section, the one key primitive needed for <a href="https://www.oreilly.com/ideas/ubers-case-for-incremental-processing-on-hadoop">incrementally processing</a>,
is <code class="highlighter-rouge">incremental pulls</code> (to obtain a change stream/log from a dataset). Hudi datasets can be pulled incrementally, which means you can get ALL and ONLY the updated &amp; new rows 
since a specified instant time. This, together with upserts, are particularly useful for building data pipelines where 1 or more source Hudi tables are incrementally pulled (streams/facts),
joined with other tables (datasets/dimensions), to <a href="writing_data.html">write out deltas</a> to a target Hudi dataset. Incremental view is realized by querying one of the tables above, 
with special configurations that indicates to query planning that only incremental data needs to be fetched out of the dataset.</p>

<p>In sections, below we will discuss in detail how to access all the 3 views on each query engine.</p>

<h2 id="hive">Hive</h2>

<p>In order for Hive to recognize Hudi datasets and query correctly, the HiveServer2 needs to be provided with the <code class="highlighter-rouge">hoodie-hadoop-hive-bundle-x.y.z-SNAPSHOT.jar</code> 
in its <a href="https://www.cloudera.com/documentation/enterprise/5-6-x/topics/cm_mc_hive_udf.html#concept_nc3_mms_lr">aux jars path</a>. This will ensure the input format 
classes with its dependencies are available for query planning &amp; execution.</p>

<h3 id="hive-ro-view">Read Optimized table</h3>
<p>In addition to setup above, for beeline cli access, the <code class="highlighter-rouge">hive.input.format</code> variable needs to be set to the  fully qualified path name of the 
inputformat <code class="highlighter-rouge">com.uber.hoodie.hadoop.HoodieInputFormat</code>. For Tez, additionally the <code class="highlighter-rouge">hive.tez.input.format</code> needs to be set 
to <code class="highlighter-rouge">org.apache.hadoop.hive.ql.io.HiveInputFormat</code></p>

<h3 id="hive-rt-view">Real time table</h3>
<p>In addition to installing the hive bundle jar on the HiveServer2, it needs to be put on the hadoop/hive installation across the cluster, so that
queries can pick up the custom RecordReader as well.</p>

<h3 id="hive-incr-pull">Incremental Pulling</h3>

<p><code class="highlighter-rouge">HiveIncrementalPuller</code> allows incrementally extracting changes from large fact/dimension tables via HiveQL, combining the benefits of Hive (reliably process complex SQL queries) and 
incremental primitives (speed up query by pulling tables incrementally instead of scanning fully). The tool uses Hive JDBC to run the hive query and saves its results in a temp table.
that can later be upserted. Upsert utility (<code class="highlighter-rouge">HoodieDeltaStreamer</code>) has all the state it needs from the directory structure to know what should be the commit time on the target table.
e.g: <code class="highlighter-rouge">/app/incremental-hql/intermediate/{source_table_name}_temp/{last_commit_included}</code>.The Delta Hive table registered will be of the form <code class="highlighter-rouge"><span class="p">{</span><span class="err">tmpdb</span><span class="p">}</span><span class="err">.</span><span class="p">{</span><span class="err">source_table</span><span class="p">}</span><span class="err">_</span><span class="p">{</span><span class="err">last_commit_included</span><span class="p">}</span></code>.</p>

<p>The following are the configuration options for HiveIncrementalPuller</p>

<table>
  <tbody>
    <tr>
      <td><strong>Config</strong></td>
      <td><strong>Description</strong></td>
      <td><strong>Default</strong></td>
    </tr>
    <tr>
      <td>hiveUrl</td>
      <td>Hive Server 2 URL to connect to</td>
      <td> </td>
    </tr>
    <tr>
      <td>hiveUser</td>
      <td>Hive Server 2 Username</td>
      <td> </td>
    </tr>
    <tr>
      <td>hivePass</td>
      <td>Hive Server 2 Password</td>
      <td> </td>
    </tr>
    <tr>
      <td>queue</td>
      <td>YARN Queue name</td>
      <td> </td>
    </tr>
    <tr>
      <td>tmp</td>
      <td>Directory where the temporary delta data is stored in DFS. The directory structure will follow conventions. Please see the below section.</td>
      <td> </td>
    </tr>
    <tr>
      <td>extractSQLFile</td>
      <td>The SQL to execute on the source table to extract the data. The data extracted will be all the rows that changed since a particular point in time.</td>
      <td> </td>
    </tr>
    <tr>
      <td>sourceTable</td>
      <td>Source Table Name. Needed to set hive environment properties.</td>
      <td> </td>
    </tr>
    <tr>
      <td>targetTable</td>
      <td>Target Table Name. Needed for the intermediate storage directory structure.</td>
      <td> </td>
    </tr>
    <tr>
      <td>sourceDataPath</td>
      <td>Source DFS Base Path. This is where the Hudi metadata will be read.</td>
      <td> </td>
    </tr>
    <tr>
      <td>targetDataPath</td>
      <td>Target DFS Base path. This is needed to compute the fromCommitTime. This is not needed if fromCommitTime is specified explicitly.</td>
      <td> </td>
    </tr>
    <tr>
      <td>tmpdb</td>
      <td>The database to which the intermediate temp delta table will be created</td>
      <td>hoodie_temp</td>
    </tr>
    <tr>
      <td>fromCommitTime</td>
      <td>This is the most important parameter. This is the point in time from which the changed records are pulled from.</td>
      <td> </td>
    </tr>
    <tr>
      <td>maxCommits</td>
      <td>Number of commits to include in the pull. Setting this to -1 will include all the commits from fromCommitTime. Setting this to a value &gt; 0, will include records that ONLY changed in the specified number of commits after fromCommitTime. This may be needed if you need to catch up say 2 commits at a time.</td>
      <td>3</td>
    </tr>
    <tr>
      <td>help</td>
      <td>Utility Help</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Setting fromCommitTime=0 and maxCommits=-1 will pull in the entire source dataset and can be used to initiate backfills. If the target dataset is a Hudi dataset,
then the utility can determine if the target dataset has no commits or is behind more than 24 hour (this is configurable),
it will automatically use the backfill configuration, since applying the last 24 hours incrementally could take more time than doing a backfill. The current limitation of the tool
is the lack of support for self-joining the same table in mixed mode (normal and incremental modes).</p>

<p><strong>NOTE on Hive queries that are executed using Fetch task:</strong>
Since Fetch tasks invoke InputFormat.listStatus() per partition, Hoodie metadata can be listed in
every such listStatus() call. In order to avoid this, it might be useful to disable fetch tasks
using the hive session property for incremental queries: <code class="highlighter-rouge">set hive.fetch.task.conversion=none;</code> This
would ensure Map Reduce execution is chosen for a Hive query, which combines partitions (comma
separated) and calls InputFormat.listStatus() only once with all those partitions.</p>

<h2 id="spark">Spark</h2>

<p>Spark provides much easier deployment &amp; management of Hudi jars and bundles into jobs/notebooks. At a high level, there are two ways to access Hudi datasets in Spark.</p>

<ul>
  <li><strong>Hudi DataSource</strong> : Supports Read Optimized, Incremental Pulls similar to how standard datasources (e.g: <code class="highlighter-rouge">spark.read.parquet</code>) work.</li>
  <li><strong>Read as Hive tables</strong> : Supports all three views, including the real time view, relying on the custom Hudi input formats again like Hive.</li>
</ul>

<p>In general, your spark job needs a dependency to <code class="highlighter-rouge">hoodie-spark</code> or <code class="highlighter-rouge">hoodie-spark-bundle-x.y.z.jar</code> needs to be on the class path of driver &amp; executors (hint: use <code class="highlighter-rouge">--jars</code> argument)</p>

<h3 id="spark-ro-view">Read Optimized table</h3>

<p>To read RO table as a Hive table using SparkSQL, simply push a path filter into sparkContext as follows. 
This method retains Spark built-in optimizations for reading Parquet files like vectorized reading on Hudi tables.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>spark.sparkContext.hadoopConfiguration.setClass("mapreduce.input.pathFilter.class", classOf[com.uber.hoodie.hadoop.HoodieROTablePathFilter], classOf[org.apache.hadoop.fs.PathFilter]);
</code></pre>
</div>

<p>If you prefer to glob paths on DFS via the datasource, you can simply do something like below to get a Spark dataframe to work with.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Dataset&lt;Row&gt; hoodieROViewDF = spark.read().format("com.uber.hoodie")
// pass any path glob, can include hudi &amp; non-hudi datasets
.load("/glob/path/pattern");
</code></pre>
</div>

<h3 id="spark-rt-view">Real time table</h3>
<p>Currently, real time table can only be queried as a Hive table in Spark. In order to do this, set <code class="highlighter-rouge">spark.sql.hive.convertMetastoreParquet=false</code>, forcing Spark to fallback 
to using the Hive Serde to read the data (planning/executions is still Spark).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ spark-shell --jars hoodie-spark-bundle-x.y.z-SNAPSHOT.jar --driver-class-path /etc/hive/conf  --packages com.databricks:spark-avro_2.11:4.0.0 --conf spark.sql.hive.convertMetastoreParquet=false --num-executors 10 --driver-memory 7g --executor-memory 2g  --master yarn-client

scala&gt; sqlContext.sql("select count(*) from hudi_rt where datestr = '2016-10-02'").show()
</code></pre>
</div>

<h3 id="spark-incr-pull">Incremental Pulling</h3>
<p>The <code class="highlighter-rouge">hoodie-spark</code> module offers the DataSource API, a more elegant way to pull data from Hudi dataset and process it via Spark.
A sample incremental pull, that will obtain all records written since <code class="highlighter-rouge">beginInstantTime</code>, looks like below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code> Dataset&lt;Row&gt; hoodieIncViewDF = spark.read()
     .format("com.uber.hoodie")
     .option(DataSourceReadOptions.VIEW_TYPE_OPT_KEY(),
             DataSourceReadOptions.VIEW_TYPE_INCREMENTAL_OPT_VAL())
     .option(DataSourceReadOptions.BEGIN_INSTANTTIME_OPT_KEY(),
            &lt;beginInstantTime&gt;)
     .load(tablePath); // For incremental view, pass in the root/base path of dataset
</code></pre>
</div>

<p>Please refer to <a href="configurations.html#spark-datasource">configurations</a> section, to view all datasource options.</p>

<p>Additionally, <code class="highlighter-rouge">HoodieReadClient</code> offers the following functionality using Hudi’s implicit indexing.</p>

<table>
  <tbody>
    <tr>
      <td><strong>API</strong></td>
      <td><strong>Description</strong></td>
    </tr>
    <tr>
      <td>read(keys)</td>
      <td>Read out the data corresponding to the keys as a DataFrame, using Hudi’s own index for faster lookup</td>
    </tr>
    <tr>
      <td>filterExists()</td>
      <td>Filter out already existing records from the provided RDD[HoodieRecord]. Useful for de-duplication</td>
    </tr>
    <tr>
      <td>checkExists(keys)</td>
      <td>Check if the provided keys exist in a Hudi dataset</td>
    </tr>
  </tbody>
</table>

<h2 id="presto">Presto</h2>

<p>Presto is a popular query engine, providing interactive query performance. Hudi RO tables can be queries seamlessly in Presto. 
This requires the <code class="highlighter-rouge">hoodie-presto-bundle</code> jar to be placed into <code class="highlighter-rouge">&lt;presto_install&gt;/plugin/hive-hadoop2/</code>, across the installation.</p>


    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                  <p>
                  Copyright &copy; <span id="copyright-year">2019</span> <a href="https://apache.org">The Apache Software Foundation</a>,
                  Licensed under the Apache License, Version 2.0<br>
                  Apache and the Apache feather logo are trademarks of The Apache Software Foundation.| <a href="/privacy">Privacy Policy</a><br>
                  <a class="footer-link-img" href="https://apache.org">
                    <img src="images/asf_logo.svg" alt="The Apache Software Foundation" height="100px" widh="50px"></a>
                  </p>
                  <p>
                  Apache Hudi is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the <a href="http://incubator.apache.org/">Apache Incubator</a>.
                  Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have
                  stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a
                  reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
                  </p>
                </div>
                <div class="col-lg-12 footer">
                  <div class="ui link list">
                    <a class="item" rel="external" href="https://incubator.apache.org/"> Apache Incubator </a>
                    <a class="item" rel="external" href="https://www.apache.org/"> About the ASF </a>
                    <a class="item" rel="external" href="https://www.apache.org/events/current-event"> Events </a>
                    <a class="item" rel="external" href="https://www.apache.org/foundation/thanks.html"> Thanks </a>
                    <a class="item" rel="external" href="https://www.apache.org/foundation/sponsorship.html"> Become a Sponsor </a>
                    <a class="item" rel="external" href="https://www.apache.org/security/"> Security </a>
                    <a class="item" rel="external" href="https://www.apache.org/licenses/"> License </a>
                  </div>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>