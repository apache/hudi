<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Docker Demo - Apache Hudi</title>
<meta name="description" content="A Demo using docker containers">

<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="Docker Demo">
<meta property="og:url" content="https://hudi.apache.org/docs/0.5.0-docker_demo.html">


  <meta property="og:description" content="A Demo using docker containers">





  <meta property="article:modified_time" content="2019-12-30T14:59:57-05:00">







<!-- end _includes/seo.html -->


<!--<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">-->

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



<link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
<link rel="stylesheet" href="/assets/css/font-awesome.min.css">

  </head>

  <body class="layout--single">
    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap" id="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/">
              <div style="width: 150px; height: 40px">
              </div>
          </a>
        
        <a class="site-title" href="/">
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/docs/quick-start-guide.html" target="_self" >Documentation</a>
            </li><li class="masthead__menu-item">
              <a href="/community.html" target="_self" >Community</a>
            </li><li class="masthead__menu-item">
              <a href="/blog.html" target="_self" >Blog</a>
            </li><li class="masthead__menu-item">
              <a href="https://cwiki.apache.org/confluence/display/HUDI/FAQ" target="_blank" >FAQ</a>
            </li><li class="masthead__menu-item">
              <a href="/releases.html" target="_self" >Releases</a>
            </li></ul>
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
<!--
<p class="notice--warning" style="margin: 0 !important; text-align: center !important;"><strong>Note:</strong> This site is work in progress, if you notice any issues, please <a target="_blank" href="https://github.com/apache/hudi/issues">Report on Issue</a>.
  Click <a href="/"> here</a> back to old site.</p>
-->

    <div class="initial-content">
      <div id="main" role="main">
  

  <div class="sidebar sticky">

  

  

    
      







<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Getting Started</span>
        

        
        <ul>
          
            
            

            
            

            
              <li><a href="/docs/0.5.0-quick-start-guide.html" class="">Quick Start</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-use_cases.html" class="">Use Cases</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-powered_by.html" class="">Talks & Powered By</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-comparison.html" class="">Comparison</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-docker_demo.html" class="active">Docker Demo</a></li>
            

          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Documentation</span>
        

        
        <ul>
          
            
            

            
            

            
              <li><a href="/docs/0.5.0-concepts.html" class="">Concepts</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-writing_data.html" class="">Writing Data</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-querying_data.html" class="">Querying Data</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-configurations.html" class="">Configuration</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-performance.html" class="">Performance</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-admin_guide.html" class="">Administering</a></li>
            

          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">INFO</span>
        

        
        <ul>
          
            
            

            
            

            
              <li><a href="/docs/0.5.0-docs-versions.html" class="">Docs Versions</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.5.0-privacy.html" class="">Privacy Policy</a></li>
            

          
        </ul>
        
      </li>
    
  </ul>
</nav>
    

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <!-- Look the author details up from the site config. -->
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Docker Demo
</h1>
          <!-- Output author details if some exist. -->
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <aside class="sidebar__right sticky">
          <nav class="toc">
            <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> IN THIS PAGE</h4></header>
            <ul class="toc__menu">
  <li><a href="#a-demo-using-docker-containers">A Demo using docker containers</a>
    <ul>
      <li><a href="#prerequisites">Prerequisites</a></li>
    </ul>
  </li>
  <li><a href="#setting-up-docker-cluster">Setting up Docker Cluster</a>
    <ul>
      <li><a href="#build-hudi">Build Hudi</a></li>
      <li><a href="#bringing-up-demo-cluster">Bringing up Demo Cluster</a></li>
    </ul>
  </li>
  <li><a href="#demo">Demo</a>
    <ul>
      <li><a href="#step-1--publish-the-first-batch-to-kafka">Step 1 : Publish the first batch to Kafka</a></li>
      <li><a href="#step-2-incrementally-ingest-data-from-kafka-topic">Step 2: Incrementally ingest data from Kafka topic</a></li>
      <li><a href="#step-3-sync-with-hive">Step 3: Sync with Hive</a></li>
      <li><a href="#step-4-a-run-hive-queries">Step 4 (a): Run Hive Queries</a></li>
      <li><a href="#step-4-b-run-spark-sql-queries">Step 4 (b): Run Spark-SQL Queries</a></li>
      <li><a href="#step-4-c-run-presto-queries">Step 4 (c): Run Presto Queries</a></li>
      <li><a href="#step-5-upload-second-batch-to-kafka-and-run-deltastreamer-to-ingest">Step 5: Upload second batch to Kafka and run DeltaStreamer to ingest</a></li>
      <li><a href="#step-6a-run-hive-queries">Step 6(a): Run Hive Queries</a></li>
      <li><a href="#step-6b-run-spark-sql-queries">Step 6(b): Run Spark SQL Queries</a></li>
      <li><a href="#step-6c-run-presto-queries">Step 6(c): Run Presto Queries</a></li>
      <li><a href="#step-7--incremental-query-for-copy-on-write-table">Step 7 : Incremental Query for COPY-ON-WRITE Table</a></li>
      <li><a href="#incremental-query-with-spark-sql">Incremental Query with Spark SQL:</a></li>
      <li><a href="#step-8-schedule-and-run-compaction-for-merge-on-read-dataset">Step 8: Schedule and Run Compaction for Merge-On-Read dataset</a></li>
      <li><a href="#step-9-run-hive-queries-including-incremental-queries">Step 9: Run Hive Queries including incremental queries</a></li>
      <li><a href="#step-10-read-optimized-and-realtime-views-for-mor-with-spark-sql-after-compaction">Step 10: Read Optimized and Realtime Views for MOR with Spark-SQL after compaction</a></li>
      <li><a href="#step-11--presto-queries-over-read-optimized-view-on-mor-dataset-after-compaction">Step 11:  Presto queries over Read Optimized View on MOR dataset after compaction</a></li>
    </ul>
  </li>
  <li><a href="#testing-hudi-in-local-docker-environment">Testing Hudi in Local Docker environment</a>
    <ul>
      <li><a href="#building-local-docker-containers">Building Local Docker Containers:</a></li>
    </ul>
  </li>
</ul>
          </nav>
        </aside>
        
        <h2 id="a-demo-using-docker-containers">A Demo using docker containers</h2>

<p>Lets use a real world example to see how hudi works end to end. For this purpose, a self contained
data infrastructure is brought up in a local docker cluster within your computer.</p>

<p>The steps have been tested on a Mac laptop</p>

<h3 id="prerequisites">Prerequisites</h3>

<ul>
  <li>Docker Setup :  For Mac, Please follow the steps as defined in [https://docs.docker.com/v17.12/docker-for-mac/install/]. For running Spark-SQL queries, please ensure atleast 6 GB and 4 CPUs are allocated to Docker (See Docker -&gt; Preferences -&gt; Advanced). Otherwise, spark-SQL queries could be killed because of memory issues.</li>
  <li>kafkacat : A command-line utility to publish/consume from kafka topics. Use <code class="highlighter-rouge">brew install kafkacat</code> to install kafkacat</li>
  <li>/etc/hosts : The demo references many services running in container by the hostname. Add the following settings to /etc/hosts</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">namenode</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">datanode1</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">hiveserver</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">hivemetastore</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">kafkabroker</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">sparkmaster</span>
   <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">zookeeper</span>
</code></pre></div></div>

<p>Also, this has not been tested on some environments like Docker on Windows.</p>

<h2 id="setting-up-docker-cluster">Setting up Docker Cluster</h2>

<h3 id="build-hudi">Build Hudi</h3>

<p>The first step is to build hudi</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span> <span class="o">&lt;</span><span class="no">HUDI_WORKSPACE</span><span class="o">&gt;</span>
<span class="n">mvn</span> <span class="kn">package</span> <span class="o">-</span><span class="nc">DskipTests</span>
</code></pre></div></div>

<h3 id="bringing-up-demo-cluster">Bringing up Demo Cluster</h3>

<p>The next step is to run the docker compose script and setup configs for bringing up the cluster.
This should pull the docker images from docker hub and setup docker cluster.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span> <span class="n">docker</span>
<span class="o">./</span><span class="n">setup_demo</span><span class="o">.</span><span class="na">sh</span>
<span class="o">....</span>
<span class="o">....</span>
<span class="o">....</span>
<span class="nc">Stopping</span> <span class="n">spark</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span>            <span class="o">...</span> <span class="n">done</span>
<span class="nc">Stopping</span> <span class="n">hiveserver</span>                <span class="o">...</span> <span class="n">done</span>
<span class="nc">Stopping</span> <span class="n">hivemetastore</span>             <span class="o">...</span> <span class="n">done</span>
<span class="nc">Stopping</span> <span class="n">historyserver</span>             <span class="o">...</span> <span class="n">done</span>
<span class="o">.......</span>
<span class="o">......</span>
<span class="nc">Creating</span> <span class="n">network</span> <span class="s">"hudi_demo"</span> <span class="n">with</span> <span class="n">the</span> <span class="k">default</span> <span class="n">driver</span>
<span class="nc">Creating</span> <span class="n">hive</span><span class="o">-</span><span class="n">metastore</span><span class="o">-</span><span class="n">postgresql</span> <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">namenode</span>                  <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">zookeeper</span>                 <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">kafkabroker</span>               <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">hivemetastore</span>             <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">historyserver</span>             <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">hiveserver</span>                <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">datanode1</span>                 <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">presto</span><span class="o">-</span><span class="n">coordinator</span><span class="o">-</span><span class="mi">1</span>      <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">sparkmaster</span>               <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">presto</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span>           <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span>                   <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span>                   <span class="o">...</span> <span class="n">done</span>
<span class="nc">Creating</span> <span class="n">spark</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span>            <span class="o">...</span> <span class="n">done</span>
<span class="nc">Copying</span> <span class="n">spark</span> <span class="k">default</span> <span class="n">config</span> <span class="n">and</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">configs</span>
<span class="nc">Copying</span> <span class="n">spark</span> <span class="k">default</span> <span class="n">config</span> <span class="n">and</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">configs</span>
<span class="nc">Copying</span> <span class="n">spark</span> <span class="k">default</span> <span class="n">config</span> <span class="n">and</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">configs</span>
<span class="err">$</span> <span class="n">docker</span> <span class="n">ps</span>
</code></pre></div></div>

<p>At this point, the docker cluster will be up and running. The demo cluster brings up the following services</p>

<ul>
  <li>HDFS Services (NameNode, DataNode)</li>
  <li>Spark Master and Worker</li>
  <li>Hive Services (Metastore, HiveServer2 along with PostgresDB)</li>
  <li>Kafka Broker and a Zookeeper Node (Kakfa will be used as upstream source for the demo)</li>
  <li>Adhoc containers to run Hudi/Hive CLI commands</li>
</ul>

<h2 id="demo">Demo</h2>

<p>Stock Tracker data will be used to showcase both different Hudi Views and the effects of Compaction.</p>

<p>Take a look at the directory <code class="highlighter-rouge">docker/demo/data</code>. There are 2 batches of stock data - each at 1 minute granularity.
The first batch contains stocker tracker data for some stock symbols during the first hour of trading window
(9:30 a.m to 10:30 a.m). The second batch contains tracker data for next 30 mins (10:30 - 11 a.m). Hudi will
be used to ingest these batches to a dataset which will contain the latest stock tracker data at hour level granularity.
The batches are windowed intentionally so that the second batch contains updates to some of the rows in the first batch.</p>

<h3 id="step-1--publish-the-first-batch-to-kafka">Step 1 : Publish the first batch to Kafka</h3>

<p>Upload the first batch to Kafka topic ‘stock ticks’ <code class="highlighter-rouge">cat docker/demo/data/batch_1.json | kafkacat -b kafkabroker -t stock_ticks -P</code></p>

<p>To check if the new topic shows up, use</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kafkacat</span> <span class="o">-</span><span class="n">b</span> <span class="n">kafkabroker</span> <span class="o">-</span><span class="no">L</span> <span class="o">-</span><span class="no">J</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
<span class="o">{</span>
  <span class="s">"originating_broker"</span><span class="o">:</span> <span class="o">{</span>
    <span class="s">"id"</span><span class="o">:</span> <span class="mi">1001</span><span class="o">,</span>
    <span class="s">"name"</span><span class="o">:</span> <span class="s">"kafkabroker:9092/1001"</span>
  <span class="o">},</span>
  <span class="s">"query"</span><span class="o">:</span> <span class="o">{</span>
    <span class="s">"topic"</span><span class="o">:</span> <span class="s">"*"</span>
  <span class="o">},</span>
  <span class="s">"brokers"</span><span class="o">:</span> <span class="o">[</span>
    <span class="o">{</span>
      <span class="s">"id"</span><span class="o">:</span> <span class="mi">1001</span><span class="o">,</span>
      <span class="s">"name"</span><span class="o">:</span> <span class="s">"kafkabroker:9092"</span>
    <span class="o">}</span>
  <span class="o">],</span>
  <span class="s">"topics"</span><span class="o">:</span> <span class="o">[</span>
    <span class="o">{</span>
      <span class="s">"topic"</span><span class="o">:</span> <span class="s">"stock_ticks"</span><span class="o">,</span>
      <span class="s">"partitions"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
          <span class="s">"partition"</span><span class="o">:</span> <span class="mi">0</span><span class="o">,</span>
          <span class="s">"leader"</span><span class="o">:</span> <span class="mi">1001</span><span class="o">,</span>
          <span class="s">"replicas"</span><span class="o">:</span> <span class="o">[</span>
            <span class="o">{</span>
              <span class="s">"id"</span><span class="o">:</span> <span class="mi">1001</span>
            <span class="o">}</span>
          <span class="o">],</span>
          <span class="s">"isrs"</span><span class="o">:</span> <span class="o">[</span>
            <span class="o">{</span>
              <span class="s">"id"</span><span class="o">:</span> <span class="mi">1001</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="step-2-incrementally-ingest-data-from-kafka-topic">Step 2: Incrementally ingest data from Kafka topic</h3>

<p>Hudi comes with a tool named DeltaStreamer. This tool can connect to variety of data sources (including Kafka) to
pull changes and apply to Hudi dataset using upsert/insert primitives. Here, we will use the tool to download
json data from kafka topic and ingest to both COW and MOR tables we initialized in the previous step. This tool
automatically initializes the datasets in the file-system if they do not exist yet.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="err">#</span> <span class="nc">Run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="n">command</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">delta</span><span class="o">-</span><span class="n">streamer</span> <span class="n">and</span> <span class="n">ingest</span> <span class="n">to</span> <span class="n">stock_ticks_cow</span> <span class="n">dataset</span> <span class="n">in</span> <span class="no">HDFS</span>
<span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">deltastreamer</span><span class="o">.</span><span class="na">HoodieDeltaStreamer</span> <span class="n">$HUDI_UTILITIES_BUNDLE</span> <span class="o">--</span><span class="n">storage</span><span class="o">-</span><span class="n">type</span> <span class="no">COPY_ON_WRITE</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">sources</span><span class="o">.</span><span class="na">JsonKafkaSource</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">ordering</span><span class="o">-</span><span class="n">field</span> <span class="n">ts</span>  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_cow</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">table</span> <span class="n">stock_ticks_cow</span> <span class="o">--</span><span class="n">props</span> <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="n">source</span><span class="o">.</span><span class="na">properties</span> <span class="o">--</span><span class="n">schemaprovider</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">FilebasedSchemaProvider</span>


<span class="err">#</span> <span class="nc">Run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="n">command</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">delta</span><span class="o">-</span><span class="n">streamer</span> <span class="n">and</span> <span class="n">ingest</span> <span class="n">to</span> <span class="n">stock_ticks_mor</span> <span class="n">dataset</span> <span class="n">in</span> <span class="no">HDFS</span>
<span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">deltastreamer</span><span class="o">.</span><span class="na">HoodieDeltaStreamer</span> <span class="n">$HUDI_UTILITIES_BUNDLE</span> <span class="o">--</span><span class="n">storage</span><span class="o">-</span><span class="n">type</span> <span class="no">MERGE_ON_READ</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">sources</span><span class="o">.</span><span class="na">JsonKafkaSource</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">ordering</span><span class="o">-</span><span class="n">field</span> <span class="n">ts</span>  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">table</span> <span class="n">stock_ticks_mor</span> <span class="o">--</span><span class="n">props</span> <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="n">source</span><span class="o">.</span><span class="na">properties</span> <span class="o">--</span><span class="n">schemaprovider</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">FilebasedSchemaProvider</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">compaction</span>


<span class="err">#</span> <span class="nc">As</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="nf">setup</span> <span class="o">(</span><span class="nc">Look</span> <span class="n">at</span> <span class="n">setup_demo</span><span class="o">.</span><span class="na">sh</span><span class="o">),</span> <span class="n">the</span> <span class="n">configs</span> <span class="n">needed</span> <span class="k">for</span> <span class="nc">DeltaStreamer</span> <span class="n">is</span> <span class="n">uploaded</span> <span class="n">to</span> <span class="no">HDFS</span><span class="o">.</span> <span class="nc">The</span> <span class="n">configs</span>
<span class="err">#</span> <span class="n">contain</span> <span class="n">mostly</span> <span class="nc">Kafa</span> <span class="n">connectivity</span> <span class="n">settings</span><span class="o">,</span> <span class="n">the</span> <span class="n">avro</span><span class="o">-</span><span class="n">schema</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">ingesting</span> <span class="n">along</span> <span class="n">with</span> <span class="n">key</span> <span class="n">and</span> <span class="n">partitioning</span> <span class="n">fields</span><span class="o">.</span>

<span class="n">exit</span>
</code></pre></div></div>

<p>You can use HDFS web-browser to look at the datasets
<code class="highlighter-rouge">http://namenode:50070/explorer.html#/user/hive/warehouse/stock_ticks_cow</code>.</p>

<p>You can explore the new partition folder created in the dataset along with a “deltacommit”
file under .hoodie which signals a successful commit.</p>

<p>There will be a similar setup when you browse the MOR dataset
<code class="highlighter-rouge">http://namenode:50070/explorer.html#/user/hive/warehouse/stock_ticks_mor</code></p>

<h3 id="step-3-sync-with-hive">Step 3: Sync with Hive</h3>

<p>At this step, the datasets are available in HDFS. We need to sync with Hive to create new Hive tables and add partitions
inorder to run Hive queries against those datasets.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="err">#</span> <span class="nc">THis</span> <span class="n">command</span> <span class="n">takes</span> <span class="n">in</span> <span class="nc">HIveServer</span> <span class="no">URL</span> <span class="n">and</span> <span class="no">COW</span> <span class="nc">Hudi</span> <span class="nc">Dataset</span> <span class="n">location</span> <span class="n">in</span> <span class="no">HDFS</span> <span class="n">and</span> <span class="n">sync</span> <span class="n">the</span> <span class="no">HDFS</span> <span class="n">state</span> <span class="n">to</span> <span class="nc">Hive</span>
<span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">hoodie</span><span class="o">/</span><span class="n">ws</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">hive</span><span class="o">/</span><span class="n">run_sync_tool</span><span class="o">.</span><span class="na">sh</span>  <span class="o">--</span><span class="n">jdbc</span><span class="o">-</span><span class="n">url</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --user hive --pass hive --partitioned-by dt --base-path /user/hive/warehouse/stock_ticks_cow --database default --table stock_ticks_cow</span>
<span class="o">.....</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">24</span> <span class="mi">22</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="mi">45</span><span class="o">,</span><span class="mi">568</span> <span class="no">INFO</span>  <span class="o">[</span><span class="n">main</span><span class="o">]</span> <span class="n">hive</span><span class="o">.</span><span class="na">HiveSyncTool</span> <span class="o">(</span><span class="nc">HiveSyncTool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">syncHoodieTable</span><span class="o">(</span><span class="mi">112</span><span class="o">))</span> <span class="o">-</span> <span class="nc">Sync</span> <span class="n">complete</span> <span class="k">for</span> <span class="n">stock_ticks_cow</span>
<span class="o">.....</span>

<span class="err">#</span> <span class="nc">Now</span> <span class="n">run</span> <span class="n">hive</span><span class="o">-</span><span class="n">sync</span> <span class="k">for</span> <span class="n">the</span> <span class="n">second</span> <span class="n">data</span><span class="o">-</span><span class="n">set</span> <span class="n">in</span> <span class="no">HDFS</span> <span class="n">using</span> <span class="nc">Merge</span><span class="o">-</span><span class="nc">On</span><span class="o">-</span><span class="nc">Read</span> <span class="o">(</span><span class="no">MOR</span> <span class="n">storage</span><span class="o">)</span>
<span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">hoodie</span><span class="o">/</span><span class="n">ws</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">hive</span><span class="o">/</span><span class="n">run_sync_tool</span><span class="o">.</span><span class="na">sh</span>  <span class="o">--</span><span class="n">jdbc</span><span class="o">-</span><span class="n">url</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --user hive --pass hive --partitioned-by dt --base-path /user/hive/warehouse/stock_ticks_mor --database default --table stock_ticks_mor</span>
<span class="o">...</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">24</span> <span class="mi">22</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">09</span><span class="o">,</span><span class="mi">171</span> <span class="no">INFO</span>  <span class="o">[</span><span class="n">main</span><span class="o">]</span> <span class="n">hive</span><span class="o">.</span><span class="na">HiveSyncTool</span> <span class="o">(</span><span class="nc">HiveSyncTool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">syncHoodieTable</span><span class="o">(</span><span class="mi">112</span><span class="o">))</span> <span class="o">-</span> <span class="nc">Sync</span> <span class="n">complete</span> <span class="k">for</span> <span class="n">stock_ticks_mor</span>
<span class="o">...</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">24</span> <span class="mi">22</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">09</span><span class="o">,</span><span class="mi">559</span> <span class="no">INFO</span>  <span class="o">[</span><span class="n">main</span><span class="o">]</span> <span class="n">hive</span><span class="o">.</span><span class="na">HiveSyncTool</span> <span class="o">(</span><span class="nc">HiveSyncTool</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">syncHoodieTable</span><span class="o">(</span><span class="mi">112</span><span class="o">))</span> <span class="o">-</span> <span class="nc">Sync</span> <span class="n">complete</span> <span class="k">for</span> <span class="n">stock_ticks_mor_rt</span>
<span class="o">....</span>
<span class="n">exit</span>
</code></pre></div></div>
<p>After executing the above command, you will notice</p>

<ol>
  <li>A hive table named <code class="highlighter-rouge">stock_ticks_cow</code> created which provides Read-Optimized view for the Copy On Write dataset.</li>
  <li>Two new tables <code class="highlighter-rouge">stock_ticks_mor</code> and <code class="highlighter-rouge">stock_ticks_mor_rt</code> created for the Merge On Read dataset. The former
provides the ReadOptimized view for the Hudi dataset and the later provides the realtime-view for the dataset.</li>
</ol>

<h3 id="step-4-a-run-hive-queries">Step 4 (a): Run Hive Queries</h3>

<p>Run a hive query to find the latest timestamp ingested for stock symbol ‘GOOG’. You will notice that both read-optimized
(for both COW and MOR dataset)and realtime views (for MOR dataset)give the same value “10:29 a.m” as Hudi create a
parquet file for the first batch of data.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">beeline</span> <span class="o">-</span><span class="n">u</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --hiveconf hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat --hiveconf hive.stats.autogather=false</span>
<span class="err">#</span> <span class="nc">List</span> <span class="nc">Tables</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; show tables;</span>
<span class="o">+---------------------+--+</span>
<span class="o">|</span>      <span class="n">tab_name</span>       <span class="o">|</span>
<span class="o">+---------------------+--+</span>
<span class="o">|</span> <span class="n">stock_ticks_cow</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">stock_ticks_mor</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">stock_ticks_mor_rt</span>  <span class="o">|</span>
<span class="o">+---------------------+--+</span>
<span class="mi">2</span> <span class="n">rows</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">0.801</span> <span class="n">seconds</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt;</span>


<span class="err">#</span> <span class="nc">Look</span> <span class="n">at</span> <span class="n">partitions</span> <span class="n">that</span> <span class="n">were</span> <span class="n">added</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; show partitions stock_ticks_mor_rt;</span>
<span class="o">+----------------+--+</span>
<span class="o">|</span>   <span class="n">partition</span>    <span class="o">|</span>
<span class="o">+----------------+--+</span>
<span class="o">|</span> <span class="n">dt</span><span class="o">=</span><span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span>  <span class="o">|</span>
<span class="o">+----------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">0.24</span> <span class="n">seconds</span><span class="o">)</span>


<span class="err">#</span> <span class="no">COPY</span><span class="o">-</span><span class="no">ON</span><span class="o">-</span><span class="no">WRITE</span> <span class="nl">Queries:</span>
<span class="o">=========================</span>


<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_cow group by symbol HAVING symbol = 'GOOG';</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>

<span class="nc">Now</span><span class="o">,</span> <span class="n">run</span> <span class="n">a</span> <span class="n">projection</span> <span class="nl">query:</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_cow where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924221953</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924221953</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">3391</span>    <span class="o">|</span> <span class="mf">1230.1899</span>  <span class="o">|</span> <span class="mf">1230.085</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>


<span class="err">#</span> <span class="nc">Merge</span><span class="o">-</span><span class="nc">On</span><span class="o">-</span><span class="nc">Read</span> <span class="nl">Queries:</span>
<span class="o">==========================</span>

<span class="nc">Lets</span> <span class="n">run</span> <span class="n">similar</span> <span class="n">queries</span> <span class="n">against</span> <span class="no">M</span><span class="o">-</span><span class="no">O</span><span class="o">-</span><span class="no">R</span> <span class="n">dataset</span><span class="o">.</span> <span class="nc">Lets</span> <span class="n">look</span> <span class="n">at</span> <span class="n">both</span>
<span class="nc">ReadOptimized</span> <span class="n">and</span> <span class="nc">Realtime</span> <span class="n">views</span> <span class="n">supported</span> <span class="n">by</span> <span class="no">M</span><span class="o">-</span><span class="no">O</span><span class="o">-</span><span class="no">R</span> <span class="n">dataset</span>

<span class="err">#</span> <span class="nc">Run</span> <span class="n">against</span> <span class="nc">ReadOptimized</span> <span class="nc">View</span><span class="o">.</span> <span class="nc">Notice</span> <span class="n">that</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">timestamp</span> <span class="n">is</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">6.326</span> <span class="n">seconds</span><span class="o">)</span>


<span class="err">#</span> <span class="nc">Run</span> <span class="n">against</span> <span class="nc">Realtime</span> <span class="nc">View</span><span class="o">.</span> <span class="nc">Notice</span> <span class="n">that</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">timestamp</span> <span class="n">is</span> <span class="n">again</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor_rt group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.606</span> <span class="n">seconds</span><span class="o">)</span>


<span class="err">#</span> <span class="nc">Run</span> <span class="n">projection</span> <span class="n">query</span> <span class="n">against</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="n">and</span> <span class="nc">Realtime</span> <span class="n">tables</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">3391</span>    <span class="o">|</span> <span class="mf">1230.1899</span>  <span class="o">|</span> <span class="mf">1230.085</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor_rt where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">3391</span>    <span class="o">|</span> <span class="mf">1230.1899</span>  <span class="o">|</span> <span class="mf">1230.085</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="n">exit</span>
<span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-4-b-run-spark-sql-queries">Step 4 (b): Run Spark-SQL Queries</h3>
<p>Hudi support Spark as query processor just like Hive. Here are the same hive queries
running in spark-sql</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">$SPARK_INSTALL</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">spark</span><span class="o">-</span><span class="n">shell</span> <span class="o">--</span><span class="n">jars</span> <span class="n">$HUDI_SPARK_BUNDLE</span> <span class="o">--</span><span class="n">master</span> <span class="n">local</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="kd">class</span><span class="err">-</span><span class="nc">path</span> <span class="n">$HADOOP_CONF_DIR</span> <span class="o">--</span><span class="n">conf</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">hive</span><span class="o">.</span><span class="na">convertMetastoreParquet</span><span class="o">=</span><span class="kc">false</span> <span class="o">--</span><span class="n">deploy</span><span class="o">-</span><span class="n">mode</span> <span class="n">client</span>  <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">memory</span> <span class="mi">1</span><span class="no">G</span> <span class="o">--</span><span class="n">executor</span><span class="o">-</span><span class="n">memory</span> <span class="mi">3</span><span class="no">G</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">executors</span> <span class="mi">1</span>  <span class="o">--</span><span class="n">packages</span> <span class="n">com</span><span class="o">.</span><span class="na">databricks</span><span class="o">:</span><span class="n">spark</span><span class="o">-</span><span class="n">avro_2</span><span class="o">.</span><span class="mi">11</span><span class="o">:</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">0</span>
<span class="o">...</span>

<span class="nc">Welcome</span> <span class="n">to</span>
      <span class="n">____</span>              <span class="n">__</span>
     <span class="o">/</span> <span class="n">__</span><span class="o">/</span><span class="n">__</span>  <span class="n">___</span> <span class="n">_____</span><span class="o">/</span> <span class="o">/</span><span class="n">__</span>
    <span class="n">_</span><span class="err">\</span> <span class="err">\</span><span class="o">/</span> <span class="n">_</span> <span class="err">\</span><span class="o">/</span> <span class="n">_</span> <span class="err">`</span><span class="o">/</span> <span class="n">__</span><span class="o">/</span>  <span class="err">'</span><span class="n">_</span><span class="o">/</span>
   <span class="o">/</span><span class="n">___</span><span class="o">/</span> <span class="o">.</span><span class="na">__</span><span class="o">/</span><span class="err">\</span><span class="n">_</span><span class="o">,</span><span class="n">_</span><span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span><span class="err">\</span><span class="n">_</span><span class="err">\</span>   <span class="n">version</span> <span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span>
      <span class="o">/</span><span class="n">_</span><span class="o">/</span>

<span class="nc">Using</span> <span class="nc">Scala</span> <span class="n">version</span> <span class="mf">2.11</span><span class="o">.</span><span class="mi">8</span> <span class="o">(</span><span class="nc">Java</span> <span class="nf">HotSpot</span><span class="o">(</span><span class="no">TM</span><span class="o">)</span> <span class="mi">64</span><span class="o">-</span><span class="nc">Bit</span> <span class="nc">Server</span> <span class="no">VM</span><span class="o">,</span> <span class="nc">Java</span> <span class="mf">1.8</span><span class="o">.</span><span class="mi">0_181</span><span class="o">)</span>
<span class="nc">Type</span> <span class="n">in</span> <span class="n">expressions</span> <span class="n">to</span> <span class="n">have</span> <span class="n">them</span> <span class="n">evaluated</span><span class="o">.</span>
<span class="nc">Type</span> <span class="o">:</span><span class="n">help</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>

<span class="n">scala</span><span class="o">&gt;</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"show tables"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+--------+------------------+-----------+</span>
<span class="o">|</span><span class="n">database</span><span class="o">|</span><span class="n">tableName</span>         <span class="o">|</span><span class="n">isTemporary</span><span class="o">|</span>
<span class="o">+--------+------------------+-----------+</span>
<span class="o">|</span><span class="k">default</span> <span class="o">|</span><span class="n">stock_ticks_cow</span>   <span class="o">|</span><span class="kc">false</span>      <span class="o">|</span>
<span class="o">|</span><span class="k">default</span> <span class="o">|</span><span class="n">stock_ticks_mor</span>   <span class="o">|</span><span class="kc">false</span>      <span class="o">|</span>
<span class="o">|</span><span class="k">default</span> <span class="o">|</span><span class="n">stock_ticks_mor_rt</span><span class="o">|</span><span class="kc">false</span>      <span class="o">|</span>
<span class="o">+--------+------------------+-----------+</span>

<span class="err">#</span> <span class="nc">Copy</span><span class="o">-</span><span class="nc">On</span><span class="o">-</span><span class="nc">Write</span> <span class="nc">Table</span>

<span class="err">##</span> <span class="nc">Run</span> <span class="n">max</span> <span class="n">timestamp</span> <span class="n">query</span> <span class="n">against</span> <span class="no">COW</span> <span class="n">table</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_cow group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">[</span><span class="nc">Stage</span> <span class="mi">0</span><span class="o">:&gt;</span>                                                          <span class="o">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1</span><span class="o">]</span><span class="nl">SLF4J:</span> <span class="nc">Failed</span> <span class="n">to</span> <span class="n">load</span> <span class="kd">class</span> <span class="err">"</span><span class="nc">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">StaticLoggerBinder</span><span class="s">".
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
+------+-------------------+
|symbol|max(ts)            |
+------+-------------------+
|GOOG  |2018-08-31 10:29:00|
+------+-------------------+

## Projection Query

scala&gt; spark.sql("</span><span class="n">select</span> <span class="err">`</span><span class="n">_hoodie_commit_time</span><span class="err">`</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_cow</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="s">").show(100, false)
+-------------------+------+-------------------+------+---------+--------+
|_hoodie_commit_time|symbol|ts                 |volume|open     |close   |
+-------------------+------+-------------------+------+---------+--------+
|20180924221953     |GOOG  |2018-08-31 09:59:00|6330  |1230.5   |1230.02 |
|20180924221953     |GOOG  |2018-08-31 10:29:00|3391  |1230.1899|1230.085|
+-------------------+------+-------------------+------+---------+--------+

# Merge-On-Read Queries:
==========================

Lets run similar queries against M-O-R dataset. Lets look at both
ReadOptimized and Realtime views supported by M-O-R dataset

# Run against ReadOptimized View. Notice that the latest timestamp is 10:29
scala&gt; spark.sql("</span><span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="s">").show(100, false)
+------+-------------------+
|symbol|max(ts)            |
+------+-------------------+
|GOOG  |2018-08-31 10:29:00|
+------+-------------------+


# Run against Realtime View. Notice that the latest timestamp is again 10:29

scala&gt; spark.sql("</span><span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_mor_rt</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="s">").show(100, false)
+------+-------------------+
|symbol|max(ts)            |
+------+-------------------+
|GOOG  |2018-08-31 10:29:00|
+------+-------------------+

# Run projection query against Read Optimized and Realtime tables

scala&gt; spark.sql("</span><span class="n">select</span> <span class="err">`</span><span class="n">_hoodie_commit_time</span><span class="err">`</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="s">").show(100, false)
+-------------------+------+-------------------+------+---------+--------+
|_hoodie_commit_time|symbol|ts                 |volume|open     |close   |
+-------------------+------+-------------------+------+---------+--------+
|20180924222155     |GOOG  |2018-08-31 09:59:00|6330  |1230.5   |1230.02 |
|20180924222155     |GOOG  |2018-08-31 10:29:00|3391  |1230.1899|1230.085|
+-------------------+------+-------------------+------+---------+--------+

scala&gt; spark.sql("</span><span class="n">select</span> <span class="err">`</span><span class="n">_hoodie_commit_time</span><span class="err">`</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_mor_rt</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+-------------------+------+-------------------+------+---------+--------+</span>
<span class="o">|</span><span class="n">_hoodie_commit_time</span><span class="o">|</span><span class="n">symbol</span><span class="o">|</span><span class="n">ts</span>                 <span class="o">|</span><span class="n">volume</span><span class="o">|</span><span class="n">open</span>     <span class="o">|</span><span class="n">close</span>   <span class="o">|</span>
<span class="o">+-------------------+------+-------------------+------+---------+--------+</span>
<span class="o">|</span><span class="mi">20180924222155</span>     <span class="o">|</span><span class="no">GOOG</span>  <span class="o">|</span><span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span><span class="o">|</span><span class="mi">6330</span>  <span class="o">|</span><span class="mf">1230.5</span>   <span class="o">|</span><span class="mf">1230.02</span> <span class="o">|</span>
<span class="o">|</span><span class="mi">20180924222155</span>     <span class="o">|</span><span class="no">GOOG</span>  <span class="o">|</span><span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span><span class="o">|</span><span class="mi">3391</span>  <span class="o">|</span><span class="mf">1230.1899</span><span class="o">|</span><span class="mf">1230.085</span><span class="o">|</span>
<span class="o">+-------------------+------+-------------------+------+---------+--------+</span>

</code></pre></div></div>

<h3 id="step-4-c-run-presto-queries">Step 4 (c): Run Presto Queries</h3>

<p>Here are the Presto queries for similar Hive and Spark queries. Currently, Hudi does not support Presto queries on realtime views.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">presto</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span> <span class="n">presto</span> <span class="o">--</span><span class="n">server</span> <span class="n">presto</span><span class="o">-</span><span class="n">coordinator</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">8090</span>
<span class="n">presto</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">catalogs</span><span class="o">;</span>
  <span class="nc">Catalog</span>
<span class="o">-----------</span>
 <span class="n">hive</span>
 <span class="n">jmx</span>
 <span class="n">localfile</span>
 <span class="nf">system</span>
<span class="o">(</span><span class="mi">4</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190817_134851_00000</span><span class="n">_j8rcz</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">19</span> <span class="n">total</span><span class="o">,</span> <span class="mi">19</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">04</span> <span class="o">[</span><span class="mi">0</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">0</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">0</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">0</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="n">presto</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">hive</span><span class="o">.</span><span class="na">default</span><span class="o">;</span>
<span class="no">USE</span>
<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">tables</span><span class="o">;</span>
       <span class="nc">Table</span>
<span class="o">--------------------</span>
 <span class="n">stock_ticks_cow</span>
 <span class="n">stock_ticks_mor</span>
 <span class="nf">stock_ticks_mor_rt</span>
<span class="o">(</span><span class="mi">3</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181000_00001</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">2</span> <span class="n">nodes</span>
<span class="nl">Splits:</span> <span class="mi">19</span> <span class="n">total</span><span class="o">,</span> <span class="mi">19</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">05</span> <span class="o">[</span><span class="mi">3</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">99</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">0</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">18</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>


<span class="err">#</span> <span class="no">COPY</span><span class="o">-</span><span class="no">ON</span><span class="o">-</span><span class="no">WRITE</span> <span class="nl">Queries:</span>
<span class="o">=========================</span>


<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_cow</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">symbol</span> <span class="o">|</span>        <span class="n">_col1</span>
<span class="o">--------+---------------------</span>
 <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>
<span class="o">(</span><span class="mi">1</span> <span class="n">row</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181011_00002</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">49</span> <span class="n">total</span><span class="o">,</span> <span class="mi">49</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">12</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">16</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">50</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="s">"_hoodie_commit_time"</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span> <span class="n">from</span> <span class="n">stock_ticks_cow</span> <span class="n">where</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">_hoodie_commit_time</span> <span class="o">|</span> <span class="n">symbol</span> <span class="o">|</span>         <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span> <span class="o">|</span>   <span class="n">open</span>    <span class="o">|</span>  <span class="n">close</span>
<span class="o">---------------------+--------+---------------------+--------+-----------+----------</span>
 <span class="mi">20190822180221</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">6330</span> <span class="o">|</span>    <span class="mf">1230.5</span> <span class="o">|</span>  <span class="mf">1230.02</span>
 <span class="mi">20190822180221</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">3391</span> <span class="o">|</span> <span class="mf">1230.1899</span> <span class="o">|</span> <span class="mf">1230.085</span>
<span class="o">(</span><span class="mi">2</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181141_00003</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">17</span> <span class="n">total</span><span class="o">,</span> <span class="mi">17</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">109</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">341</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>


<span class="err">#</span> <span class="nc">Merge</span><span class="o">-</span><span class="nc">On</span><span class="o">-</span><span class="nc">Read</span> <span class="nl">Queries:</span>
<span class="o">==========================</span>

<span class="nc">Lets</span> <span class="n">run</span> <span class="n">similar</span> <span class="n">queries</span> <span class="n">against</span> <span class="no">M</span><span class="o">-</span><span class="no">O</span><span class="o">-</span><span class="no">R</span> <span class="n">dataset</span><span class="o">.</span> 

<span class="err">#</span> <span class="nc">Run</span> <span class="n">against</span> <span class="nc">ReadOptimized</span> <span class="nc">View</span><span class="o">.</span> <span class="nc">Notice</span> <span class="n">that</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">timestamp</span> <span class="n">is</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span>
<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">symbol</span> <span class="o">|</span>        <span class="n">_col1</span>
<span class="o">--------+---------------------</span>
 <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>
<span class="o">(</span><span class="mi">1</span> <span class="n">row</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181158_00004</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">49</span> <span class="n">total</span><span class="o">,</span> <span class="mi">49</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">110</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">343</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>


<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="s">"_hoodie_commit_time"</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">_hoodie_commit_time</span> <span class="o">|</span> <span class="n">symbol</span> <span class="o">|</span>         <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span> <span class="o">|</span>   <span class="n">open</span>    <span class="o">|</span>  <span class="n">close</span>
<span class="o">---------------------+--------+---------------------+--------+-----------+----------</span>
 <span class="mi">20190822180250</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">6330</span> <span class="o">|</span>    <span class="mf">1230.5</span> <span class="o">|</span>  <span class="mf">1230.02</span>
 <span class="mi">20190822180250</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">3391</span> <span class="o">|</span> <span class="mf">1230.1899</span> <span class="o">|</span> <span class="mf">1230.085</span>
<span class="o">(</span><span class="mi">2</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181256_00006</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">17</span> <span class="n">total</span><span class="o">,</span> <span class="mi">17</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">92</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">286</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-5-upload-second-batch-to-kafka-and-run-deltastreamer-to-ingest">Step 5: Upload second batch to Kafka and run DeltaStreamer to ingest</h3>

<p>Upload the second batch of data and ingest this batch using delta-streamer. As this batch does not bring in any new
partitions, there is no need to run hive-sync</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cat</span> <span class="n">docker</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">batch_2</span><span class="o">.</span><span class="na">json</span> <span class="o">|</span> <span class="n">kafkacat</span> <span class="o">-</span><span class="n">b</span> <span class="n">kafkabroker</span> <span class="o">-</span><span class="n">t</span> <span class="n">stock_ticks</span> <span class="o">-</span><span class="no">P</span>

<span class="err">#</span> <span class="nc">Within</span> <span class="nc">Docker</span> <span class="n">container</span><span class="o">,</span> <span class="n">run</span> <span class="n">the</span> <span class="n">ingestion</span> <span class="n">command</span>
<span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="err">#</span> <span class="nc">Run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="n">command</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">delta</span><span class="o">-</span><span class="n">streamer</span> <span class="n">and</span> <span class="n">ingest</span> <span class="n">to</span> <span class="n">stock_ticks_cow</span> <span class="n">dataset</span> <span class="n">in</span> <span class="no">HDFS</span>
<span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">deltastreamer</span><span class="o">.</span><span class="na">HoodieDeltaStreamer</span> <span class="n">$HUDI_UTILITIES_BUNDLE</span> <span class="o">--</span><span class="n">storage</span><span class="o">-</span><span class="n">type</span> <span class="no">COPY_ON_WRITE</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">sources</span><span class="o">.</span><span class="na">JsonKafkaSource</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">ordering</span><span class="o">-</span><span class="n">field</span> <span class="n">ts</span>  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_cow</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">table</span> <span class="n">stock_ticks_cow</span> <span class="o">--</span><span class="n">props</span> <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="n">source</span><span class="o">.</span><span class="na">properties</span> <span class="o">--</span><span class="n">schemaprovider</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">FilebasedSchemaProvider</span>


<span class="err">#</span> <span class="nc">Run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="n">command</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">delta</span><span class="o">-</span><span class="n">streamer</span> <span class="n">and</span> <span class="n">ingest</span> <span class="n">to</span> <span class="n">stock_ticks_mor</span> <span class="n">dataset</span> <span class="n">in</span> <span class="no">HDFS</span>
<span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">deltastreamer</span><span class="o">.</span><span class="na">HoodieDeltaStreamer</span> <span class="n">$HUDI_UTILITIES_BUNDLE</span> <span class="o">--</span><span class="n">storage</span><span class="o">-</span><span class="n">type</span> <span class="no">MERGE_ON_READ</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">sources</span><span class="o">.</span><span class="na">JsonKafkaSource</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">ordering</span><span class="o">-</span><span class="n">field</span> <span class="n">ts</span>  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">table</span> <span class="n">stock_ticks_mor</span> <span class="o">--</span><span class="n">props</span> <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">kafka</span><span class="o">-</span><span class="n">source</span><span class="o">.</span><span class="na">properties</span> <span class="o">--</span><span class="n">schemaprovider</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">FilebasedSchemaProvider</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">compaction</span>

<span class="n">exit</span>
</code></pre></div></div>

<p>With Copy-On-Write table, the second ingestion by DeltaStreamer resulted in a new version of Parquet file getting created.
See <code class="highlighter-rouge">http://namenode:50070/explorer.html#/user/hive/warehouse/stock_ticks_cow/2018/08/31</code></p>

<p>With Merge-On-Read table, the second ingestion merely appended the batch to an unmerged delta (log) file.
Take a look at the HDFS filesystem to get an idea: <code class="highlighter-rouge">http://namenode:50070/explorer.html#/user/hive/warehouse/stock_ticks_mor/2018/08/31</code></p>

<h3 id="step-6a-run-hive-queries">Step 6(a): Run Hive Queries</h3>

<p>With Copy-On-Write table, the read-optimized view immediately sees the changes as part of second batch once the batch
got committed as each ingestion creates newer versions of parquet files.</p>

<p>With Merge-On-Read table, the second ingestion merely appended the batch to an unmerged delta (log) file.
This is the time, when ReadOptimized and Realtime views will provide different results. ReadOptimized view will still
return “10:29 am” as it will only read from the Parquet file. Realtime View will do on-the-fly merge and return
latest committed data which is “10:59 a.m”.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">beeline</span> <span class="o">-</span><span class="n">u</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --hiveconf hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat --hiveconf hive.stats.autogather=false</span>

<span class="err">#</span> <span class="nc">Copy</span> <span class="nc">On</span> <span class="nc">Write</span> <span class="nl">Table:</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_cow group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.932</span> <span class="n">seconds</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_cow where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924221953</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924224524</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">notice</span><span class="o">,</span> <span class="n">the</span> <span class="n">above</span> <span class="n">queries</span> <span class="n">now</span> <span class="n">reflect</span> <span class="n">the</span> <span class="n">changes</span> <span class="n">that</span> <span class="n">came</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">ingesting</span> <span class="n">second</span> <span class="n">batch</span><span class="o">.</span>


<span class="err">#</span> <span class="nc">Merge</span> <span class="nc">On</span> <span class="nc">Read</span> <span class="nl">Table:</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.6</span> <span class="n">seconds</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">3391</span>    <span class="o">|</span> <span class="mf">1230.1899</span>  <span class="o">|</span> <span class="mf">1230.085</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="err">#</span> <span class="nc">Realtime</span> <span class="nc">View</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor_rt group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor_rt where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924224537</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="n">exit</span>
<span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-6b-run-spark-sql-queries">Step 6(b): Run Spark SQL Queries</h3>

<p>Running the same queries in Spark-SQL:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">4.4</span><span class="err">#</span> <span class="n">$SPARK_INSTALL</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">spark</span><span class="o">-</span><span class="n">shell</span> <span class="o">--</span><span class="n">jars</span> <span class="n">$HUDI_SPARK_BUNDLE</span> <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="kd">class</span><span class="err">-</span><span class="nc">path</span> <span class="n">$HADOOP_CONF_DIR</span> <span class="o">--</span><span class="n">conf</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">hive</span><span class="o">.</span><span class="na">convertMetastoreParquet</span><span class="o">=</span><span class="kc">false</span> <span class="o">--</span><span class="n">deploy</span><span class="o">-</span><span class="n">mode</span> <span class="n">client</span>  <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">memory</span> <span class="mi">1</span><span class="no">G</span> <span class="o">--</span><span class="n">master</span> <span class="n">local</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">--</span><span class="n">executor</span><span class="o">-</span><span class="n">memory</span> <span class="mi">3</span><span class="no">G</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">executors</span> <span class="mi">1</span>  <span class="o">--</span><span class="n">packages</span> <span class="n">com</span><span class="o">.</span><span class="na">databricks</span><span class="o">:</span><span class="n">spark</span><span class="o">-</span><span class="n">avro_2</span><span class="o">.</span><span class="mi">11</span><span class="o">:</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">0</span>

<span class="err">#</span> <span class="nc">Copy</span> <span class="nc">On</span> <span class="nc">Write</span> <span class="nl">Table:</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_cow group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+------+-------------------+</span>
<span class="o">|</span><span class="n">symbol</span><span class="o">|</span><span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span>            <span class="o">|</span>
<span class="o">+------+-------------------+</span>
<span class="o">|</span><span class="no">GOOG</span>  <span class="o">|</span><span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span><span class="o">|</span>
<span class="o">+------+-------------------+</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_cow where  symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924221953</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924224524</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">notice</span><span class="o">,</span> <span class="n">the</span> <span class="n">above</span> <span class="n">queries</span> <span class="n">now</span> <span class="n">reflect</span> <span class="n">the</span> <span class="n">changes</span> <span class="n">that</span> <span class="n">came</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">ingesting</span> <span class="n">second</span> <span class="n">batch</span><span class="o">.</span>


<span class="err">#</span> <span class="nc">Merge</span> <span class="nc">On</span> <span class="nc">Read</span> <span class="nl">Table:</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_mor group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.6</span> <span class="n">seconds</span><span class="o">)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">3391</span>    <span class="o">|</span> <span class="mf">1230.1899</span>  <span class="o">|</span> <span class="mf">1230.085</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="err">#</span> <span class="nc">Realtime</span> <span class="nc">View</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_mor_rt group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor_rt where  symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924222155</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924224537</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="n">exit</span>
<span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-6c-run-presto-queries">Step 6(c): Run Presto Queries</h3>

<p>Running the same queries on Presto for ReadOptimized views.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">presto</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span> <span class="n">presto</span> <span class="o">--</span><span class="n">server</span> <span class="n">presto</span><span class="o">-</span><span class="n">coordinator</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">8090</span>
<span class="n">presto</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">hive</span><span class="o">.</span><span class="na">default</span><span class="o">;</span>
<span class="no">USE</span>

<span class="err">#</span> <span class="nc">Copy</span> <span class="nc">On</span> <span class="nc">Write</span> <span class="nl">Table:</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span><span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_cow</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">symbol</span> <span class="o">|</span>        <span class="n">_col1</span>
<span class="o">--------+---------------------</span>
 <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>
<span class="o">(</span><span class="mi">1</span> <span class="n">row</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181530_00007</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">49</span> <span class="n">total</span><span class="o">,</span> <span class="mi">49</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">125</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">389</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span><span class="n">select</span> <span class="s">"_hoodie_commit_time"</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_cow</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">_hoodie_commit_time</span> <span class="o">|</span> <span class="n">symbol</span> <span class="o">|</span>         <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span> <span class="o">|</span>   <span class="n">open</span>    <span class="o">|</span>  <span class="n">close</span>
<span class="o">---------------------+--------+---------------------+--------+-----------+----------</span>
 <span class="mi">20190822180221</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">6330</span> <span class="o">|</span>    <span class="mf">1230.5</span> <span class="o">|</span>  <span class="mf">1230.02</span>
 <span class="mi">20190822181433</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">9021</span> <span class="o">|</span> <span class="mf">1227.1993</span> <span class="o">|</span> <span class="mf">1227.215</span>
<span class="o">(</span><span class="mi">2</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181545_00008</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">17</span> <span class="n">total</span><span class="o">,</span> <span class="mi">17</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">106</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">332</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nc">As</span> <span class="n">you</span> <span class="n">can</span> <span class="n">notice</span><span class="o">,</span> <span class="n">the</span> <span class="n">above</span> <span class="n">queries</span> <span class="n">now</span> <span class="n">reflect</span> <span class="n">the</span> <span class="n">changes</span> <span class="n">that</span> <span class="n">came</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">ingesting</span> <span class="n">second</span> <span class="n">batch</span><span class="o">.</span>


<span class="err">#</span> <span class="nc">Merge</span> <span class="nc">On</span> <span class="nc">Read</span> <span class="nl">Table:</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">symbol</span> <span class="o">|</span>        <span class="n">_col1</span>
<span class="o">--------+---------------------</span>
 <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span>
<span class="o">(</span><span class="mi">1</span> <span class="n">row</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181602_00009</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">49</span> <span class="n">total</span><span class="o">,</span> <span class="mi">49</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">01</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">139</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">435</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span><span class="n">select</span> <span class="s">"_hoodie_commit_time"</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">_hoodie_commit_time</span> <span class="o">|</span> <span class="n">symbol</span> <span class="o">|</span>         <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span> <span class="o">|</span>   <span class="n">open</span>    <span class="o">|</span>  <span class="n">close</span>
<span class="o">---------------------+--------+---------------------+--------+-----------+----------</span>
 <span class="mi">20190822180250</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">6330</span> <span class="o">|</span>    <span class="mf">1230.5</span> <span class="o">|</span>  <span class="mf">1230.02</span>
 <span class="mi">20190822180250</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">3391</span> <span class="o">|</span> <span class="mf">1230.1899</span> <span class="o">|</span> <span class="mf">1230.085</span>
<span class="o">(</span><span class="mi">2</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_181615_00010</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">17</span> <span class="n">total</span><span class="o">,</span> <span class="mi">17</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">01</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">154</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">480</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-7--incremental-query-for-copy-on-write-table">Step 7 : Incremental Query for COPY-ON-WRITE Table</h3>

<p>With 2 batches of data ingested, lets showcase the support for incremental queries in Hudi Copy-On-Write datasets</p>

<p>Lets take the same projection query example</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">beeline</span> <span class="o">-</span><span class="n">u</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --hiveconf hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat --hiveconf hive.stats.autogather=false</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_cow where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924064621</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924065039</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
</code></pre></div></div>

<p>As you notice from the above queries, there are 2 commits - 20180924064621 and 20180924065039 in timeline order.
When you follow the steps, you will be getting different timestamps for commits. Substitute them
in place of the above timestamps.</p>

<p>To show the effects of incremental-query, let us assume that a reader has already seen the changes as part of
ingesting first batch. Now, for the reader to see effect of the second batch, he/she has to keep the start timestamp to
the commit time of the first batch (20180924064621) and run incremental query</p>

<p>Hudi incremental mode provides efficient scanning for incremental queries by filtering out files that do not have any
candidate rows using hudi-managed metadata.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">beeline</span> <span class="o">-</span><span class="n">u</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --hiveconf hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat --hiveconf hive.stats.autogather=false</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; set hoodie.stock_ticks_cow.consume.mode=INCREMENTAL;</span>
<span class="nc">No</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="o">(</span><span class="mf">0.009</span> <span class="n">seconds</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt;  set hoodie.stock_ticks_cow.consume.max.commits=3;</span>
<span class="nc">No</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="o">(</span><span class="mf">0.009</span> <span class="n">seconds</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; set hoodie.stock_ticks_cow.consume.start.timestamp=20180924064621;</span>
</code></pre></div></div>

<p>With the above setting, file-ids that do not have any updates from the commit 20180924065039 is filtered out without scanning.
Here is the incremental query :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt;</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_cow where  symbol = 'GOOG' and `_hoodie_commit_time` &gt; '20180924064621';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924065039</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">0.83</span> <span class="n">seconds</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt;</span>
</code></pre></div></div>

<h3 id="incremental-query-with-spark-sql">Incremental Query with Spark SQL:</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">4.4</span><span class="err">#</span> <span class="n">$SPARK_INSTALL</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">spark</span><span class="o">-</span><span class="n">shell</span> <span class="o">--</span><span class="n">jars</span> <span class="n">$HUDI_SPARK_BUNDLE</span> <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="kd">class</span><span class="err">-</span><span class="nc">path</span> <span class="n">$HADOOP_CONF_DIR</span> <span class="o">--</span><span class="n">conf</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">hive</span><span class="o">.</span><span class="na">convertMetastoreParquet</span><span class="o">=</span><span class="kc">false</span> <span class="o">--</span><span class="n">deploy</span><span class="o">-</span><span class="n">mode</span> <span class="n">client</span>  <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">memory</span> <span class="mi">1</span><span class="no">G</span> <span class="o">--</span><span class="n">master</span> <span class="n">local</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">--</span><span class="n">executor</span><span class="o">-</span><span class="n">memory</span> <span class="mi">3</span><span class="no">G</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">executors</span> <span class="mi">1</span>  <span class="o">--</span><span class="n">packages</span> <span class="n">com</span><span class="o">.</span><span class="na">databricks</span><span class="o">:</span><span class="n">spark</span><span class="o">-</span><span class="n">avro_2</span><span class="o">.</span><span class="mi">11</span><span class="o">:</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">0</span>
<span class="nc">Welcome</span> <span class="n">to</span>
      <span class="n">____</span>              <span class="n">__</span>
     <span class="o">/</span> <span class="n">__</span><span class="o">/</span><span class="n">__</span>  <span class="n">___</span> <span class="n">_____</span><span class="o">/</span> <span class="o">/</span><span class="n">__</span>
    <span class="n">_</span><span class="err">\</span> <span class="err">\</span><span class="o">/</span> <span class="n">_</span> <span class="err">\</span><span class="o">/</span> <span class="n">_</span> <span class="err">`</span><span class="o">/</span> <span class="n">__</span><span class="o">/</span>  <span class="err">'</span><span class="n">_</span><span class="o">/</span>
   <span class="o">/</span><span class="n">___</span><span class="o">/</span> <span class="o">.</span><span class="na">__</span><span class="o">/</span><span class="err">\</span><span class="n">_</span><span class="o">,</span><span class="n">_</span><span class="o">/</span><span class="n">_</span><span class="o">/</span> <span class="o">/</span><span class="n">_</span><span class="o">/</span><span class="err">\</span><span class="n">_</span><span class="err">\</span>   <span class="n">version</span> <span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span>
      <span class="o">/</span><span class="n">_</span><span class="o">/</span>

<span class="nc">Using</span> <span class="nc">Scala</span> <span class="n">version</span> <span class="mf">2.11</span><span class="o">.</span><span class="mi">8</span> <span class="o">(</span><span class="nc">Java</span> <span class="nf">HotSpot</span><span class="o">(</span><span class="no">TM</span><span class="o">)</span> <span class="mi">64</span><span class="o">-</span><span class="nc">Bit</span> <span class="nc">Server</span> <span class="no">VM</span><span class="o">,</span> <span class="nc">Java</span> <span class="mf">1.8</span><span class="o">.</span><span class="mi">0_181</span><span class="o">)</span>
<span class="nc">Type</span> <span class="n">in</span> <span class="n">expressions</span> <span class="n">to</span> <span class="n">have</span> <span class="n">them</span> <span class="n">evaluated</span><span class="o">.</span>
<span class="nc">Type</span> <span class="o">:</span><span class="n">help</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="kn">import</span> <span class="nn">org.apache.hudi.DataSourceReadOptions</span>
<span class="kn">import</span> <span class="nn">org.apache.hudi.DataSourceReadOptions</span>

<span class="err">#</span> <span class="nc">In</span> <span class="n">the</span> <span class="n">below</span> <span class="n">query</span><span class="o">,</span> <span class="mi">20180925045257</span> <span class="n">is</span> <span class="n">the</span> <span class="n">first</span> <span class="n">commit</span><span class="err">'</span><span class="n">s</span> <span class="n">timestamp</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">val</span> <span class="n">hoodieIncViewDF</span> <span class="o">=</span>  <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"org.apache.hudi"</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="nc">DataSourceReadOptions</span><span class="o">.</span><span class="na">VIEW_TYPE_OPT_KEY</span><span class="o">,</span> <span class="nc">DataSourceReadOptions</span><span class="o">.</span><span class="na">VIEW_TYPE_INCREMENTAL_OPT_VAL</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="nc">DataSourceReadOptions</span><span class="o">.</span><span class="na">BEGIN_INSTANTTIME_OPT_KEY</span><span class="o">,</span> <span class="s">"20180924064621"</span><span class="o">).</span><span class="na">load</span><span class="o">(</span><span class="s">"/user/hive/warehouse/stock_ticks_cow"</span><span class="o">)</span>
<span class="nl">SLF4J:</span> <span class="nc">Failed</span> <span class="n">to</span> <span class="n">load</span> <span class="kd">class</span> <span class="err">"</span><span class="nc">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">StaticLoggerBinder</span><span class="s">".
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
hoodieIncViewDF: org.apache.spark.sql.DataFrame = [_hoodie_commit_time: string, _hoodie_commit_seqno: string ... 15 more fields]

scala&gt; hoodieIncViewDF.registerTempTable("</span><span class="n">stock_ticks_cow_incr_tmp1</span><span class="s">")
warning: there was one deprecation warning; re-run with -deprecation for details

scala&gt; spark.sql("</span><span class="n">select</span> <span class="err">`</span><span class="n">_hoodie_commit_time</span><span class="err">`</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_cow_incr_tmp1</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924065039</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

</code></pre></div></div>

<h3 id="step-8-schedule-and-run-compaction-for-merge-on-read-dataset">Step 8: Schedule and Run Compaction for Merge-On-Read dataset</h3>

<p>Lets schedule and run a compaction to create a new version of columnar  file so that read-optimized readers will see fresher data.
Again, You can use Hudi CLI to manually schedule and run compaction</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">root</span><span class="nd">@adhoc</span><span class="o">-</span><span class="mi">1</span><span class="o">:/</span><span class="n">opt</span><span class="err">#</span>   <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">hoodie</span><span class="o">/</span><span class="n">ws</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">cli</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">cli</span><span class="o">.</span><span class="na">sh</span>
<span class="o">============================================</span>
<span class="o">*</span>                                          <span class="o">*</span>
<span class="o">*</span>     <span class="n">_</span>    <span class="n">_</span>           <span class="n">_</span>   <span class="n">_</span>               <span class="o">*</span>
<span class="o">*</span>    <span class="o">|</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span>         <span class="o">|</span> <span class="o">|</span> <span class="o">(</span><span class="n">_</span><span class="o">)</span>              <span class="o">*</span>
<span class="o">*</span>    <span class="o">|</span> <span class="o">|</span><span class="n">__</span><span class="o">|</span> <span class="o">|</span>       <span class="n">__</span><span class="o">|</span> <span class="o">|</span>  <span class="o">-</span>               <span class="o">*</span>
<span class="o">*</span>    <span class="o">|</span>  <span class="n">__</span>  <span class="o">||</span>   <span class="o">|</span> <span class="o">/</span> <span class="n">_</span><span class="err">`</span> <span class="o">|</span> <span class="o">||</span>               <span class="o">*</span>
<span class="o">*</span>    <span class="o">|</span> <span class="o">|</span>  <span class="o">|</span> <span class="o">||</span>   <span class="o">||</span> <span class="o">(</span><span class="n">_</span><span class="o">|</span> <span class="o">|</span> <span class="o">||</span>               <span class="o">*</span>
<span class="o">*</span>    <span class="o">|</span><span class="n">_</span><span class="o">|</span>  <span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="err">\</span><span class="n">___</span><span class="o">/</span> <span class="err">\</span><span class="n">____</span><span class="o">/</span> <span class="o">||</span>               <span class="o">*</span>
<span class="o">*</span>                                          <span class="o">*</span>
<span class="o">============================================</span>

<span class="nc">Welcome</span> <span class="n">to</span> <span class="nc">Hoodie</span> <span class="no">CLI</span><span class="o">.</span> <span class="nc">Please</span> <span class="n">type</span> <span class="n">help</span> <span class="k">if</span> <span class="n">you</span> <span class="n">are</span> <span class="n">looking</span> <span class="k">for</span> <span class="n">help</span><span class="o">.</span>
<span class="n">hudi</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">34</span> <span class="no">WARN</span> <span class="n">util</span><span class="o">.</span><span class="na">NativeCodeLoader</span><span class="o">:</span> <span class="nc">Unable</span> <span class="n">to</span> <span class="n">load</span> <span class="kd">native</span><span class="o">-</span><span class="n">hadoop</span> <span class="n">library</span> <span class="k">for</span> <span class="n">your</span> <span class="n">platform</span><span class="o">...</span> <span class="n">using</span> <span class="n">builtin</span><span class="o">-</span><span class="n">java</span> <span class="n">classes</span> <span class="n">where</span> <span class="n">applicable</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">35</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Loading</span> <span class="nc">HoodieTableMetaClient</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">35</span> <span class="no">INFO</span> <span class="n">util</span><span class="o">.</span><span class="na">FSUtils</span><span class="o">:</span> <span class="nc">Hadoop</span> <span class="nl">Configuration:</span> <span class="n">fs</span><span class="o">.</span><span class="na">defaultFS</span><span class="o">:</span> <span class="o">[</span><span class="nl">hdfs:</span><span class="c1">//namenode:8020], Config:[Configuration: core-default.xml, core-site.xml, mapred-default.xml, mapred-site.xml, yarn-default.xml, yarn-site.xml, hdfs-default.xml, hdfs-site.xml], FileSystem: [DFS[DFSClient[clientName=DFSClient_NONMAPREDUCE_-1261652683_11, ugi=root (auth:SIMPLE)]]]</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">35</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableConfig</span><span class="o">:</span> <span class="nc">Loading</span> <span class="n">dataset</span> <span class="n">properties</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span><span class="o">/.</span><span class="na">hoodie</span><span class="o">/</span><span class="n">hoodie</span><span class="o">.</span><span class="na">properties</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">36</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Finished</span> <span class="nc">Loading</span> <span class="nc">Table</span> <span class="n">of</span> <span class="n">type</span> <span class="no">MERGE_ON_READ</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="nc">Metadata</span> <span class="k">for</span> <span class="n">table</span> <span class="n">stock_ticks_mor</span> <span class="n">loaded</span>

<span class="err">#</span> <span class="nc">Ensure</span> <span class="n">no</span> <span class="n">compactions</span> <span class="n">are</span> <span class="n">present</span>

<span class="nl">hoodie:</span><span class="n">stock_ticks_mor</span><span class="o">-&gt;</span><span class="n">compactions</span> <span class="n">show</span> <span class="n">all</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">54</span> <span class="no">INFO</span> <span class="n">timeline</span><span class="o">.</span><span class="na">HoodieActiveTimeline</span><span class="o">:</span> <span class="nc">Loaded</span> <span class="n">instants</span> <span class="o">[[</span><span class="mi">20180924064636</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924064636</span><span class="n">__deltacommit__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924065057</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924065057</span><span class="n">__deltacommit__COMPLETED</span><span class="o">]]</span>
    <span class="n">___________________________________________________________________</span>
    <span class="o">|</span> <span class="nc">Compaction</span> <span class="nc">Instant</span> <span class="nc">Time</span><span class="o">|</span> <span class="nc">State</span>    <span class="o">|</span> <span class="nc">Total</span> <span class="nc">FileIds</span> <span class="n">to</span> <span class="n">be</span> <span class="nc">Compacted</span><span class="o">|</span>
    <span class="o">|==================================================================|</span>




<span class="err">#</span> <span class="nc">Schedule</span> <span class="n">a</span> <span class="n">compaction</span><span class="o">.</span> <span class="nc">This</span> <span class="n">will</span> <span class="n">use</span> <span class="nc">Spark</span> <span class="nc">Launcher</span> <span class="n">to</span> <span class="n">schedule</span> <span class="n">compaction</span>
<span class="nl">hoodie:</span><span class="n">stock_ticks_mor</span><span class="o">-&gt;</span><span class="n">compaction</span> <span class="n">schedule</span>
<span class="o">....</span>
<span class="nc">Compaction</span> <span class="n">successfully</span> <span class="n">completed</span> <span class="k">for</span> <span class="mi">20180924070031</span>

<span class="err">#</span> <span class="nc">Now</span> <span class="n">refresh</span> <span class="n">and</span> <span class="n">check</span> <span class="n">again</span><span class="o">.</span> <span class="nc">You</span> <span class="n">will</span> <span class="n">see</span> <span class="n">that</span> <span class="n">there</span> <span class="n">is</span> <span class="n">a</span> <span class="k">new</span> <span class="n">compaction</span> <span class="n">requested</span>

<span class="nl">hoodie:</span><span class="n">stock_ticks</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mi">16</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Loading</span> <span class="nc">HoodieTableMetaClient</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mi">16</span> <span class="no">INFO</span> <span class="n">util</span><span class="o">.</span><span class="na">FSUtils</span><span class="o">:</span> <span class="nc">Hadoop</span> <span class="nl">Configuration:</span> <span class="n">fs</span><span class="o">.</span><span class="na">defaultFS</span><span class="o">:</span> <span class="o">[</span><span class="nl">hdfs:</span><span class="c1">//namenode:8020], Config:[Configuration: core-default.xml, core-site.xml, mapred-default.xml, mapred-site.xml, yarn-default.xml, yarn-site.xml, hdfs-default.xml, hdfs-site.xml], FileSystem: [DFS[DFSClient[clientName=DFSClient_NONMAPREDUCE_-1261652683_11, ugi=root (auth:SIMPLE)]]]</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mi">16</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableConfig</span><span class="o">:</span> <span class="nc">Loading</span> <span class="n">dataset</span> <span class="n">properties</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span><span class="o">/.</span><span class="na">hoodie</span><span class="o">/</span><span class="n">hoodie</span><span class="o">.</span><span class="na">properties</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mi">16</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Finished</span> <span class="nc">Loading</span> <span class="nc">Table</span> <span class="n">of</span> <span class="n">type</span> <span class="no">MERGE_ON_READ</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="nc">Metadata</span> <span class="k">for</span> <span class="n">table</span> <span class="n">stock_ticks_mor</span> <span class="n">loaded</span>



<span class="nl">hoodie:</span><span class="n">stock_ticks_mor</span><span class="o">-&gt;</span><span class="n">compactions</span> <span class="n">show</span> <span class="n">all</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">06</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mi">12</span> <span class="no">INFO</span> <span class="n">timeline</span><span class="o">.</span><span class="na">HoodieActiveTimeline</span><span class="o">:</span> <span class="nc">Loaded</span> <span class="n">instants</span> <span class="o">[[</span><span class="mi">20180924041125</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924041125</span><span class="n">__deltacommit__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924042735</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924042735</span><span class="n">__deltacommit__COMPLETED</span><span class="o">],</span> <span class="o">[==&gt;</span><span class="mi">20180924063245</span><span class="n">__compaction__REQUESTED</span><span class="o">]]</span>
    <span class="n">___________________________________________________________________</span>
    <span class="o">|</span> <span class="nc">Compaction</span> <span class="nc">Instant</span> <span class="nc">Time</span><span class="o">|</span> <span class="nc">State</span>    <span class="o">|</span> <span class="nc">Total</span> <span class="nc">FileIds</span> <span class="n">to</span> <span class="n">be</span> <span class="nc">Compacted</span><span class="o">|</span>
    <span class="o">|==================================================================|</span>
    <span class="o">|</span> <span class="mi">20180924070031</span>         <span class="o">|</span> <span class="no">REQUESTED</span><span class="o">|</span> <span class="mi">1</span>                            <span class="o">|</span>




<span class="err">#</span> <span class="nc">Execute</span> <span class="n">the</span> <span class="n">compaction</span><span class="o">.</span> <span class="nc">The</span> <span class="n">compaction</span> <span class="n">instant</span> <span class="n">value</span> <span class="n">passed</span> <span class="n">below</span> <span class="n">must</span> <span class="n">be</span> <span class="n">the</span> <span class="n">one</span> <span class="n">displayed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">above</span> <span class="s">"compactions show all"</span> <span class="n">query</span>
<span class="nl">hoodie:</span><span class="n">stock_ticks_mor</span><span class="o">-&gt;</span><span class="n">compaction</span> <span class="n">run</span> <span class="o">--</span><span class="n">compactionInstant</span>  <span class="mi">20180924070031</span> <span class="o">--</span><span class="n">parallelism</span> <span class="mi">2</span> <span class="o">--</span><span class="n">sparkMemory</span> <span class="mi">1</span><span class="no">G</span>  <span class="o">--</span><span class="n">schemaFilePath</span> <span class="o">/</span><span class="kt">var</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">schema</span><span class="o">.</span><span class="na">avsc</span> <span class="o">--</span><span class="n">retry</span> <span class="mi">1</span>  
<span class="o">....</span>
<span class="nc">Compaction</span> <span class="n">successfully</span> <span class="n">completed</span> <span class="k">for</span> <span class="mi">20180924070031</span>


<span class="err">##</span> <span class="nc">Now</span> <span class="n">check</span> <span class="k">if</span> <span class="n">compaction</span> <span class="n">is</span> <span class="n">completed</span>

<span class="nl">hoodie:</span><span class="n">stock_ticks_mor</span><span class="o">-&gt;</span><span class="n">connect</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mo">00</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Loading</span> <span class="nc">HoodieTableMetaClient</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mo">00</span> <span class="no">INFO</span> <span class="n">util</span><span class="o">.</span><span class="na">FSUtils</span><span class="o">:</span> <span class="nc">Hadoop</span> <span class="nl">Configuration:</span> <span class="n">fs</span><span class="o">.</span><span class="na">defaultFS</span><span class="o">:</span> <span class="o">[</span><span class="nl">hdfs:</span><span class="c1">//namenode:8020], Config:[Configuration: core-default.xml, core-site.xml, mapred-default.xml, mapred-site.xml, yarn-default.xml, yarn-site.xml, hdfs-default.xml, hdfs-site.xml], FileSystem: [DFS[DFSClient[clientName=DFSClient_NONMAPREDUCE_-1261652683_11, ugi=root (auth:SIMPLE)]]]</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mo">00</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableConfig</span><span class="o">:</span> <span class="nc">Loading</span> <span class="n">dataset</span> <span class="n">properties</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span><span class="o">/.</span><span class="na">hoodie</span><span class="o">/</span><span class="n">hoodie</span><span class="o">.</span><span class="na">properties</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mo">00</span> <span class="no">INFO</span> <span class="n">table</span><span class="o">.</span><span class="na">HoodieTableMetaClient</span><span class="o">:</span> <span class="nc">Finished</span> <span class="nc">Loading</span> <span class="nc">Table</span> <span class="n">of</span> <span class="n">type</span> <span class="no">MERGE_ON_READ</span> <span class="n">from</span> <span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">hive</span><span class="o">/</span><span class="n">warehouse</span><span class="o">/</span><span class="n">stock_ticks_mor</span>
<span class="nc">Metadata</span> <span class="k">for</span> <span class="n">table</span> <span class="n">stock_ticks_mor</span> <span class="n">loaded</span>



<span class="nl">hoodie:</span><span class="n">stock_ticks</span><span class="o">-&gt;</span><span class="n">compactions</span> <span class="n">show</span> <span class="n">all</span>
<span class="mi">18</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">24</span> <span class="mo">07</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mi">15</span> <span class="no">INFO</span> <span class="n">timeline</span><span class="o">.</span><span class="na">HoodieActiveTimeline</span><span class="o">:</span> <span class="nc">Loaded</span> <span class="n">instants</span> <span class="o">[[</span><span class="mi">20180924064636</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924064636</span><span class="n">__deltacommit__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924065057</span><span class="n">__clean__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924065057</span><span class="n">__deltacommit__COMPLETED</span><span class="o">],</span> <span class="o">[</span><span class="mi">20180924070031</span><span class="n">__commit__COMPLETED</span><span class="o">]]</span>
    <span class="n">___________________________________________________________________</span>
    <span class="o">|</span> <span class="nc">Compaction</span> <span class="nc">Instant</span> <span class="nc">Time</span><span class="o">|</span> <span class="nc">State</span>    <span class="o">|</span> <span class="nc">Total</span> <span class="nc">FileIds</span> <span class="n">to</span> <span class="n">be</span> <span class="nc">Compacted</span><span class="o">|</span>
    <span class="o">|==================================================================|</span>
    <span class="o">|</span> <span class="mi">20180924070031</span>         <span class="o">|</span> <span class="no">COMPLETED</span><span class="o">|</span> <span class="mi">1</span>                            <span class="o">|</span>

</code></pre></div></div>

<h3 id="step-9-run-hive-queries-including-incremental-queries">Step 9: Run Hive Queries including incremental queries</h3>

<p>You will see that both ReadOptimized and Realtime Views will show the latest committed data.
Lets also run the incremental query for MOR table.
From looking at the below query output, it will be clear that the fist commit time for the MOR table is 20180924064636
and the second commit time is 20180924070031</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">2</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">beeline</span> <span class="o">-</span><span class="n">u</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000 --hiveconf hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat --hiveconf hive.stats.autogather=false</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.6</span> <span class="n">seconds</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924064636</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924070031</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="err">#</span> <span class="nc">Realtime</span> <span class="nc">View</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select symbol, max(ts) from stock_ticks_mor_rt group by symbol HAVING symbol = 'GOOG';</span>
<span class="nl">WARNING:</span> <span class="nc">Hive</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="no">MR</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">in</span> <span class="nc">Hive</span> <span class="mi">2</span> <span class="n">and</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">available</span> <span class="n">in</span> <span class="n">the</span> <span class="n">future</span> <span class="n">versions</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">different</span> <span class="n">execution</span> <span class="nf">engine</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">e</span><span class="o">.</span> <span class="n">spark</span><span class="o">,</span> <span class="n">tez</span><span class="o">)</span> <span class="n">or</span> <span class="n">using</span> <span class="nc">Hive</span> <span class="mi">1</span><span class="o">.</span><span class="na">X</span> <span class="n">releases</span><span class="o">.</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor_rt where  symbol = 'GOOG';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924064636</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924070031</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="err">#</span> <span class="nc">Incremental</span> <span class="nl">View:</span>

<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; set hoodie.stock_ticks_mor.consume.mode=INCREMENTAL;</span>
<span class="nc">No</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="o">(</span><span class="mf">0.008</span> <span class="n">seconds</span><span class="o">)</span>
<span class="err">#</span> <span class="nc">Max</span><span class="o">-</span><span class="nc">Commits</span> <span class="n">covers</span> <span class="n">both</span> <span class="n">second</span> <span class="n">batch</span> <span class="n">and</span> <span class="n">compaction</span> <span class="n">commit</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; set hoodie.stock_ticks_mor.consume.max.commits=3;</span>
<span class="nc">No</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="o">(</span><span class="mf">0.007</span> <span class="n">seconds</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; set hoodie.stock_ticks_mor.consume.start.timestamp=20180924064636;</span>
<span class="nc">No</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="o">(</span><span class="mf">0.013</span> <span class="n">seconds</span><span class="o">)</span>
<span class="err">#</span> <span class="nl">Query:</span>
<span class="mi">0</span><span class="o">:</span> <span class="nl">jdbc:hive2:</span><span class="c1">//hiveserver:10000&gt; select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG' and `_hoodie_commit_time` &gt; '20180924064636';</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924070031</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="n">exit</span>
<span class="n">exit</span>
</code></pre></div></div>

<h3 id="step-10-read-optimized-and-realtime-views-for-mor-with-spark-sql-after-compaction">Step 10: Read Optimized and Realtime Views for MOR with Spark-SQL after compaction</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">adhoc</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">bash</span><span class="o">-</span><span class="mf">4.4</span><span class="err">#</span> <span class="n">$SPARK_INSTALL</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">spark</span><span class="o">-</span><span class="n">shell</span> <span class="o">--</span><span class="n">jars</span> <span class="n">$HUDI_SPARK_BUNDLE</span> <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="kd">class</span><span class="err">-</span><span class="nc">path</span> <span class="n">$HADOOP_CONF_DIR</span> <span class="o">--</span><span class="n">conf</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">hive</span><span class="o">.</span><span class="na">convertMetastoreParquet</span><span class="o">=</span><span class="kc">false</span> <span class="o">--</span><span class="n">deploy</span><span class="o">-</span><span class="n">mode</span> <span class="n">client</span>  <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">memory</span> <span class="mi">1</span><span class="no">G</span> <span class="o">--</span><span class="n">master</span> <span class="n">local</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">--</span><span class="n">executor</span><span class="o">-</span><span class="n">memory</span> <span class="mi">3</span><span class="no">G</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">executors</span> <span class="mi">1</span>  <span class="o">--</span><span class="n">packages</span> <span class="n">com</span><span class="o">.</span><span class="na">databricks</span><span class="o">:</span><span class="n">spark</span><span class="o">-</span><span class="n">avro_2</span><span class="o">.</span><span class="mi">11</span><span class="o">:</span><span class="mf">4.0</span><span class="o">.</span><span class="mi">0</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_mor group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="nf">selected</span> <span class="o">(</span><span class="mf">1.6</span> <span class="n">seconds</span><span class="o">)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor where  symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924064636</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924070031</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>

<span class="err">#</span> <span class="nc">Realtime</span> <span class="nc">View</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select symbol, max(ts) from stock_ticks_mor_rt group by symbol HAVING symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>         <span class="n">_c1</span>          <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>
<span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span>
<span class="o">+---------+----------------------+--+</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select `_hoodie_commit_time`, symbol, ts, volume, open, close  from stock_ticks_mor_rt where  symbol = 'GOOG'"</span><span class="o">).</span><span class="na">show</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="n">_hoodie_commit_time</span>  <span class="o">|</span> <span class="n">symbol</span>  <span class="o">|</span>          <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span>  <span class="o">|</span>    <span class="n">open</span>    <span class="o">|</span>   <span class="n">close</span>   <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
<span class="o">|</span> <span class="mi">20180924064636</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">6330</span>    <span class="o">|</span> <span class="mf">1230.5</span>     <span class="o">|</span> <span class="mf">1230.02</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">20180924070031</span>       <span class="o">|</span> <span class="no">GOOG</span>    <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>  <span class="o">|</span> <span class="mi">9021</span>    <span class="o">|</span> <span class="mf">1227.1993</span>  <span class="o">|</span> <span class="mf">1227.215</span>  <span class="o">|</span>
<span class="o">+----------------------+---------+----------------------+---------+------------+-----------+--+</span>
</code></pre></div></div>

<h3 id="step-11--presto-queries-over-read-optimized-view-on-mor-dataset-after-compaction">Step 11:  Presto queries over Read Optimized View on MOR dataset after compaction</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">presto</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="mi">1</span> <span class="n">presto</span> <span class="o">--</span><span class="n">server</span> <span class="n">presto</span><span class="o">-</span><span class="n">coordinator</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">8090</span>
<span class="n">presto</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">hive</span><span class="o">.</span><span class="na">default</span><span class="o">;</span>
<span class="no">USE</span>

<span class="err">#</span> <span class="nc">Read</span> <span class="nc">Optimized</span> <span class="nc">View</span>
<span class="nl">resto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">group</span> <span class="n">by</span> <span class="n">symbol</span> <span class="no">HAVING</span> <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
  <span class="n">symbol</span> <span class="o">|</span>        <span class="n">_col1</span>
<span class="o">--------+---------------------</span>
 <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span>
<span class="o">(</span><span class="mi">1</span> <span class="n">row</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_182319_00011</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">49</span> <span class="n">total</span><span class="o">,</span> <span class="mi">49</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">01</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">133</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">414</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span> <span class="n">select</span> <span class="s">"_hoodie_commit_time"</span><span class="o">,</span> <span class="n">symbol</span><span class="o">,</span> <span class="n">ts</span><span class="o">,</span> <span class="n">volume</span><span class="o">,</span> <span class="n">open</span><span class="o">,</span> <span class="n">close</span>  <span class="n">from</span> <span class="n">stock_ticks_mor</span> <span class="n">where</span>  <span class="n">symbol</span> <span class="o">=</span> <span class="err">'</span><span class="no">GOOG</span><span class="err">'</span><span class="o">;</span>
 <span class="n">_hoodie_commit_time</span> <span class="o">|</span> <span class="n">symbol</span> <span class="o">|</span>         <span class="n">ts</span>          <span class="o">|</span> <span class="n">volume</span> <span class="o">|</span>   <span class="n">open</span>    <span class="o">|</span>  <span class="n">close</span>
<span class="o">---------------------+--------+---------------------+--------+-----------+----------</span>
 <span class="mi">20190822180250</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">09</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">6330</span> <span class="o">|</span>    <span class="mf">1230.5</span> <span class="o">|</span>  <span class="mf">1230.02</span>
 <span class="mi">20190822181944</span>      <span class="o">|</span> <span class="no">GOOG</span>   <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mo">00</span> <span class="o">|</span>   <span class="mi">9021</span> <span class="o">|</span> <span class="mf">1227.1993</span> <span class="o">|</span> <span class="mf">1227.215</span>
<span class="o">(</span><span class="mi">2</span> <span class="n">rows</span><span class="o">)</span>

<span class="nc">Query</span> <span class="mi">20190822_182333_00012</span><span class="n">_segyw</span><span class="o">,</span> <span class="no">FINISHED</span><span class="o">,</span> <span class="mi">1</span> <span class="n">node</span>
<span class="nl">Splits:</span> <span class="mi">17</span> <span class="n">total</span><span class="o">,</span> <span class="mi">17</span> <span class="n">done</span> <span class="o">(</span><span class="mf">100.00</span><span class="o">%)</span>
<span class="mi">0</span><span class="o">:</span><span class="mo">02</span> <span class="o">[</span><span class="mi">197</span> <span class="n">rows</span><span class="o">,</span> <span class="mi">613</span><span class="no">B</span><span class="o">]</span> <span class="o">[</span><span class="mi">98</span> <span class="n">rows</span><span class="o">/</span><span class="n">s</span><span class="o">,</span> <span class="mi">307</span><span class="no">B</span><span class="o">/</span><span class="n">s</span><span class="o">]</span>

<span class="nl">presto:</span><span class="k">default</span><span class="o">&gt;</span>

</code></pre></div></div>

<p>This brings the demo to an end.</p>

<h2 id="testing-hudi-in-local-docker-environment">Testing Hudi in Local Docker environment</h2>

<p>You can bring up a hadoop docker environment containing Hadoop, Hive and Spark services with support for hudi.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">mvn</span> <span class="n">pre</span><span class="o">-</span><span class="n">integration</span><span class="o">-</span><span class="n">test</span> <span class="o">-</span><span class="nc">DskipTests</span>
</code></pre></div></div>
<p>The above command builds docker images for all the services with
current Hudi source installed at /var/hoodie/ws and also brings up the services using a compose file. We
currently use Hadoop (v2.8.4), Hive (v2.3.3) and Spark (v2.3.1) in docker images.</p>

<p>To bring down the containers</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">cd</span> <span class="n">hudi</span><span class="o">-</span><span class="n">integ</span><span class="o">-</span><span class="n">test</span>
<span class="err">$</span> <span class="n">mvn</span> <span class="n">docker</span><span class="o">-</span><span class="nl">compose:</span><span class="n">down</span>
</code></pre></div></div>

<p>If you want to bring up the docker containers, use</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">cd</span> <span class="n">hudi</span><span class="o">-</span><span class="n">integ</span><span class="o">-</span><span class="n">test</span>
<span class="err">$</span>  <span class="n">mvn</span> <span class="n">docker</span><span class="o">-</span><span class="nl">compose:</span><span class="n">up</span> <span class="o">-</span><span class="nc">DdetachedMode</span><span class="o">=</span><span class="kc">true</span>
</code></pre></div></div>

<p>Hudi is a library that is operated in a broader data analytics/ingestion environment
involving Hadoop, Hive and Spark. Interoperability with all these systems is a key objective for us. We are
actively adding integration-tests under <strong>hudi-integ-test/src/test/java</strong> that makes use of this
docker environment (See <strong>hudi-integ-test/src/test/java/org/apache/hudi/integ/ITTestHoodieSanity.java</strong> )</p>

<h3 id="building-local-docker-containers">Building Local Docker Containers:</h3>

<p>The docker images required for demo and running integration test are already in docker-hub. The docker images
and compose scripts are carefully implemented so that they serve dual-purpose</p>

<ol>
  <li>The docker images have inbuilt hudi jar files with environment variable pointing to those jars (HUDI_HADOOP_BUNDLE, …)</li>
  <li>For running integration-tests, we need the jars generated locally to be used for running services within docker. The
docker-compose scripts (see <code class="highlighter-rouge">docker/compose/docker-compose_hadoop284_hive233_spark231.yml</code>) ensures local jars override
inbuilt jars by mounting local HUDI workspace over the docker location</li>
</ol>

<p>This helps avoid maintaining separate docker images and avoids the costly step of building HUDI docker images locally.
But if users want to test hudi from locations with lower network bandwidth, they can still build local images
run the script
<code class="highlighter-rouge">docker/build_local_docker_images.sh</code> to build local docker images before running <code class="highlighter-rouge">docker/setup_demo.sh</code></p>

<p>Here are the commands:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span> <span class="n">docker</span>
<span class="o">./</span><span class="n">build_local_docker_images</span><span class="o">.</span><span class="na">sh</span>
<span class="o">.....</span>

<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="nc">Reactor</span> <span class="nl">Summary:</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hoodie</span> <span class="o">.............................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">1.709</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">common</span> <span class="o">......................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">9.015</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">mr</span> <span class="o">...................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">1.108</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">client</span> <span class="o">......................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">4.409</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hive</span> <span class="o">........................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">0.976</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">spark</span> <span class="o">.......................................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">26.522</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">utilities</span> <span class="o">...................................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">16.256</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">cli</span> <span class="o">.........................................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">11.341</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">mr</span><span class="o">-</span><span class="n">bundle</span> <span class="o">............................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">1.893</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hive</span><span class="o">-</span><span class="n">bundle</span> <span class="o">.................................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">14.099</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">spark</span><span class="o">-</span><span class="n">bundle</span> <span class="o">................................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">58.252</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">docker</span> <span class="o">...............................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">0.612</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">docker</span> <span class="o">..........................</span> <span class="no">SUCCESS</span> <span class="o">[</span><span class="mo">04</span><span class="o">:</span><span class="mo">04</span> <span class="n">min</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">namenode</span><span class="o">-</span><span class="n">docker</span> <span class="o">......................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">6.142</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">datanode</span><span class="o">-</span><span class="n">docker</span> <span class="o">......................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">7.763</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">history</span><span class="o">-</span><span class="n">docker</span> <span class="o">.......................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">5.922</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">hive</span><span class="o">-</span><span class="n">docker</span> <span class="o">..........................</span> <span class="no">SUCCESS</span> <span class="o">[</span> <span class="mf">56.152</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">sparkbase</span><span class="o">-</span><span class="n">docker</span> <span class="o">.....................</span> <span class="no">SUCCESS</span> <span class="o">[</span><span class="mo">01</span><span class="o">:</span><span class="mi">18</span> <span class="n">min</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">sparkmaster</span><span class="o">-</span><span class="n">docker</span> <span class="o">...................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">2.964</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">sparkworker</span><span class="o">-</span><span class="n">docker</span> <span class="o">...................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">3.032</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">hadoop</span><span class="o">-</span><span class="n">sparkadhoc</span><span class="o">-</span><span class="n">docker</span> <span class="o">....................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">2.764</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">hudi</span><span class="o">-</span><span class="n">integ</span><span class="o">-</span><span class="n">test</span> <span class="o">..................................</span> <span class="no">SUCCESS</span> <span class="o">[</span>  <span class="mf">1.785</span> <span class="n">s</span><span class="o">]</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="o">------------------------------------------------------------------------</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="no">BUILD</span> <span class="no">SUCCESS</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="o">------------------------------------------------------------------------</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="nc">Total</span> <span class="nl">time:</span> <span class="mi">09</span><span class="o">:</span><span class="mi">15</span> <span class="n">min</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="nc">Finished</span> <span class="nl">at:</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">10</span><span class="nl">T17:</span><span class="mi">47</span><span class="o">:</span><span class="mi">37</span><span class="o">-</span><span class="mo">07</span><span class="o">:</span><span class="mo">00</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="nc">Final</span> <span class="nl">Memory:</span> <span class="mi">236</span><span class="no">M</span><span class="o">/</span><span class="mi">1848</span><span class="no">M</span>
<span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="o">------------------------------------------------------------------------</span>
</code></pre></div></div>

      </section>

      <a href="#masthead__inner-wrap" class="back-to-top">Back to top &uarr;</a>


      

    </div>

  </article>

</div>

    </div>

    <div class="page__footer">
      <footer>
        
<div class="row">
  <div class="col-lg-12 footer">
    <p>
      <table class="table-apache-info">
        <tr>
          <td>
            <a class="footer-link-img" href="https://apache.org">
              <img width="250px" src="/assets/images/asf_logo.svg" alt="The Apache Software Foundation">
            </a>
          </td>
          <td>
            <a style="float: right" href="https://www.apache.org/events/current-event.html">
              <img src="https://www.apache.org/events/current-event-234x60.png" />
            </a>
          </td>
        </tr>
      </table>
    </p>
    <p>
      <a href="https://www.apache.org/licenses/">License</a> | <a href="https://www.apache.org/security/">Security</a> | <a href="https://www.apache.org/foundation/thanks.html">Thanks</a> | <a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
    </p>
    <p>
      Copyright &copy; <span id="copyright-year">2019</span> <a href="https://apache.org">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0"> Apache License, Version 2.0</a>.
      Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation. <a href="/docs/privacy">Privacy Policy</a>
    </p>
  </div>
</div>
      </footer>
    </div>

    
<script src="/assets/js/main.min.js"></script>


  </body>
</html>