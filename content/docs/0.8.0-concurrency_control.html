<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Concurrent Writes to Hudi Tables - Apache Hudi</title>
<meta name="description" content="In this section, we will cover Hudi’s concurrency model and describe ways to ingest data into a Hudi Table from multiple writers; using the DeltaStreamer tool as well as using the Hudi datasource.">

<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="Concurrent Writes to Hudi Tables">
<meta property="og:url" content="https://hudi.apache.org/docs/0.8.0-concurrency_control.html">


  <meta property="og:description" content="In this section, we will cover Hudi’s concurrency model and describe ways to ingest data into a Hudi Table from multiple writers; using the DeltaStreamer tool as well as using the Hudi datasource.">





  <meta property="article:modified_time" content="2021-03-19T15:59:57-04:00">







<!-- end _includes/seo.html -->


<!--<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">-->

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



<link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
<link rel="stylesheet" href="/assets/css/font-awesome.min.css">
<script src="/assets/js/jquery.min.js"></script>

    
<script src="/assets/js/main.min.js"></script>

  </head>

  <body class="layout--single">
    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap" id="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/">
              <div style="width: 150px; height: 40px">
              </div>
          </a>
        
        <a class="site-title" href="/">
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/docs/spark_quick-start-guide.html" target="_self" >Documentation</a>
            </li><li class="masthead__menu-item">
              <a href="/community.html" target="_self" >Community</a>
            </li><li class="masthead__menu-item">
              <a href="/blog.html" target="_self" >Blog</a>
            </li><li class="masthead__menu-item">
              <a href="https://cwiki.apache.org/confluence/display/HUDI/FAQ" target="_blank" >FAQ</a>
            </li><li class="masthead__menu-item">
              <a href="/docs/powered_by.html" target="_self" >Powered By</a>
            </li><li class="masthead__menu-item">
              <a href="/releases.html" target="_self" >Releases</a>
            </li></ul>
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
<!--
<p class="notice--warning" style="margin: 0 !important; text-align: center !important;"><strong>Note:</strong> This site is work in progress, if you notice any issues, please <a target="_blank" href="https://github.com/apache/hudi/issues">Report on Issue</a>.
  Click <a href="/"> here</a> back to old site.</p>
-->

    <div class="initial-content">
      <div id="main" role="main">
  

  <div class="sidebar sticky">

  

  

    
      







<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Documentation</span>
        

        
        <ul>
          
            
            

            
            

            
              <li><a href="/docs/0.8.0-overview.html" class="">Overview</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-quick-start-guide.html" class="">Quick Start</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-use_cases.html" class="">Use Cases</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-writing_data.html" class="">Writing Data</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-querying_data.html" class="">Querying Data</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-configurations.html" class="">Configuration</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-performance.html" class="">Performance</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-deployment.html" class="">Deployment</a></li>
            

          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Resources</span>
        

        
        <ul>
          
            
            

            
            

            
              <li><a href="/docs/0.8.0-docker_demo.html" class="">Dockerized Demo</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-cloud.html" class="">Storage Configuration</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-metrics.html" class="">Metrics</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-docs-versions.html" class="">Docs Versions</a></li>
            

          
            
            

            
            

            
              <li><a href="/docs/0.8.0-privacy.html" class="">Privacy Policy</a></li>
            

          
        </ul>
        
      </li>
    
  </ul>
</nav>

    

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <!-- Look the author details up from the site config. -->
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Concurrent Writes to Hudi Tables
</h1>
          <!-- Output author details if some exist. -->
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <aside class="sidebar__right sticky">
          <nav class="toc">
            <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> IN THIS PAGE</h4></header>
            <ul class="toc__menu">
  <li><a href="#supported-concurrency-controls">Supported Concurrency Controls</a></li>
  <li><a href="#single-writer-guarantees">Single Writer Guarantees</a></li>
  <li><a href="#multi-writer-guarantees">Multi Writer Guarantees</a></li>
  <li><a href="#enabling-multi-writing">Enabling Multi Writing</a></li>
  <li><a href="#datasource-writer">Datasource Writer</a></li>
  <li><a href="#deltastreamer">DeltaStreamer</a></li>
  <li><a href="#best-practices-when-using-optimistic-concurrency-control">Best Practices when using Optimistic Concurrency Control</a></li>
  <li><a href="#disabling-multi-writing">Disabling Multi Writing</a></li>
</ul>
          </nav>
        </aside>
        
        <p>In this section, we will cover Hudi’s concurrency model and describe ways to ingest data into a Hudi Table from multiple writers; using the <a href="#deltastreamer">DeltaStreamer</a> tool as well as 
using the <a href="#datasource-writer">Hudi datasource</a>.</p>

<h2 id="supported-concurrency-controls">Supported Concurrency Controls</h2>

<ul>
  <li>
    <p><strong>MVCC</strong> : Hudi table services such as compaction, cleaning, clustering leverage Multi Version Concurrency Control to provide snapshot isolation
between multiple table service writers and readers. Additionally, using MVCC, Hudi provides snapshot isolation between an ingestion writer and multiple concurrent readers. 
With this model, Hudi supports running any number of table service jobs concurrently, without any concurrency conflict. 
This is made possible by ensuring that scheduling plans of such table services always happens in a single writer mode to ensure no conflict and avoids race conditions.</p>
  </li>
  <li>
    <p><strong>[NEW] OPTIMISTIC CONCURRENCY</strong> : Write operations such as the ones described above (UPSERT, INSERT) etc, leverage optimistic concurrency control to enable multiple ingestion writers to
the same Hudi Table. Hudi supports <code class="highlighter-rouge">file level OCC</code>, i.e., for any 2 commits (or writers) happening to the same table, if they do not have writes to overlapping files being changed, both writers are allowed to succeed. 
This feature is currently <em>experimental</em> and requires either Zookeeper or HiveMetastore to acquire locks.</p>
  </li>
</ul>

<p>It may be helpful to understand the different guarantees provided by <a href="/docs/0.8.0-writing_data.html#write-operations">write operations</a> via Hudi datasource or the delta streamer.</p>

<h2 id="single-writer-guarantees">Single Writer Guarantees</h2>

<ul>
  <li><em>UPSERT Guarantee</em>: The target table will NEVER show duplicates.</li>
  <li><em>INSERT Guarantee</em>: The target table wilL NEVER have duplicates if <a href="/docs/0.8.0-configurations.html#INSERT_DROP_DUPS_OPT_KEY">dedup</a> is enabled.</li>
  <li><em>BULK_INSERT Guarantee</em>: The target table will NEVER have duplicates if <a href="/docs/0.8.0-configurations.html#INSERT_DROP_DUPS_OPT_KEY">dedup</a> is enabled.</li>
  <li><em>INCREMENTAL PULL Guarantee</em>: Data consumption and checkpoints are NEVER out of order.</li>
</ul>

<h2 id="multi-writer-guarantees">Multi Writer Guarantees</h2>

<p>With multiple writers using OCC, some of the above guarantees change as follows</p>

<ul>
  <li><em>UPSERT Guarantee</em>: The target table will NEVER show duplicates.</li>
  <li><em>INSERT Guarantee</em>: The target table MIGHT have duplicates even if <a href="/docs/0.8.0-configurations.html#INSERT_DROP_DUPS_OPT_KEY">dedup</a> is enabled.</li>
  <li><em>BULK_INSERT Guarantee</em>: The target table MIGHT have duplicates even if <a href="/docs/0.8.0-configurations.html#INSERT_DROP_DUPS_OPT_KEY">dedup</a> is enabled.</li>
  <li><em>INCREMENTAL PULL Guarantee</em>: Data consumption and checkpoints MIGHT be out of order due to multiple writer jobs finishing at different times.</li>
</ul>

<h2 id="enabling-multi-writing">Enabling Multi Writing</h2>

<p>The following properties are needed to be set properly to turn on optimistic concurrency control.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.concurrency.mode=optimistic_concurrency_control
hoodie.cleaner.policy.failed.writes=LAZY
hoodie.write.lock.provider=&lt;lock-provider-classname&gt;
</code></pre></div></div>

<p>There are 2 different server based lock providers that require different configuration to be set.</p>

<p><strong><code class="highlighter-rouge">Zookeeper</code></strong> based lock provider</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.lock.provider=org.apache.hudi.client.transaction.lock.ZookeeperBasedLockProvider
hoodie.write.lock.zookeeper.url
hoodie.write.lock.zookeeper.port
hoodie.write.lock.wait_time_ms
hoodie.write.lock.num_retries
hoodie.write.lock.zookeeper.lock_key
hoodie.write.lock.zookeeper.base_path
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">HiveMetastore</code></strong> based lock provider</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.lock.provider=org.apache.hudi.hive.HiveMetastoreBasedLockProvider
hoodie.write.lock.hivemetastore.database
hoodie.write.lock.hivemetastore.table
hoodie.write.lock.wait_time_ms
hoodie.write.lock.num_retries
</code></pre></div></div>

<p><code class="highlighter-rouge">The HiveMetastore URI's are picked up from the hadoop configuration file loaded during runtime.</code></p>

<h2 id="datasource-writer">Datasource Writer</h2>

<p>The <code class="highlighter-rouge">hudi-spark</code> module offers the DataSource API to write (and read) a Spark DataFrame into a Hudi table.</p>

<p>Following is an example of how to use optimistic_concurrency_control via spark datasource</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inputDF</span><span class="o">.</span><span class="na">write</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"hudi"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">options</span><span class="o">(</span><span class="n">getQuickstartWriteConfigs</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">PRECOMBINE_FIELD_OPT_KEY</span><span class="o">,</span> <span class="s">"ts"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.cleaner.policy.failed.writes"</span><span class="o">,</span> <span class="s">"LAZY"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.concurrency.mode"</span><span class="o">,</span> <span class="s">"optimistic_concurrency_control"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.zookeeper.url"</span><span class="o">,</span> <span class="s">"zookeeper"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.zookeeper.port"</span><span class="o">,</span> <span class="s">"2181"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.wait_time_ms"</span><span class="o">,</span> <span class="s">"12000"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.num_retries"</span><span class="o">,</span> <span class="s">"2"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.zookeeper.lock_key"</span><span class="o">,</span> <span class="s">"test_table"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="s">"hoodie.write.lock.zookeeper.base_path"</span><span class="o">,</span> <span class="s">"/test"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">RECORDKEY_FIELD_OPT_KEY</span><span class="o">,</span> <span class="s">"uuid"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">PARTITIONPATH_FIELD_OPT_KEY</span><span class="o">,</span> <span class="s">"partitionpath"</span><span class="o">)</span>
       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="no">TABLE_NAME</span><span class="o">,</span> <span class="n">tableName</span><span class="o">)</span>
       <span class="o">.</span><span class="na">mode</span><span class="o">(</span><span class="nc">Overwrite</span><span class="o">)</span>
       <span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">basePath</span><span class="o">)</span>
</code></pre></div></div>

<h2 id="deltastreamer">DeltaStreamer</h2>

<p>The <code class="highlighter-rouge">HoodieDeltaStreamer</code> utility (part of hudi-utilities-bundle) provides ways to ingest from different sources such as DFS or Kafka, with the following capabilities.</p>

<p>Using optimistic_concurrency_control via delta streamer requires adding the above configs to the properties file that can be passed to the
job. For example below, adding the configs to kafka-source.properties file and passing them to deltastreamer will enable optimistic concurrency.
A deltastreamer job can then be triggered as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="n">hoodie</span><span class="o">]</span><span class="err">$</span> <span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">deltastreamer</span><span class="o">.</span><span class="na">HoodieDeltaStreamer</span> <span class="err">`</span><span class="n">ls</span> <span class="n">packaging</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">utilities</span><span class="o">-</span><span class="n">bundle</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">utilities</span><span class="o">-</span><span class="n">bundle</span><span class="o">-*.</span><span class="na">jar</span><span class="err">`</span> <span class="err">\</span>
  <span class="o">--</span><span class="n">props</span> <span class="nl">file:</span><span class="c1">//${PWD}/hudi-utilities/src/test/resources/delta-streamer-config/kafka-source.properties \</span>
  <span class="o">--</span><span class="n">schemaprovider</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">schema</span><span class="o">.</span><span class="na">SchemaRegistryProvider</span> <span class="err">\</span>
  <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hudi</span><span class="o">.</span><span class="na">utilities</span><span class="o">.</span><span class="na">sources</span><span class="o">.</span><span class="na">AvroKafkaSource</span> <span class="err">\</span>
  <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">ordering</span><span class="o">-</span><span class="n">field</span> <span class="n">impresssiontime</span> <span class="err">\</span>
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">path</span> <span class="nl">file:</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hudi</span><span class="o">-</span><span class="n">deltastreamer</span><span class="o">-</span><span class="n">op</span> <span class="err">\</span> 
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">table</span> <span class="n">uber</span><span class="o">.</span><span class="na">impressions</span> <span class="err">\</span>
  <span class="o">--</span><span class="n">op</span> <span class="no">BULK_INSERT</span>
</code></pre></div></div>

<h2 id="best-practices-when-using-optimistic-concurrency-control">Best Practices when using Optimistic Concurrency Control</h2>

<p>Concurrent Writing to Hudi tables requires acquiring a lock with either Zookeeper or HiveMetastore. Due to several reasons you might want to configure retries to allow your application to acquire the lock.</p>
<ol>
  <li>Network connectivity or excessive load on servers increasing time for lock acquisition resulting in timeouts</li>
  <li>Running a large number of concurrent jobs that are writing to the same hudi table can result in contention during lock acquisition can cause timeouts</li>
  <li>In some scenarios of conflict resolution, Hudi commit operations might take upto 10’s of seconds while the lock is being held. This can result in timeouts for other jobs waiting to acquire a lock.</li>
</ol>

<p>Set the correct native lock provider client retries. NOTE that sometimes these settings are set on the server once and all clients inherit the same configs. Please check your settings before enabling optimistic concurrency.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.lock.wait_time_ms
hoodie.write.lock.num_retries
</code></pre></div></div>

<p>Set the correct hudi client retries for Zookeeper &amp; HiveMetastore. This is useful in cases when native client retry settings cannot be changed. Please note that these retries will happen in addition to any native client retries that you may have set.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.lock.client.wait_time_ms
hoodie.write.lock.client.num_retries
</code></pre></div></div>

<p><em>Setting the right values for these depends on a case by case basis; some defaults have been provided for general cases.</em></p>

<h2 id="disabling-multi-writing">Disabling Multi Writing</h2>

<p>Remove the following settings that were used to enable multi-writer or override with default values.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hoodie.write.concurrency.mode=single_writer
hoodie.cleaner.policy.failed.writes=EAGER
</code></pre></div></div>

      </section>

      <a href="#masthead__inner-wrap" class="back-to-top">Back to top &uarr;</a>


      

    </div>

  </article>

</div>

    </div>

    <div class="page__footer">
      <footer>
        
<div class="row">
  <div class="col-lg-12 footer">
    <p>
      <table class="table-apache-info">
        <tr>
          <td>
            <a class="footer-link-img" href="https://apache.org">
              <img width="250px" src="/assets/images/asf_logo.svg" alt="The Apache Software Foundation">
            </a>
          </td>
          <td>
            <a style="float: right" href="https://www.apache.org/events/current-event.html">
              <img src="https://www.apache.org/events/current-event-234x60.png" />
            </a>
          </td>
        </tr>
      </table>
    </p>
    <p>
      <a href="https://www.apache.org/licenses/">License</a> | <a href="https://www.apache.org/security/">Security</a> | <a href="https://www.apache.org/foundation/thanks.html">Thanks</a> | <a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
    </p>
    <p>
      Copyright &copy; <span id="copyright-year">2019</span> <a href="https://apache.org">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0"> Apache License, Version 2.0</a>.
      Hudi, Apache and the Apache feather logo are trademarks of The Apache Software Foundation. <a href="/docs/privacy">Privacy Policy</a>
    </p>
  </div>
</div>
      </footer>
    </div>


  </body>
</html>