<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
# Add support for cancellable table service plans

## Proposers


## Approvers

## Status

JIRA: HUDI-7946


## Abstract
Table service plans can delay ingestion writes from updating a dataset with recent data, if potential write conflicts are detected. Furthermore, a table service plan that isn't executed to completion for a large amount of time (due to repeated failures, application misconfiguration, or insufficient resources) will degrade the performance of a dataset due to delaying clean, archival, and compaction. This is because currently HUDI table service plans, upon being scheduled, must be executed to completion. And in addition, will prevent any ingestion write targeting the same files from succeeding (due to posing as a write conflict) and will prevent any new table service plan from targeting the same files. Enabling a user to configure a table service plan as "cancellable" can prevent frequent table service plans from delaying ingestion and can provide users an avenue to fully cancel a table service plan and allow other table service to proceed.


## Background
### Execution of table services 
The table service operations compact and cluster are by default "immutable" plans, meaning that once a plan is scheduled it will stay as as a pending instant until a caller invokes the table service execute API on the table service instant and sucessfully completes it. Specifically, if an inflight execution fails after transitioning the instant to inflight, the next execution attempt will implictly create and execute a rollback plan (which will delete all new instant/data files), but will keep the table service plan. This process will repeat until the instant is completed. The below visualization captures these transitions at a high level 

![table service lifecycle (1)](https://github.com/user-attachments/assets/4a656bde-4046-4d37-9398-db96144207aa)

## Goals
### (1) A cancellable plan should be pre-empted by other writers
The current requirement of HUDI needing to execute a table service plan to completion forces ingestion writers to abort a commit if a table service plan is conflicting. Becuase an ingestion writer typically determines the exact files it will be targeting after building a workload profile and performing record tagging, the writer may have already spent a lot of time and resources before realizing that it needs to abort. In the face of frequent table service plans or an old inflight plan, this will cause delays in adding recent upstream records to the dataset as well as unecessairly take away resources (such as Spark executors in the case of Spark engine) from other applications in the data lake. A cancellable table service plan should avoid this situation by preventing itself from being comitted if a conflicting ingestion job has been comitted already. In conjunction, any ingestion writer or non-cancellable table service writer should be able to infer that a conflicting inflight table service plan is cancellable, and therefore can be ignored when attempting to commit the instant.

### (2) An inflight cancellable plan should be automatically cleaned up
Another consequence of this existing table service flow is that a table service plan cannot be subject to clean's rollback of failed writes. Clean typically performs a rollback of inflight instants that are no longer being progressed by a writer (and have an inactive heartbeat). Because table service plans needed to be executed to completion and don't have an active heartbeat these inflight plans cannot be subject to this cleanup. Because an inflight plan remaining on the timeline can degrade performance of reads/writes (as mentioned earlier), a cancellable table service plan should be elligible to be targeted for cleanup if an application deems that it has remaining inflight for too long (or some other critera)

## Design
### Enabling a plan to be pre-emptable
To satisfy goal (1), a pair of config flags "cancellable" can be added to a table service plan. A writer that intends to schedule a cancellable table service plan can enable the flag in the serialized plan metadata. Any writer executing the plan can infer that the plan is cancellable, and when trying to commit the instant will abort if it detects that any ingestion write or table service plan (without cancellable config flag) is targeting the same file groups. On the other side, the pre-commit flow for ingestion writers can be updated to ignore any inflight table service plans if they are cancellable.

### Handling cancellation of plans


